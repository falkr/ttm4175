<html lang="en-US"><head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1"/>

<title>TTM4175</title>
<meta property="og:title" content="TTM4175">
<meta property="og:locale" content="en_US">
<meta name="description" content="Introduction to Communication Technology and Digital Security">
<meta property="og:description" content="Introduction to Communication Technology and Digital Security">


<link rel="stylesheet" href="assets/bootstrap.min.css">
<script src="assets/jquery-3.5.1.min.js"></script>
<script src="assets/bootstrap.min.js"></script>
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.1/css/all.css" integrity="sha384-gfdkjb5BdAXd+lj+gudLWI+BXq4IuLW5IT+brZEZsLFm++aCMlF1V92rMkPaX4PP" crossorigin="anonymous">
<link rel="stylesheet" type="text/css" href="assets/style.css" />
<link rel="stylesheet" type="text/css" href="assets/bootstrap-icons.css">
<style type="text/css">a.ntnu-button {
    font: 600 14px "Source Sans Pro", Georgia, serif;
    background: #fff;
    color: #00509e;
    border: 1px solid #00509e;
    border-color: #00509e !important;
    border-style: solid !important;
    border-radius: 10rem;
    display: inline-block;
    padding: 5px 15px;
    height: auto;
    font-weight: bold;
    line-height: 1.5em;
    text-align: center;
    vertical-align: top;
    cursor: pointer;
    text-decoration: none
}

a.ntnu-button:hover {
    background: #00509e;
    color: #fff;
    text-decoration: none
}
div.check ul,
div.check ul li {
  padding: 0;
  margin: 0;
  list-style: none;
}

div.check ul {
  margin: 2em 0;
}

div.check ul li {
  margin: 1em;
  margin-left: 3em;
}

div.check ul li:before {
  content: '\f26a';
  font-family: bootstrap-icons !important;
  font-size:20;
  float: left;
  margin-left: -1.5em;
  color: #1481b8;
}
div.figure {
  padding: 20px 0 20px 0;
  width: 100%;
}

div.figurefullwitdth {
  padding: 20px 0 20px 0;
  margin-left: -33px;
  margin-right: -33px;
  width: 100%;
}
div.goals ul,
div.goals ul li {
  padding: 0;
  margin: 0;
  list-style: none;
}

div.goals ul {
  margin: 2em 0;
}

div.goals ul li {
  margin: 1em;
  margin-left: 3em;
}

div.goals ul li:before {
  content: '\f26a';
  font-family: bootstrap-icons !important;
  font-size:20;
  float: left;
  margin-left: -1.5em;
  color: #1481b8;
}
.w3collapsible {
  background-color:#f0e9db;
  color: #868279; 
  padding: 8px 18px 8px 8px;
  cursor: pointer;
  width: 100%;
  border: none;
  border-radius: 3px 3px 0 0;
  text-align: left;
  outline: none;
  font-size: 15px;
}

.w3active, .w3collapsible:hover {
  background-color: #f0e9cb;
}

.w3content {
  filter: blur(3px);
  padding: 0 18px;
  display: block;
  overflow: hidden;
  background-color: #f3f3f3;
  margin-bottom: 15px;
}
div.report p {
padding: 10px;
background-color: #D6E5F0;
border-radius: 5px;
border-left: 6px solid #1481b8 
}

div.report p::before {
    content: 'For the Report: ';
    font-weight: bold; 
    color: #1481b8;
display: inline;
}
.steps ol, .steps ul {
  counter-reset: li;
  list-style: none;
  margin-left: 10px
}

.steps li {
  margin: 0 0 10px 0;
  min-height: 40px
}

.steps li:before {
  content: counter(li);
  counter-increment: li;
  border: 2px solid #868279;
  color: #868279;
  background-color: none;
  font-family: "Source Sans Pro", Georgia, serif;
  font-weight: bold;
  border-radius: 100%;
  text-align: center;
  display: inline-block;
  top:8px;
  left:-30px;
  width: 30px;
  height: 30px;
  position: relative;
  margin: -20px -10px -20px -20px
}

div.task p {
padding: 10px;
background-color: #D6E5F0;
border-radius: 5px;
border-left: 6px solid #1481b8 
}

div.task p::before { 
content: "Task: ";
font-weight: bold;
display: inline;
}
div.tip p {
  padding: 10px;
  background-color: #d9eaf2;
  border-radius: 5px;
  border-left: 6px solid #1481b8
}

table.weekplan {
  width: 100%;
  table-layout: fixed;
}

table.weekplan td {
  background-color: #1481b8;
  color: white;
}

table.weekplan td, table.weekplan th {
  text-align: center;
}

table.weekplan td:empty {
  background-color: white;
}

table.weekplan td:first-child {
  background-color: white;
  color: grey;
}

table.weekplan a {
  font-weight:bold;
  color: white;
  text-decoration: underline;
}
</style>
<script src="assets/anchor.js"></script>
<script src="assets/script-aside.js"></script>
</head>
<body id="top">

<nav class="navbar navbar-expand-md navbar-dark " style="background-color:#666666"#2B65EC"> <!-- fixed-top -->
        <ul class="nav nav-pills">
        <li class="nav-item">
    <a class="nav-link" href="index.html" style="font-weight: bold")>TTM4175</a>
  </li>

  <li class="nav-item dropdown">
    <a class="nav-link dropdown-toggle" data-toggle="dropdown" href="#" role="button" aria-haspopup="true" aria-expanded="false">Teknostart</a>
    <div class="dropdown-menu">
      <a class="dropdown-item" href="day0-2021.html">Oppstart</a>
      <a class="dropdown-item" href="material/TTM4175-2021-L01-Introduction_to_ethical_hacking.pdf">Introduction to Ethical Hacking (PDF)</a>
      <a class="dropdown-item" href="material/TTM4175-2021-L01-Introduction_to_Kali_linux.pdf">Introduction to Kali Linux (PDF)</a>
      <a class="dropdown-item" href="day2-2021.html">Dag 2</a>
      <a class="dropdown-item" href="day3-2021.html">Dag 3</a>
      <div class="dropdown-divider"></div>
      <a class="dropdown-item" href="day0-2020.html">(2020) Dag 0: Getting Started</a>
      <a class="dropdown-item" href="day1-2020.html">(2020) Dag 1: Virtual Box</a>
      <a class="dropdown-item" href="day2-2020.html">(2020) Dag 2: Linux Command Line</a>
      <a class="dropdown-item" href="day3-2020.html">(2020) Dag 3: SSH and HTML</a>
      <div class="dropdown-divider"></div>
      <a class="dropdown-item" href="tips.html">Tips</a>
    </div>
  </li>
        
  <li class="nav-item dropdown">
    <a class="nav-link dropdown-toggle" data-toggle="dropdown" href="#" role="button" aria-haspopup="true" aria-expanded="false">Preparation</a>
    <div class="dropdown-menu">
      <a class="dropdown-item disabled"><strong>Security and Ethical Hacking</strong></a>
      <a class="dropdown-item" href="prep-security-1-2021.html">Security 1</a>
      <a class="dropdown-item" href="prep-security-2-2021.html">Security 2</a>
      <a class="dropdown-item" href="prep-security-3-2021.html">Security 3</a>
      <a class="dropdown-item" href="prep-security-4-2021.html">Security 4</a>
      <a class="dropdown-item" href="prep-security-5-2021.html">Security 5</a>
      <div class="dropdown-divider"></div>
      <a class="dropdown-item" href="prep-teamwork.html">Teamwork</a>
      <div class="dropdown-divider"></div>
      <a class="dropdown-item disabled"><strong>Internet of Things</strong></a>
      <a class="dropdown-item" href="prep-iot-intro.html">IoT 1: Introduction</a>
      <a class="dropdown-item" href="prep-iot-stm.html">IoT 2: State Machines</a>
      <a class="dropdown-item" href="prep-iot-stmpy.html">IoT 2: State Machines in Micro Python</a>
      <a class="dropdown-item" href="prep-iot-http-json.html">IoT 3: HTTP and JSON</a>
      <a class="dropdown-item" href="prep-iot-mqtt.html">IoT 4: MQTT</a>
      <!--
      <a class="dropdown-item disabled"><strong>Networking (2020)</strong></a>
      <a class="dropdown-item" href="prep-networking-1-2020.html">Binary and IP addresses</a>
      <a class="dropdown-item" href="prep-networking-2-2020.html">Layers and Docker</a>
      <a class="dropdown-item" href="prep-networking-3-2020.html">Webservers and DNS</a>
      <div class="dropdown-divider"></div>
      <a class="dropdown-item disabled"><strong>Security (2020)</strong></a>
      <a class="dropdown-item" href="prep-security-1-2020.html">Security 1: Cyber Security and Ethical Hacking </a>
      <a class="dropdown-item" href="prep-security-2-2020.html">Security 2: Authentication, Authorization, and Password Storage</a>
      <a class="dropdown-item" href="prep-security-3-2020.html">Security 3: Passwords and Cryptography</a>
      <a class="dropdown-item" href="prep-security-4-2020.html">Security 4: Security Vulnerabilities</a>
      <div class="dropdown-divider"></div>
      <a class="dropdown-item disabled"><strong>Internet of Things (2020)</strong></a>
      <a class="dropdown-item" href="prep-iot-intro.html">IoT 1: Introduction</a>
      <a class="dropdown-item" href="prep-iot-devices.html">IoT 1: Installation</a>
      <a class="dropdown-item" href="prep-iot-stm.html">IoT 2: State Machines</a>
      <a class="dropdown-item" href="prep-iot-stmpy.html">IoT 2: State Machines in Micro Python</a>
      <a class="dropdown-item" href="prep-iot-http-json.html">IoT 3: HTTP and JSON</a>
      <a class="dropdown-item" href="prep-iot-mqtt.html">IoT 4: MQTT</a>
      <a class="dropdown-item" href="prep-iot-api.html">IoT 4: APIs</a>
      <a class="dropdown-item" href="prep-iot-nb-iot.html">NB-IoT (Extra)</a>-->
    </div>
  </li>
  
  <li class="nav-item dropdown">
    <a class="nav-link dropdown-toggle" data-toggle="dropdown" href="#" role="button" aria-haspopup="true" aria-expanded="false">Labs</a>
    <div class="dropdown-menu">
        <a class="dropdown-item disabled"><strong>Security</strong></a>
        <a class="dropdown-item" href="security-1-2021.html">Security 1</a>
        <a class="dropdown-item" href="material/TTM4175-2021-L02-Technical_information_gathering.pdf">Security 2: Technical Information gathering</a>
        <a class="dropdown-item" href="material/TTM4175-2021-L03-Network_mapping.pdf">Security 3: Network mapping</a>
        <a class="dropdown-item" href="material/TTM4175-2021-L04-Web_hacking1.pdf">Security 4: Web Hacking 1</a>
        <a class="dropdown-item" href="material/TTM4175-2021-L04-Web_hacking2.pdf">Security 4: Web Hacking 2</a>
        <a class="dropdown-item" href="security-5-2021.html">Security 5</a>
        <div class="dropdown-divider"></div>
        <a class="dropdown-item" href="teamwork.html">Teamwork</a>
        <div class="dropdown-divider"></div>
        <a class="dropdown-item disabled"><strong>Internet of Things (2020)</strong></a>
        <a class="dropdown-item" href="iot-devices-2021.html">IoT 1: Programming Devices</a>
        <a class="dropdown-item" href="iot-stm-2021.html">IoT 2: State Machines</a>
        <a class="dropdown-item" href="iot-http-json.html">IoT 3: HTTP and JSON</a>
        <a class="dropdown-item" href="iot-mqtt-chat.html">IoT 4: MQTT Chat</a>
        <!--
        <a class="dropdown-item disabled"><strong>Networking (2020)</strong></a>
        <a class="dropdown-item" href="networking-1-2020.html">Binary and IP addresses</a>
        <a class="dropdown-item" href="networking-2-2020.html">Layers and Docker</a>
        <a class="dropdown-item" href="networking-3-2020.html">Webservers and DNS</a>
        <div class="dropdown-divider"></div>
        <a class="dropdown-item disabled"><strong>Security (2020)</strong></a>
        <a class="dropdown-item" href="security-1-2020.html">Security 1</a>
        <a class="dropdown-item" href="security-2-2020.html">Security 2</a>
        <a class="dropdown-item" href="security-3-2020.html">Security 3</a>
        <a class="dropdown-item" href="security-4-2020.html">Security 4</a>
        <div class="dropdown-divider"></div>
        <a class="dropdown-item disabled"><strong>Internet of Things (2020)</strong></a>
        <a class="dropdown-item" href="iot-devices.html">IoT 1: Programming Devices</a>
        <a class="dropdown-item" href="iot-stm.html">IoT 2: State Machines</a>
        <a class="dropdown-item" href="iot-http-json-2020.html">IoT 3: HTTP and JSON</a>
        <a class="dropdown-item" href="iot-http-json-2020-solution.html">IoT 3: HTTP and JSON (Solution and Revised Tasks)</a>
        <a class="dropdown-item" href="iot-mqtt-chat.html">IoT 4: MQTT Chat</a>
        <a class="dropdown-item" href="iot-lopy.html">LoPy</a>
        <a class="dropdown-item" href="iot-mqtt.html">MQTT</a>
        <a class="dropdown-item" href="iot-lorawan.html">LoRaWAN / NB-IoT</a>
        <a class="dropdown-item" href="iot-api.html">API</a>-->
      </div>
  </li>
  
  <li class="nav-item dropdown">
    <a class="nav-link dropdown-toggle" data-toggle="dropdown" href="#" role="button" aria-haspopup="true" aria-expanded="false">Extra</a>
    <div class="dropdown-menu">
      <a class="dropdown-item disabled"><strong>Learning</strong></a>
      <a class="dropdown-item" href="learning-rats.html">RATs</a>
      <a class="dropdown-item" href="feedback.html">Tilbakemelding</a>
      <a class="dropdown-item" href="reports.html">Rapporter</a>
      <a class="dropdown-item" href="teams.html">Teams</a>
      <a class="dropdown-item" href="working-in-teams.html">Working in Teams</a>
      <a class="dropdown-item" href="tools.html">Learning Tools</a>
      <div class="dropdown-divider"></div>
      <a class="dropdown-item disabled"><strong>Material</strong></a>
      <a class="dropdown-item" href="commands-help.html">Help on Commands</a>
      <a class="dropdown-item" href="commands.html">List of Commands</a>
      <a class="dropdown-item" href="computer-history.html">Extra Videos</a>
      <div class="dropdown-divider"></div>
      <a class="dropdown-item disabled"><strong>Tools</strong></a>
      <a class="dropdown-item" href="virtual-box-mac.html">Virtual Box for Mac</a>
      <a class="dropdown-item" href="virtual-box-win.html">Virtual Box for Windows</a>
      <a class="dropdown-item" href="shell-mac.html">Terminal and SSH on Mac</a>
      <a class="dropdown-item" href="shell-win.html">Terminal and SSH on Windows</a>
    </div>
  </li>
  
  <!--
  <li class="nav-item">
    <a class="nav-link" href="#">Blackboard</a>
  </li>-->
</ul>

<div class="navbar-nav flex-row ml-md-auto d-none d-md-flex"></div>
             <a class="navbar-brand" href="https://ntnu.edu">
      	<svg width="100" height="30">
      		<image xlink:href="https://innsida.ntnu.no/innsida-theme/images/ntnu-graphics/ntnu_logo_white.svg" 
      		src="https://innsida.ntnu.no/innsida-theme/images/ntnu-graphics/ntnu_logo_white.png" width="100%" height="100%"></image>
      	</svg>
      </a>
    </nav>


<div class="page">
    </section>
    <section class="content">
<h1>HTTP and JSON</h1>
<p>Today we will use HTTP as communication protocol and JSON as serialization format to send data, from a client to a server and from a server to a client.</p>

    </section>
    <section class="content">
<h1>HTTP Client Requests: Checking the News</h1>
<p>Let us first make a HTTP request for the most common job: requesting the content of a website. Of course, you know what happens when you make a request to <a href="https://www.nrk.no/">https://www.nrk.no/</a> via your browser. But there are other ways you can make such a request.</p>
<h3>Checking the News via Curl</h3>
<p>Use the command line tool `curl to request the website:</p>

<div class="sourceCode" id="cb1"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="ex">curl</span> <span class="at">--verbose</span> https://www.nrk.no/</span></code></pre></div>
<div class="task"><p>Can you read some of the headlines?</p>
</div>
<div class="task"><p>What happens if you try to use the URL <code>http://www.nrk.no/</code> instead? What does the response say? Can you find out what this response means?</p>
</div>
<h3>Checking the News via Python</h3>
<p>You can make requests also programmatically, that means, as part of a program running in Python. For that, a dedicated package <code>requests</code> exists that lets you make requests and parse the response in a simple way.</p>
<p>Install the requests package:</p>

<div class="sourceCode" id="cb1"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="ex">python3</span> <span class="at">-m</span> pip install requests</span></code></pre></div>
<span name="e3c025"></span><aside name="e3c025"><p>Using <code>pip</code> with the <code>python3 -m</code> prefix prevents that you use a wrong installation of pip in your computer, for instance the one for Python 2.7. By going through Python, you make sure you use the <code>pip</code> installation that also matches your <code>python3</code>. You also don't need to worry about <code>pip3</code> or <code>pip</code>.</p>
</aside>
<p>With this package installed, the program to make a request to a website looks like this:</p>

<div class="sourceCode" id="cb1"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> requests</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>url <span class="op">=</span> <span class="st">&quot;https://nrk.no/&quot;</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>response <span class="op">=</span> requests.get(url)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(response.text)</span></code></pre></div>
<p>The request returns a data structure of the type <a href="https://requests.readthedocs.io/en/latest/api/#requests.Response">Response</a> which contains the answer as a text field, which we simply print out.</p>

<div class="task"><p>Have a look at the output, it should be the same as the one obtained with curl.</p>
</div>
    </section>
    <section class="content">
<h1>HTTP Client Requests: Checking the Weather</h1>
<p>So these were requests to get the content of a website.
But HTTP can also be used in a different way. <a href="Yr.no">Yr.no</a> provides weather information, which most people access either via the website or the mobile app.
Yr also offers an API so that other applications can obtain weather information, that means, they can access the weather forecast without downloading the website.</p>
<p>The API of Yr <a href="https://api.met.no/weatherapi/locationforecast/2.0/documentation#!/data/get_compact">is explained here in detail.</a>.
Select the box that says <code>GET/compact</code>, as shown in the figure below.
This box lets you try out a request, directly from the website.
The required input data are latitude and longitude.
For Trondheim, those are <code>lat=63.43</code> and <code>lon=10.39</code>.</p>

<div class="task"><p>Use the API documentation on the website to make a request, and browse through the response you get in the answer box below. Check if you can recognize some of the values and if they are more or less what you expect.</p>
</div>
<div class="figure">
<img src="figures/http/yr-1.png" width="100%"/>
</div>
<h3>Weather via Curl</h3>
<p>We can also do the same HTTP request from our command line using <code>curl</code>:</p>

<div class="sourceCode" id="cb1"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="ex">curl</span> <span class="st">&#39;https://api.met.no/weatherapi/locationforecast/2.0/compact?lat=63.43&amp;lon=10.39&#39;</span></span></code></pre></div>
<h3>Weather via Python</h3>
<p>Let us use Python again for making the same request, with the requests module as done above.
Find the correct URL from the API website.</p>

<button class="w3collapsible">Hint for the code</button>
<div class="w3content">
<pre><code class="language-python">import requests

url = &quot;https://api.met.no/weatherapi/locationforecast/2.0/compact?lat=63.43&amp;lon=10.39&quot;
response = requests.get(url)
print(response.text)
</code></pre>

</div>
<div class="task"><p>Run the code, document the result.</p>
</div>
<span name="9418ba"></span><aside name="9418ba"><p>Note that <a href="https://requests.readthedocs.io/en/latest/api/#requests.Response.text">text</a> is a field or variable in the requests object, but <a href="https://requests.readthedocs.io/en/latest/api/#requests.Response.json">json()</a> is a function we call on it, therefore we use the braces.</p>
</aside>
<p>The Yr API provides its response as a JSON-formatted string. For that reason, we can ask the response to provide us the format in JSON via the function <code>response.json()</code> which you can also print via <code>print(response.json())</code>.</p>

<button class="w3collapsible">Hint for the code</button>
<div class="w3content">
<pre><code class="language-python">import requests

url = &quot;https://api.met.no/weatherapi/locationforecast/2.0/compact?lat=63.43&amp;lon=10.39&quot;
response = requests.get(url)
print(response.json())
</code></pre>

</div>
<p>The requests module has already transformed the JSON-formatted string in to a set of corresponding Python data structures, which consists of dictionaries and lists. When we print these with the normal <code>print()</code> function, the data structure doesn't look very nice, and it is hard to understand how the data is nested. Therefore, Python has a function for printing data in a pretty way:</p>

<div class="sourceCode" id="cb1"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pprint <span class="im">import</span> pprint</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co"># your code...</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>pprint(response.json())</span></code></pre></div>
<p>Notice that we use now the function <code>pprint()</code> instead of <code>print()</code> to print things <em>pretty</em>. Pretty good, huh?</p>

<div class="task"><p>Pretty-print the response as JSON structure of dicts and lists, and document a few lines to give an illustration of its structure.</p>
</div>
<button class="w3collapsible">Hint for the code</button>
<div class="w3content">
<pre><code class="language-python">from pprint import pprint
import requests

url = &quot;https://api.met.no/weatherapi/locationforecast/2.0/compact?lat=63.43&amp;lon=10.39&quot;
response = requests.get(url)
pprint(response.json())
</code></pre>

</div>
<h3>Finding the Temperature</h3>
<p>The response provides the current forecast for a location, that means, several hours and even days ahead.
It also contains so-called meta-data which explains details <em>about</em> the data.
These are all useful, but make the structure of the response a bit complex.
For now, we are just interested in the air temperature.</p>

<div class="task"><p>Can you find the data field <code>air_temperature</code>?</p>
</div>
<p>When we want to use the temperature in our program, we need to extract it out of this complex structure.</p>

<div class="task"><p>Starting from the dictionary you receive with <code>response.json()</code> function, can you navigate to the air temperature that is closest to the current time?</p>
</div>
<div class="tips"><ul>
<li>Work step by step.</li>
<li>Pretty print the structure after each step.</li>
<li>Print the keys of a dictionary using its <code>keys()</code> function, for example <code>response.json().keys()</code>.</li>
<li>Access a field in a dictionary with the square brackets, for instance <code>response.json()['geometry']</code>.</li>
<li>If you find a list, access its first element with <code>list[0]</code> or its last with <code>list[-1]</code>.</li>
</ul>
<p>This can be a bit of a puzzle, but should be no problem in the end.</p>
</div>
<h3>Function for the Temperature</h3>
<p>Using the code above, create a function that takes the latitude and longitude as input arguments and that returns the air temperature at that location. This is how the function should look like:</p>

<div class="sourceCode" id="cb1"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_air_temp(lat, lon):</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># </span><span class="al">TODO</span><span class="co"> make a request</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># </span><span class="al">TODO</span><span class="co"> return only the value of the air temperature only</span></span></code></pre></div>
<p>Remember that Python lets you create a string that includes variables with the <code>format()</code> function:</p>

<div class="sourceCode" id="cb1"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>lat <span class="op">=</span> ...</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>lon <span class="op">=</span> ...</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>url <span class="op">=</span> <span class="st">&quot;https://api.met.no/weatherapi/locationforecast/2.0/compact?lat=</span><span class="sc">{}</span><span class="st">&amp;lon=</span><span class="sc">{}</span><span class="st">&quot;</span>.<span class="bu">format</span>(lat, lon)</span></code></pre></div>
<p>A newer and more compact way to format strings and integrate variables is using f-strings, where you write the variables directly into curly brackets. (Note the <code>f</code> before the string.)</p>

<div class="sourceCode" id="cb1"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>lat <span class="op">=</span> ...</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>lon <span class="op">=</span> ...</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>url <span class="op">=</span> <span class="ss">f&quot;https://api.met.no/weatherapi/locationforecast/2.0/compact?lat=</span><span class="sc">{</span>lat<span class="sc">}</span><span class="ss">&amp;lon=</span><span class="sc">{</span>lon<span class="sc">}</span><span class="ss">&quot;</span></span></code></pre></div>
<p>Let's make this a bit more compact for later, so that we store the coordinates of a few places and only have to provide place names.
We can for instance simply code them in a nested dictionary:</p>

<div class="sourceCode" id="cb1"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>places <span class="op">=</span> {</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;Trondheim&quot;</span>: {<span class="st">&quot;lat&quot;</span>: <span class="fl">63.43</span>, <span class="st">&quot;lon&quot;</span>: <span class="fl">10.39</span>},</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;Oslo&quot;</span>: {<span class="st">&quot;lat&quot;</span>: <span class="fl">59.91</span>, <span class="st">&quot;lon&quot;</span>: <span class="fl">10.75</span>},</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;Bergen&quot;</span>: {<span class="st">&quot;lat&quot;</span>: <span class="fl">60.39</span>, <span class="st">&quot;lon&quot;</span>: <span class="fl">5.32</span>},</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;Avaldsnes&quot;</span>: {<span class="st">&quot;lat&quot;</span>: <span class="fl">59.35</span>, <span class="st">&quot;lon&quot;</span>: <span class="fl">5.27</span>},</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;Tromsø&quot;</span>: {<span class="st">&quot;lat&quot;</span>: <span class="fl">69.64</span>, <span class="st">&quot;lon&quot;</span>: <span class="fl">18.95</span>},</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>With this dictionary declared globally in the file (above any function definitions), create a new version of the function to compare the air temperature:</p>

<div class="sourceCode" id="cb1"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_air_temp_2(place):</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># create the function</span></span></code></pre></div>
<p>Fantastic---we now have a compact function that gets the temperature forecast from Yr so we can use it later in our application. We'll come back to it.</p>

    </section>
    <section class="content">
<h1>Smart Temperature Sensor</h1>
<p>We now want to create a system that combines HTTP requests to create a more advanced temperature display.
Instead of just showing the local temperature of a sensor, it should also show the predicted temperature.
Below is a figure of the setup:</p>

<div class="figure">
<img src="figures/http/smart-home.png" width="100%"/>
</div>
<ul>
<li>The sensor periodically measures its temperature and provides it to the server in the center, using HTTP POST requests.</li>
<li>The server stores the temperature of the temperature sensor, and periodically requests the temperature forecast from the API from <a href="yr.no">yr.no</a> via HTTP GET requests.</li>
<li>The server also answers GET requests from clients to present both the sensor temperature and the prediction from <a href="yr.no">yr.no</a> in a single page.</li>
</ul>

<div class="task"><p>Create a sequence diagram with three components: temperature sensor, the server, Yr and the mobile client. Illustrate with the sequence diagram how the temperature sensor updates the server with the measured temperature, and how the mobile client makes a request to our server, which also involves getting the temperature forecast from Yr.</p>
</div>
<h2>Code for the Web Server</h2>
<p>Above we have <strong>initiated HTTP requests as clients</strong> to get news and weather, and combined two weather requests to a little program.
Now we want to also build a web server so that we can <strong>accept HTTP requests and answer them</strong>. As you have learned in the preparation, HTTP is not a symmetric protocol; client and server work very differently.
The code for the server handling a requests therefore also works very differently from the one making a request.</p>
<p>Copy the following code into a file <code>webserver.py</code>. The code declares some functions, and then a class <code>RequestHandler</code>, which defines a web server. It then configures and starts this web server, which is then active and waits for GET requests.</p>

<div class="sourceCode" id="cb1"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> http.server <span class="im">import</span> HTTPServer, BaseHTTPRequestHandler</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> urllib.parse <span class="im">import</span> quote, unquote</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> socket</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> extract_json_string(string):</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>    start <span class="op">=</span> string.find(<span class="st">&quot;{&quot;</span>)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>    stop <span class="op">=</span> string.rfind(<span class="st">&quot;}&quot;</span>)</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> string[start : stop <span class="op">+</span> <span class="dv">1</span>]</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_ip_address():</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> socket.gethostbyname(socket.gethostname())</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> dictionary_to_string(dictionary):</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> json.dumps(dictionary)</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> json_string_to_dictionary(json_string):</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> json.loads(json_string)</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> encode_string_into_url(string):</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> quote(string)</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> decode_url_back_to_string(url_encoded_string):</span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> unquote(url_encoded_string)</span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> string_to_unicode_bytes(string):</span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> string.encode(<span class="st">&quot;utf-8&quot;</span>)</span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> RequestHandler(BaseHTTPRequestHandler):</span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> store_data(<span class="va">self</span>, name, data):</span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> <span class="bu">hasattr</span>(<span class="va">self</span>.server, <span class="st">&quot;data&quot;</span>):</span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.server.data <span class="op">=</span> {}</span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.server.data[name] <span class="op">=</span> data</span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> load_data(<span class="va">self</span>, name):</span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">hasattr</span>(<span class="va">self</span>.server, <span class="st">&quot;data&quot;</span>):</span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> name <span class="kw">in</span> <span class="va">self</span>.server.data:</span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="va">self</span>.server.data[name]</span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> do_GET(<span class="va">self</span>):</span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Phase 1: What has been requested?</span></span>
<span id="cb1-51"><a href="#cb1-51" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;-------- Incoming GET request --------&quot;</span>)</span>
<span id="cb1-52"><a href="#cb1-52" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;  Request data: </span><span class="sc">{}</span><span class="st">&quot;</span>.<span class="bu">format</span>(<span class="va">self</span>.requestline))</span>
<span id="cb1-53"><a href="#cb1-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-54"><a href="#cb1-54" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Phase 2: Which data do we want to send back?</span></span>
<span id="cb1-55"><a href="#cb1-55" aria-hidden="true" tabindex="-1"></a>        response <span class="op">=</span> <span class="st">&quot;Hei hei&quot;</span></span>
<span id="cb1-56"><a href="#cb1-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-57"><a href="#cb1-57" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Phase 3: Let&#39;s send back the data!</span></span>
<span id="cb1-58"><a href="#cb1-58" aria-hidden="true" tabindex="-1"></a>        response_in_bytes <span class="op">=</span> string_to_unicode_bytes(response)</span>
<span id="cb1-59"><a href="#cb1-59" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.send_response(<span class="dv">200</span>)</span>
<span id="cb1-60"><a href="#cb1-60" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.send_header(<span class="st">&quot;Content-type&quot;</span>, <span class="st">&quot;text/plain&quot;</span>)</span>
<span id="cb1-61"><a href="#cb1-61" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.end_headers()</span>
<span id="cb1-62"><a href="#cb1-62" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.wfile.write(response_in_bytes)</span>
<span id="cb1-63"><a href="#cb1-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-64"><a href="#cb1-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-65"><a href="#cb1-65" aria-hidden="true" tabindex="-1"></a>port <span class="op">=</span> <span class="dv">8023</span></span>
<span id="cb1-66"><a href="#cb1-66" aria-hidden="true" tabindex="-1"></a>httpd <span class="op">=</span> HTTPServer(</span>
<span id="cb1-67"><a href="#cb1-67" aria-hidden="true" tabindex="-1"></a>    (<span class="st">&quot;&quot;</span>, port),</span>
<span id="cb1-68"><a href="#cb1-68" aria-hidden="true" tabindex="-1"></a>    RequestHandler,</span>
<span id="cb1-69"><a href="#cb1-69" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb1-70"><a href="#cb1-70" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;&quot;</span>)</span>
<span id="cb1-71"><a href="#cb1-71" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot; ******** TTM4175 Web Server  ******** &quot;</span>)</span>
<span id="cb1-72"><a href="#cb1-72" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(</span>
<span id="cb1-73"><a href="#cb1-73" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;    The server will be reachable via  http://</span><span class="sc">{}</span><span class="st">:</span><span class="sc">{}</span><span class="st">/&quot;</span>.<span class="bu">format</span>(get_ip_address(), port)</span>
<span id="cb1-74"><a href="#cb1-74" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb1-75"><a href="#cb1-75" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;    Terminate the server via Ctrl-C.&quot;</span>)</span>
<span id="cb1-76"><a href="#cb1-76" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot; ************************************* &quot;</span>)</span>
<span id="cb1-77"><a href="#cb1-77" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;&quot;</span>)</span>
<span id="cb1-78"><a href="#cb1-78" aria-hidden="true" tabindex="-1"></a>httpd.serve_forever()</span></code></pre></div>
<ul>
<li>Read carefully through the code, starting in the line where we assign a port, and then the definitions of classes and functions above.</li>
<li>You can ignore the functions <code>store_data()</code> and <code>load_data()</code> for now.</li>
<li>Pay special attention to the function <code>do_GET()</code>. This will be the core of what we do today.</li>
<li>Be patient. Ask questions to each other, make sure everyone gets it.</li>
</ul>
<p><strong>A detail:</strong> You may see that the <code>do_GET()</code> function only has <code>self</code> as parameter (from the class), and does not have a return value.
This may be surprising, since it should get the request as input and then compute an answer. However, see how the code above gets access to the request via the attribute <code>self.requestline</code>. Similarly, the response is created by calling some functions on the parent class, for instance <code>self.wfile.write(response_in_bytes)</code>. So therefore the <code>do_GET()</code> function does not have any input or return parameters. It's more a question of how the API is designed, the authors have made a decision here.</p>

<div class="task"><p>Run the code, like any Python program via <code>python webserver.py</code>.</p>
</div>
<p>Note: Whenever you are going to change the code of the web server, you will need to terminate it via <code>Ctrl-C</code> and then restart it.</p>
<h2>Request via Web Browser</h2>
<ul>
<li>Either on the same machine, or (even better) on a different machine in case you are in the same network, access the website address that the server prints out in a browser.</li>
<li>If you access the browser on the same machine, you can type <code>http://localhost:8023/</code> as address. Otherwise, use the IP address instead of <code>localhost</code>.</li>
<li>What happens in the browser, and what happens in the command where the server program runs?</li>
<li>Create a sequence diagram of what you have just observed, and annotate it with details that you find relevant.</li>
<li>Answer the following questions:
<ul>
<li>In which format is the answer sent from the webserver to the client? Which steps are involved to convert the data for the response?</li>
<li>What happens if you send the request to the wrong port, for instance port <code>8001</code>?</li>
</ul>
</li>
</ul>

    </section>
    <section class="content">
<h1>Sending Data to the Server</h1>
<p>We can send additional data with our request, by appending it into the URL as follows:</p>

<pre><code>http://localhost:8000/?data={&quot;time&quot;: &quot;12:05&quot;, &quot;temperature&quot;: 20.0, &quot;humidity&quot;: 54.3}</code></pre>
<h2>Sending Data via the Browser</h2>
<ul>
<li>Copy the URL from above, but adjust it to your IP address (if necessary).</li>
<li>Paste the entire URL with the data part into your browser.</li>
<li>Observe what happens in the address line after the response returns. Did the browser change the data you wanted to transmit?</li>
<li>Check which information was received by the server.</li>
<li>Has the data been transformed somehow?</li>
</ul>

<h2>GET and POST on the Server</h2>
<p>Look again at the figure. Form the task above, we have already the <strong>GET</strong> command in place (by function <code>do_GET()</code>). With this command, we offer the browser (here shown as phone) a website so we can read the temperature.
To let the sensor inform the server about the temperature, it uses instead the <strong>POST</strong> command.</p>

<div class="figure">
<img src="figures/http/smart-home.png" width="100%"/>
</div>
<p>So, to repeat:</p>
<ul>
<li>
<p>Here, the <code>do_GET()</code> function processes the requests from browsers that want to know the temperature, and it works pretty much like the <strong>GET</strong> for any other website; we return a complete website to the browser that shows the temperature.</p>
</li>
<li>
<p>With the <code>do_POST()</code> function, a smart sensor (which we imitate with another Python program) can tell the sensor which temperature it measured.</p>
</li>
</ul>
<p>The temperature sensor and the browser to show the temperature to a user are acting completely independently. (Of course, the server can only show a temperature to a browser if the temperature sensor has at least updated the temperature once.)</p>

<div class="task"><p>Run the code, like any Python program via <code>python webserver.py</code>.</p>
</div>
<div class="task"><p>Add a function <code>do_POST():</code> <strong>in addition</strong> to the already existing <code>do_GET()</code> function. See the code below for that function.</p>
</div>
<div class="sourceCode" id="cb1"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> do_POST(<span class="va">self</span>):</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;HTTP POST request as it comes from the sensor device application,</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co">    for instance to send the current temerature.&quot;&quot;&quot;</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;-------- Incoming POST request --------&quot;</span>)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;  Request data: </span><span class="sc">{}</span><span class="st">&quot;</span>.<span class="bu">format</span>(<span class="va">self</span>.requestline))</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>    decoded_request <span class="op">=</span> decode_url_back_to_string(<span class="va">self</span>.requestline)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;  Decoded data: </span><span class="sc">{}</span><span class="st">&quot;</span>.<span class="bu">format</span>(decoded_request))</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>    json_string <span class="op">=</span> extract_json_string(decoded_request)</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;  Extracted JSON string: </span><span class="sc">{}</span><span class="st">&quot;</span>.<span class="bu">format</span>(json_string))</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>    dictionary <span class="op">=</span> json_string_to_dictionary(json_string)</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(dictionary)</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># We extract the temperature...</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>    temperature <span class="op">=</span> dictionary[<span class="st">&quot;temperature&quot;</span>]</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;Temperature </span><span class="sc">{</span>temperature<span class="sc">}</span><span class="ss"> received in do_POST()&quot;</span>)</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ...and store it</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># self.store_data(&quot;temperature&quot;, temperature)</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Phase 2: Which data do we want to send back?</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>    response <span class="op">=</span> <span class="st">&quot;ok&quot;</span></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Phase 3: Let&#39;s send back the data!</span></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>    response_in_bytes <span class="op">=</span> string_to_unicode_bytes(response)</span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.send_response(<span class="dv">200</span>)</span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.send_header(<span class="st">&quot;Content-type&quot;</span>, <span class="st">&quot;text/plain&quot;</span>)</span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.end_headers()</span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.wfile.write(response_in_bytes)</span></code></pre></div>
<p>We use from now on the <code>do_GET()</code> function to serve the web site that displays the temperature, and the function <code>do_POST()</code> to receive data from the temperature sensor. The web server can hence process two different requests: one for storing data, one for serving a website that presents the data.</p>
<h2>Sending Data via Python Requests</h2>
<p>We now want to send data to the web server from Python. In a real system, a sensor should do this automated and in periodic intervals.
(As we work without special hardware, we are happy with a Python program that just imitates the temperature sensor.)
This code sends the data to the web server, using a <strong>POST</strong> request:</p>

<div class="sourceCode" id="cb1"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> requests</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> urllib.parse <span class="im">import</span> quote, unquote</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> dictionary_to_string(dictionary):</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> json.dumps(dictionary)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> encode_string_into_url(string):</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> quote(string)</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> print_response(response):</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&#39;-------- Response --------&#39;</span>)</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&#39;Status code: </span><span class="sc">{}</span><span class="st">&#39;</span>.<span class="bu">format</span>(response.status_code))</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&#39;-------- Content--------&#39;</span>)</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(response.text)</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&#39;------------------------&#39;</span>)</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="co"># example data</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>dictionary <span class="op">=</span> {}</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>dictionary[<span class="st">&#39;temperature&#39;</span>] <span class="op">=</span> <span class="fl">20.0</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>dictionary[<span class="st">&#39;sensor_name&#39;</span>] <span class="op">=</span> <span class="st">&#39;kitchen&#39;</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a><span class="co"># ... your code ...</span></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>response <span class="op">=</span> requests.post(<span class="st">&#39;http://192.168.86.104:8000/?data=</span><span class="sc">{}</span><span class="st">&#39;</span>.<span class="bu">format</span>(...))</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>print_response(response)</span></code></pre></div>
<ul>
<li>Create a new client program with the code above.</li>
<li>Add the necessary lines to convert the data to send, use the included functions.</li>
<li>Document what these functions actually do.</li>
<li>With the server from before running, execute the client code.</li>
<li>Document what happens.</li>
</ul>

<h2>Decoding Data in the Server</h2>
<ul>
<li>Pay attention to the method <code>do_POST()</code> in the server</li>
<li>What is happening in the code that we provided in the method <code>do_POST()</code>, step by step?</li>
</ul>

    </section>
    <section class="content">
<h1>Storing Temperature Data in the Server</h1>
<p>The web server should store the temperature that the sensor sends in. So we need some way to store data in the web server. In a real system, this is done with data bases or more powerful storage solutions optimized to serve many requests. For our little server, just storing the data in a Python dictionary is enough.
We use the two functions <code>store_data()</code> and <code>load_data()</code> shown below to store or load data.</p>

<div class="sourceCode" id="cb1"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> store_data(<span class="va">self</span>, name, data):</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> <span class="bu">hasattr</span>(<span class="va">self</span>.server, <span class="st">&quot;data&quot;</span>):</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.server.data <span class="op">=</span> {}</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.server.data[name] <span class="op">=</span> data</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> load_data(<span class="va">self</span>, name):</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">hasattr</span>(<span class="va">self</span>.server, <span class="st">&quot;data&quot;</span>):</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> name <span class="kw">in</span> <span class="va">self</span>.server.data:</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">self</span>.server.data[name]</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">None</span></span></code></pre></div>
<p>As you see, these functions use the <code>self.server</code> attribute, which provides access to the actual server instance.
From there, we can access a variable <code>data</code> that is a dictionary so that we can store variables by name.
I this way we can store data also between different calls of the <code>do_GET()</code> and <code>do_POST()</code> functions.
To repeat and clarify:</p>
<ul>
<li><code>do_POST()</code> stores the temperature data submitted by the temperature sensor application,</li>
<li><code>do_GET()</code> provides the website with the the data from the sensor and the air temperature obtained from the forecast.</li>
</ul>

<div class="task"><p>Uncomment the storage for the temperature in the code.</p>
<h3>Adding the Yr Forecast</h3>
</div>
<div class="task"><p>Extend your server logic so that it does not only return the temperature of the sensor, but also the temperature forecast from yr, so that it is displayed together.</p>
<p>Use the function for getting the forecast you have developed above. This means you web server which acts as a server because it implements the methods GET and POST, now also acts as a client towards Yr.no since it requests data from it.</p>
</div>
    </section>
    <section class="content">
<h1>Optional Task: Nice HTML Output</h1>
<p>Now that we can send a simple string as a response, let's make the answer more advanced and send a proper website in HTML. HTML is in principle also only a string, but the browser reads the formatting tags and creates a nicely rendered page out of it. The following code contains a simple Python method that creates some HTML:</p>

<div class="sourceCode" id="cb1"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> generate_basic_html_page(title<span class="op">=</span><span class="st">&#39;Default Title&#39;</span>):</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>    lines <span class="op">=</span> []</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>    lines.append(<span class="st">&#39;&lt;html&gt;&#39;</span>)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>    lines.append(<span class="st">&#39;    &lt;head&gt;&lt;title&gt;</span><span class="sc">{}</span><span class="st">&lt;/title&gt;&lt;/head&gt;&#39;</span>.<span class="bu">format</span>(title))</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>    lines.append(<span class="st">&#39;    &lt;body&gt;&#39;</span>)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>    lines.append(<span class="st">&#39;        &lt;h1&gt;Hello!&lt;/h1&gt;&#39;</span>)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>    lines.append(<span class="st">&#39;        &lt;p&gt;This is a very simple HTML page. It even contains a &lt;a href=&quot;http://www.ntnu.no&quot;&gt;link.&lt;/a&gt;&lt;/p&gt;&#39;</span>)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>    lines.append(<span class="st">&#39;    &lt;/body&gt;&#39;</span>)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>    lines.append(<span class="st">&#39;&lt;/html&gt;&#39;</span>)</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="st">&#39;</span><span class="ch">\n</span><span class="st">&#39;</span>.join(lines)</span></code></pre></div>
<ul>
<li>
<p>Copy the code above into the web server file from above. Place the function just below the import statements, so that it is at the top level of the file. (Not within the class declaration.)</p>
</li>
<li>
<p>Exchange the simple string in the web server so that it instead returns the HTML page created by this function.</p>
</li>
<li>
<p>To make all correct and tidy, update the line where we set the content type so that it uses <code>self.send_header(&quot;Content-type&quot;, &quot;text/html&quot;)</code>.</p>
</li>
<li>
<p>Now go back to the browser, and access the website again. What changed?</p>
</li>
<li>
<p>Can you set the title of the website?</p>
</li>
<li>
<p>Let the function receive the temperature from the sensor and the one from the forecast, and format the information in HTML to include these values.</p>
</li>
</ul>

    </section>
    <section class="content">
<h1>Things to Remember</h1>
<ul>
<li>HTTP can be used for more than just websites, it can also be used to let applications in general transport any type of data.</li>
<li>JSON can be used as a convention how to serialize data types, and then serve as format to send over HTTP.</li>
</ul>

    </section>
</div>


<footer></footer>
<script>
    anchors.add('h1').add('h2').add('h3');
    anchors.options.visible = 'always';
</script>
</body>
</html>
