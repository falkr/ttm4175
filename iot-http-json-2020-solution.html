<html lang="en-US"><head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1"/>

<title>TTM4175</title>
<meta property="og:title" content="TTM4175">
<meta property="og:locale" content="en_US">
<meta name="description" content="Introduction to Communication Technology and Digital Security">
<meta property="og:description" content="Introduction to Communication Technology and Digital Security">


<link rel="stylesheet" href="assets/bootstrap.min.css">
<script src="assets/jquery-3.5.1.min.js"></script>
<script src="assets/bootstrap.min.js"></script>
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.1/css/all.css" integrity="sha384-gfdkjb5BdAXd+lj+gudLWI+BXq4IuLW5IT+brZEZsLFm++aCMlF1V92rMkPaX4PP" crossorigin="anonymous">
<link rel="stylesheet" type="text/css" href="assets/style.css" />
<style type="text/css">div.tip p {
  padding: 10px;
  background-color: #d9eaf2;
  border-radius: 5px;
  border-left: 6px solid #1481b8
}
div.rat ol {
  list-style-type: upper-alpha;
}
.w3collapsible {
  background-color:#f0e9db;
  color: #868279; 
  padding: 8px 18px 8px 8px;
  cursor: pointer;
  width: 100%;
  border: none;
  border-radius: 3px 3px 0 0;
  text-align: left;
  outline: none;
  font-size: 15px;
}

.w3active, .w3collapsible:hover {
  background-color: #f0e9cb;
}

.w3content {
  filter: blur(3px);
  padding: 0 18px;
  display: block;
  overflow: hidden;
  background-color: #f3f3f3;
  margin-bottom: 15px;
}
div.rat ol {
  list-style-type: upper-alpha;
}.steps ol, .steps ul {
  counter-reset: li;
  list-style: none;
  margin-left: 10px
}

.steps li {
  margin: 0 0 10px 0;
  xline-height: 40px;
  min-height: 40px
}

.steps li:before {
  content: counter(li);
  counter-increment: li;
  xborder: 2px solid #1481b8;
  xcolor: white;
  xbackground-color: #1481b8;
  border: 2px solid #868279;
  color: #868279;
  background-color: none;
  font-family: "Source Sans Pro", Georgia, serif;
  font-weight: bold;
  border-radius: 100%;
  text-align: center;
  display: inline-block;
  top:8px;
  left:-30px;
  width: 30px;
  height: 30px;
  position: relative;
  margin-right:-10px;
  margin-left:-20px;
  margin-top:-20px;
  margin-bottom:-20px;
}
div.factbox {
  width:250px; float: right; margin: 0 15px 15px 15px; padding:15px; background: lightblue
}

div.goals ul,
div.goals ul li {
  padding: 0;
  margin: 0;
  list-style: none;
}

div.goals ul {
  margin: 2em 0;
}

div.goals ul li {
  margin: 1em;
  margin-left: 3em;
}

div.goals ul li:before {
  content: '\f26a';
  font-family: bootstrap-icons !important;
  font-size:20;
  float: left;
  margin-left: -1.5em;
  color: #1481b8;
}
div.report p {
padding: 10px;
background-color: #D6E5F0;
border-radius: 5px;
border-left: 6px solid #1481b8 
}

div.report p::before {
    content: 'For the Report: ';
    font-weight: bold; 
    color: #1481b8;
display: inline;
}
div.warning p {
padding: 10px;
background-color: #ffd9ab;
border-radius: 5px;
border-left: 6px solid #fc8c03 
}

div.warning p::before {
    content: '\f071 ';
    font-family: 'Font Awesome 5 Free'; 
    color: #fc8c03;
display: inline;
}
div.check ul,
div.check ul li {
  padding: 0;
  margin: 0;
  list-style: none;
}

div.check ul {
  margin: 2em 0;
}

div.check ul li {
  margin: 1em;
  margin-left: 3em;
}

div.check ul li:before {
  content: '\f26a';
  font-family: bootstrap-icons !important;
  font-size:20;
  float: left;
  margin-left: -1.5em;
  color: #1481b8;
}
div.figure {
  padding: 20px 0 20px 0;
  width: 100%;
}

div.figurefullwitdth {
  padding: 20px 0 20px 0;
  margin-left: -33px;
  margin-right: -33px;
  width: 100%;
}
a.ntnu-button {
    font: 600 14px "Source Sans Pro", Georgia, serif;
    background: #fff;
    color: #00509e;
    border: 1px solid #00509e;
    border-color: #00509e !important
    border-style: solid !important;
    border-radius: 10rem;
    display: inline-block;
    padding: 5px 15px;
    height: auto;
    font-weight: bold;
    line-height: 1.5em;
    text-align: center;
    vertical-align: top;
    cursor: pointer;
    text-decoration: none
}

a.ntnu-button:hover {
    background: #00509e;
    color: #fff;
    text-decoration: none
}

div.task p {
padding: 10px;
background-color: #D6E5F0;
border-radius: 5px;
border-left: 6px solid #1481b8 
}

div.task p::before { 
content: "Task: ";
font-weight: bold;
display: inline;
}
.w3collapsible {
  background-color:#f0e9db;
  color: #868279; 
  padding: 8px 18px 8px 8px;
  cursor: pointer;
  width: 100%;
  border: none;
  border-radius: 3px 3px 0 0;
  text-align: left;
  outline: none;
  font-size: 15px;
}

.w3active, .w3collapsible:hover {
  background-color: #f0e9cb;
}

.w3content {
  filter: blur(3px);
  padding: 0 18px;
  display: block;
  overflow: hidden;
  background-color: #f3f3f3;
  margin-bottom: 15px;
}
</style>
<script src="assets/anchor.js"></script>
<script src="assets/script-aside.js"></script>
</head>
<body id="top">

<nav class="navbar navbar-expand-md navbar-dark " style="background-color:#666666"#2B65EC"> <!-- fixed-top -->
        <ul class="nav nav-pills">
        <li class="nav-item">
    <a class="nav-link" href="index.html" style="font-weight: bold")>TTM4175</a>
  </li>

  <li class="nav-item dropdown">
    <a class="nav-link dropdown-toggle" data-toggle="dropdown" href="#" role="button" aria-haspopup="true" aria-expanded="false">Teknostart</a>
    <div class="dropdown-menu">
      <a class="dropdown-item" href="day0-2021.html">Oppstart</a>
      <a class="dropdown-item" href="material/TTM4175-2021-L01-Introduction_to_ethical_hacking.pdf">Introduction to Ethical Hacking (PDF)</a>
      <a class="dropdown-item" href="material/TTM4175-2021-L01-Introduction_to_Kali_linux.pdf">Introduction to Kali Linux (PDF)</a>
      <a class="dropdown-item" href="day2-2021.html">Dag 2</a>
      <a class="dropdown-item" href="day3-2021.html">Dag 3</a>
      <div class="dropdown-divider"></div>
      <a class="dropdown-item" href="day0-2020.html">(2020) Dag 0: Getting Started</a>
      <a class="dropdown-item" href="day1-2020.html">(2020) Dag 1: Virtual Box</a>
      <a class="dropdown-item" href="day2-2020.html">(2020) Dag 2: Linux Command Line</a>
      <a class="dropdown-item" href="day3-2020.html">(2020) Dag 3: SSH and HTML</a>
      <div class="dropdown-divider"></div>
      <a class="dropdown-item" href="tips.html">Tips</a>
    </div>
  </li>
        
  <li class="nav-item dropdown">
    <a class="nav-link dropdown-toggle" data-toggle="dropdown" href="#" role="button" aria-haspopup="true" aria-expanded="false">Preparation</a>
    <div class="dropdown-menu">
      <a class="dropdown-item disabled"><strong>Security</strong></a>
      <a class="dropdown-item" href="prep-security-1-2021.html">Security 1</a>
      <a class="dropdown-item" href="prep-security-2-2021.html">Security 2</a>
      <a class="dropdown-item" href="prep-security-3-2021.html">Security 3</a>
      <a class="dropdown-item" href="prep-security-4-2021.html">Security 4</a>
      <a class="dropdown-item" href="prep-security-5-2021.html">Security 5</a>
      <div class="dropdown-divider"></div>
      <a class="dropdown-item disabled"><strong>Networking (2020)</strong></a>
      <a class="dropdown-item" href="prep-networking-1-2020.html">Binary and IP addresses</a>
      <a class="dropdown-item" href="prep-networking-2-2020.html">Layers and Docker</a>
      <a class="dropdown-item" href="prep-networking-3-2020.html">Webservers and DNS</a>
      <div class="dropdown-divider"></div>
      <a class="dropdown-item disabled"><strong>Security (2020)</strong></a>
      <a class="dropdown-item" href="prep-security-1-2020.html">Security 1: Cyber Security and Ethical Hacking </a>
      <a class="dropdown-item" href="prep-security-2-2020.html">Security 2: Authentication, Authorization, and Password Storage</a>
      <a class="dropdown-item" href="prep-security-3-2020.html">Security 3: Passwords and Cryptography</a>
      <a class="dropdown-item" href="prep-security-4-2020.html">Security 4: Security Vulnerabilities</a>
      <div class="dropdown-divider"></div>
      <a class="dropdown-item disabled"><strong>Internet of Things (2020)</strong></a>
      <a class="dropdown-item" href="prep-iot-intro.html">IoT 1: Introduction</a>
      <a class="dropdown-item" href="prep-iot-devices.html">IoT 1: Installation</a>
      <a class="dropdown-item" href="prep-iot-stm.html">IoT 2: State Machines</a>
      <a class="dropdown-item" href="prep-iot-stmpy.html">IoT 2: State Machines in Micro Python</a>
      <a class="dropdown-item" href="prep-iot-http-json.html">IoT 3: HTTP and JSON</a>
      <a class="dropdown-item" href="prep-iot-mqtt.html">IoT 4: MQTT</a>
      <!--
      <a class="dropdown-item" href="prep-iot-api.html">IoT 4: APIs</a>
      <a class="dropdown-item" href="prep-iot-nb-iot.html">NB-IoT (Extra)</a>-->
    </div>
  </li>
  
  <li class="nav-item dropdown">
    <a class="nav-link dropdown-toggle" data-toggle="dropdown" href="#" role="button" aria-haspopup="true" aria-expanded="false">Labs</a>
    <div class="dropdown-menu">
        <a class="dropdown-item disabled"><strong>Security</strong></a>
        <a class="dropdown-item" href="security-1-2021.html">Security 1</a>
        <a class="dropdown-item" href="security-2-2021.html">Security 2</a>
        <a class="dropdown-item" href="security-3-2021.html">Security 3</a>
        <a class="dropdown-item" href="security-4-2021.html">Security 4</a>
        <a class="dropdown-item" href="security-5-2021.html">Security 5</a>
        <div class="dropdown-divider"></div>
        <a class="dropdown-item disabled"><strong>Networking (2020)</strong></a>
        <a class="dropdown-item" href="networking-1-2020.html">Binary and IP addresses</a>
        <a class="dropdown-item" href="networking-2-2020.html">Layers and Docker</a>
        <a class="dropdown-item" href="networking-3-2020.html">Webservers and DNS</a>
        <div class="dropdown-divider"></div>
        <a class="dropdown-item disabled"><strong>Security (2020)</strong></a>
        <a class="dropdown-item" href="security-1-2020.html">Security 1</a>
        <a class="dropdown-item" href="security-2-2020.html">Security 2</a>
        <a class="dropdown-item" href="security-3-2020.html">Security 3</a>
        <a class="dropdown-item" href="security-4-2020.html">Security 4</a>
        <div class="dropdown-divider"></div>
        <a class="dropdown-item disabled"><strong>Internet of Things (2020)</strong></a>
        <a class="dropdown-item" href="iot-devices.html">IoT 1: Programming Devices</a>
        <a class="dropdown-item" href="iot-stm.html">IoT 2: State Machines</a>
        <a class="dropdown-item" href="iot-http-json-2020.html">IoT 3: HTTP and JSON</a>
        <a class="dropdown-item" href="iot-http-json-2020-solution.html">IoT 3: HTTP and JSON (Solution and Revised Tasks)</a>
        <a class="dropdown-item" href="iot-mqtt-chat.html">IoT 4: MQTT Chat</a>
        <!--
        <a class="dropdown-item" href="iot-lopy.html">LoPy</a>
        <a class="dropdown-item" href="iot-mqtt.html">MQTT</a>
        <a class="dropdown-item" href="iot-lorawan.html">LoRaWAN / NB-IoT</a>
        <a class="dropdown-item" href="iot-api.html">API</a>-->
      </div>
  </li>
  
  <li class="nav-item dropdown">
    <a class="nav-link dropdown-toggle" data-toggle="dropdown" href="#" role="button" aria-haspopup="true" aria-expanded="false">Extra</a>
    <div class="dropdown-menu">
      <a class="dropdown-item disabled"><strong>Learning</strong></a>
      <a class="dropdown-item" href="learning-rats.html">RATs</a>
      <a class="dropdown-item" href="feedback.html">Tilbakemelding</a>
      <a class="dropdown-item" href="reports.html">Rapporter</a>
      <a class="dropdown-item" href="teams.html">Teams</a>
      <a class="dropdown-item" href="working-in-teams.html">Working in Teams</a>
      <a class="dropdown-item" href="tools.html">Learning Tools</a>
      <div class="dropdown-divider"></div>
      <a class="dropdown-item disabled"><strong>Material</strong></a>
      <a class="dropdown-item" href="commands-help.html">Help on Commands</a>
      <a class="dropdown-item" href="commands.html">List of Commands</a>
      <a class="dropdown-item" href="computer-history.html">Extra Videos</a>
      <div class="dropdown-divider"></div>
      <a class="dropdown-item disabled"><strong>Tools</strong></a>
      <a class="dropdown-item" href="virtual-box-mac.html">Virtual Box for Mac</a>
      <a class="dropdown-item" href="virtual-box-win.html">Virtual Box for Windows</a>
      <a class="dropdown-item" href="shell-mac.html">Terminal and SSH on Mac</a>
      <a class="dropdown-item" href="shell-win.html">Terminal and SSH on Windows</a>
    </div>
  </li>
  
  <!--
  <li class="nav-item">
    <a class="nav-link" href="#">Blackboard</a>
  </li>-->
</ul>

<div class="navbar-nav flex-row ml-md-auto d-none d-md-flex"></div>
             <a class="navbar-brand" href="https://ntnu.edu">
      	<svg width="100" height="30">
      		<image xlink:href="https://innsida.ntnu.no/innsida-theme/images/ntnu-graphics/ntnu_logo_white.svg" 
      		src="https://innsida.ntnu.no/innsida-theme/images/ntnu-graphics/ntnu_logo_white.png" width="100%" height="100%"></image>
      	</svg>
      </a>
    </nav>


<div class="page">
    </section>
    <section class="content">
<h1 id="temperature-sensor-system">Temperature Sensor System</h1>
<p>In this (a little bit artificial) example, we want to create a temperature sensor that delivers its measurements tp a web server, so we can check the temperature from a web browser. In addition, the web site should also show the air temperature forecast for the location from Yr. This is what our system looks like:</p>
<div class="figure">
<img src="figures/http/smart-home.png" width="100%"/>
</div>
<p>It should work in the following steps:</p>
<ol type="1">
<li><p>The temperature sensor sends its measured temperature with a HTTP <code>POST</code> request to the server. In our example, we do this only once, but in a real system the sensor would measure the temperature from a real sensor and then periodically send the temperature.</p></li>
<li><p>A web browser makes an HTTP <code>GET</code> request to the server, because we want to read the temperature.</p></li>
<li><p>To answer the request from the browser, the web server makes itself a request to Yr.no to figure out the air temperature.</p></li>
<li><p>The web server then combines the temperature sent before from the sensor (via the <code>POST</code> request), combines it with the result of the request to Yr.no, and answer the browser with a HTML page that shows both temperatures.</p></li>
</ol>
    </section>
    <section class="content">
<h1 id="code-for-the-sensor">Code for the Sensor</h1>
<p>As said, our program for the sensor just imitates how a real sensor would work. Here we just write the temperature fixed, and only send a single update instead of doing it periodically.</p>
<p>Store the following file in a file <code>sensor.py</code>.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true"></a><span class="im">import</span> requests</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true"></a><span class="im">import</span> json</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true"></a><span class="im">from</span> urllib.parse <span class="im">import</span> quote, unquote</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true"></a><span class="kw">def</span> dictionary_to_string(dictionary):</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true"></a>    <span class="cf">return</span> json.dumps(dictionary)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true"></a></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true"></a><span class="kw">def</span> encode_string_into_url(string):</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true"></a>    <span class="cf">return</span> quote(string)</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true"></a></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true"></a></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true"></a><span class="kw">def</span> print_response(response):</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true"></a>    <span class="bu">print</span>(<span class="st">&quot;-------- Response --------&quot;</span>)</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true"></a>    <span class="bu">print</span>(<span class="st">&quot;Status code: </span><span class="sc">{}</span><span class="st">&quot;</span>.<span class="bu">format</span>(response.status_code))</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true"></a>    <span class="bu">print</span>(<span class="st">&quot;-------- Content--------&quot;</span>)</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true"></a>    <span class="bu">print</span>(response.text)</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true"></a>    <span class="bu">print</span>(<span class="st">&quot;------------------------&quot;</span>)</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true"></a></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true"></a></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true"></a><span class="co"># example data</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true"></a>dictionary <span class="op">=</span> {}</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true"></a>dictionary[<span class="st">&quot;temperature&quot;</span>] <span class="op">=</span> <span class="fl">20.0</span></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true"></a></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true"></a>data <span class="op">=</span> dictionary_to_string(dictionary)</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true"></a><span class="bu">print</span>(data)</span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true"></a></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true"></a>data <span class="op">=</span> encode_string_into_url(data)</span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true"></a><span class="bu">print</span>(data)</span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true"></a></span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true"></a>response <span class="op">=</span> requests.post(<span class="st">&quot;http://localhost:8023/?data=</span><span class="sc">{}</span><span class="st">&quot;</span>.<span class="bu">format</span>(data))</span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true"></a>print_response(response)</span></code></pre></div>
    </section>
    <section class="content">
<h1 id="code-for-the-server">Code for the Server</h1>
<p>The code for the server is longer, because it handles the <code>POST</code> request from the sensor, makes a <code>GET</code> request to Yr.no, and answers a <code>GET</code> request from a browser.</p>
<p>Stor it in a file called <code>webserver.py</code>.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true"></a><span class="im">from</span> http.server <span class="im">import</span> HTTPServer, BaseHTTPRequestHandler</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true"></a><span class="im">from</span> urllib.parse <span class="im">import</span> quote, unquote</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true"></a><span class="im">import</span> json</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true"></a><span class="im">import</span> socket</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true"></a><span class="im">import</span> requests</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true"></a><span class="kw">def</span> extract_json_string(string):</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true"></a>    start <span class="op">=</span> string.find(<span class="st">&quot;{&quot;</span>)</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true"></a>    stop <span class="op">=</span> string.rfind(<span class="st">&quot;}&quot;</span>)</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true"></a>    <span class="cf">return</span> string[start : stop <span class="op">+</span> <span class="dv">1</span>]</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true"></a></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true"></a></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true"></a><span class="kw">def</span> get_ip_address():</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true"></a>    <span class="cf">return</span> socket.gethostbyname(socket.gethostname())</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true"></a></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true"></a></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true"></a><span class="kw">def</span> dictionary_to_string(dictionary):</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true"></a>    <span class="cf">return</span> json.dumps(dictionary)</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true"></a></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true"></a></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true"></a><span class="kw">def</span> json_string_to_dictionary(json_string):</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true"></a>    <span class="cf">return</span> json.loads(json_string)</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true"></a></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true"></a></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true"></a><span class="kw">def</span> encode_string_into_url(string):</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true"></a>    <span class="cf">return</span> quote(string)</span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true"></a></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true"></a></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true"></a><span class="kw">def</span> decode_url_back_to_string(url_encoded_string):</span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true"></a>    <span class="cf">return</span> unquote(url_encoded_string)</span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true"></a></span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true"></a></span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true"></a><span class="kw">def</span> string_to_unicode_bytes(string):</span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true"></a>    <span class="cf">return</span> string.encode(<span class="st">&quot;utf-8&quot;</span>)</span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true"></a></span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true"></a></span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true"></a>places <span class="op">=</span> {</span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true"></a>    <span class="st">&quot;Trondheim&quot;</span>: {<span class="st">&quot;lat&quot;</span>: <span class="fl">63.43</span>, <span class="st">&quot;lon&quot;</span>: <span class="fl">10.39</span>},</span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true"></a>    <span class="st">&quot;Oslo&quot;</span>: {<span class="st">&quot;lat&quot;</span>: <span class="fl">59.91</span>, <span class="st">&quot;lon&quot;</span>: <span class="fl">10.75</span>},</span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true"></a>    <span class="st">&quot;Bergen&quot;</span>: {<span class="st">&quot;lat&quot;</span>: <span class="fl">60.39</span>, <span class="st">&quot;lon&quot;</span>: <span class="fl">5.32</span>},</span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true"></a>    <span class="st">&quot;Avaldsnes&quot;</span>: {<span class="st">&quot;lat&quot;</span>: <span class="fl">59.35</span>, <span class="st">&quot;lon&quot;</span>: <span class="fl">5.27</span>},</span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true"></a>    <span class="st">&quot;Troms√∏&quot;</span>: {<span class="st">&quot;lat&quot;</span>: <span class="fl">69.64</span>, <span class="st">&quot;lon&quot;</span>: <span class="fl">18.95</span>},</span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true"></a>}</span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true"></a></span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true"></a></span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true"></a><span class="kw">def</span> get_air_temp_2(place):</span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true"></a>    coordinates <span class="op">=</span> places[place]</span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true"></a>    url <span class="op">=</span> <span class="st">&quot;https://api.met.no/weatherapi/locationforecast/2.0/compact?lat=</span><span class="sc">{}</span><span class="st">&amp;lon=</span><span class="sc">{}</span><span class="st">&quot;</span>.<span class="bu">format</span>(</span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true"></a>        coordinates[<span class="st">&quot;lat&quot;</span>], coordinates[<span class="st">&quot;lon&quot;</span>]</span>
<span id="cb1-51"><a href="#cb1-51" aria-hidden="true"></a>    )</span>
<span id="cb1-52"><a href="#cb1-52" aria-hidden="true"></a>    response <span class="op">=</span> requests.get(url)</span>
<span id="cb1-53"><a href="#cb1-53" aria-hidden="true"></a>    <span class="cf">return</span> response.json()[<span class="st">&quot;properties&quot;</span>][<span class="st">&quot;timeseries&quot;</span>][<span class="op">-</span><span class="dv">1</span>][<span class="st">&quot;data&quot;</span>][<span class="st">&quot;instant&quot;</span>][</span>
<span id="cb1-54"><a href="#cb1-54" aria-hidden="true"></a>        <span class="st">&quot;details&quot;</span></span>
<span id="cb1-55"><a href="#cb1-55" aria-hidden="true"></a>    ][<span class="st">&quot;air_temperature&quot;</span>]</span>
<span id="cb1-56"><a href="#cb1-56" aria-hidden="true"></a></span>
<span id="cb1-57"><a href="#cb1-57" aria-hidden="true"></a></span>
<span id="cb1-58"><a href="#cb1-58" aria-hidden="true"></a><span class="kw">def</span> generate_html_page(title, local_temperature, air_temperature, place):</span>
<span id="cb1-59"><a href="#cb1-59" aria-hidden="true"></a>    lines <span class="op">=</span> []</span>
<span id="cb1-60"><a href="#cb1-60" aria-hidden="true"></a>    lines.append(<span class="st">&quot;&lt;html&gt;&quot;</span>)</span>
<span id="cb1-61"><a href="#cb1-61" aria-hidden="true"></a>    lines.append(<span class="st">&quot;    &lt;head&gt;&lt;title&gt;</span><span class="sc">{}</span><span class="st">&lt;/title&gt;&lt;/head&gt;&quot;</span>.<span class="bu">format</span>(title))</span>
<span id="cb1-62"><a href="#cb1-62" aria-hidden="true"></a>    lines.append(<span class="st">&quot;    &lt;body&gt;&quot;</span>)</span>
<span id="cb1-63"><a href="#cb1-63" aria-hidden="true"></a>    lines.append(</span>
<span id="cb1-64"><a href="#cb1-64" aria-hidden="true"></a>        <span class="st">&quot;        &lt;p&gt;Local temperature </span><span class="sc">{}</span><span class="st">: &lt;b&gt;</span><span class="sc">{}</span><span class="st"> C&lt;/b&gt;&lt;/p&gt;&quot;</span>.<span class="bu">format</span>(</span>
<span id="cb1-65"><a href="#cb1-65" aria-hidden="true"></a>            place, local_temperature</span>
<span id="cb1-66"><a href="#cb1-66" aria-hidden="true"></a>        )</span>
<span id="cb1-67"><a href="#cb1-67" aria-hidden="true"></a>    )</span>
<span id="cb1-68"><a href="#cb1-68" aria-hidden="true"></a>    lines.append(<span class="st">&quot;        &lt;p&gt;Temperature: &lt;b&gt;</span><span class="sc">{}</span><span class="st"> C&lt;/b&gt;&lt;/p&gt;&quot;</span>.<span class="bu">format</span>(air_temperature))</span>
<span id="cb1-69"><a href="#cb1-69" aria-hidden="true"></a>    lines.append(<span class="st">&quot;    &lt;/body&gt;&quot;</span>)</span>
<span id="cb1-70"><a href="#cb1-70" aria-hidden="true"></a>    lines.append(<span class="st">&quot;&lt;/html&gt;&quot;</span>)</span>
<span id="cb1-71"><a href="#cb1-71" aria-hidden="true"></a>    <span class="cf">return</span> <span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>.join(lines)</span>
<span id="cb1-72"><a href="#cb1-72" aria-hidden="true"></a></span>
<span id="cb1-73"><a href="#cb1-73" aria-hidden="true"></a></span>
<span id="cb1-74"><a href="#cb1-74" aria-hidden="true"></a><span class="kw">class</span> RequestHandler(BaseHTTPRequestHandler):</span>
<span id="cb1-75"><a href="#cb1-75" aria-hidden="true"></a>    <span class="kw">def</span> store_data(<span class="va">self</span>, name, data):</span>
<span id="cb1-76"><a href="#cb1-76" aria-hidden="true"></a>        <span class="cf">if</span> <span class="kw">not</span> <span class="bu">hasattr</span>(<span class="va">self</span>.server, <span class="st">&quot;data&quot;</span>):</span>
<span id="cb1-77"><a href="#cb1-77" aria-hidden="true"></a>            <span class="va">self</span>.server.data <span class="op">=</span> {}</span>
<span id="cb1-78"><a href="#cb1-78" aria-hidden="true"></a>        <span class="va">self</span>.server.data[name] <span class="op">=</span> data</span>
<span id="cb1-79"><a href="#cb1-79" aria-hidden="true"></a></span>
<span id="cb1-80"><a href="#cb1-80" aria-hidden="true"></a>    <span class="kw">def</span> load_data(<span class="va">self</span>, name):</span>
<span id="cb1-81"><a href="#cb1-81" aria-hidden="true"></a>        <span class="cf">if</span> <span class="bu">hasattr</span>(<span class="va">self</span>.server, <span class="st">&quot;data&quot;</span>):</span>
<span id="cb1-82"><a href="#cb1-82" aria-hidden="true"></a>            <span class="cf">if</span> name <span class="kw">in</span> <span class="va">self</span>.server.data:</span>
<span id="cb1-83"><a href="#cb1-83" aria-hidden="true"></a>                <span class="cf">return</span> <span class="va">self</span>.server.data[name]</span>
<span id="cb1-84"><a href="#cb1-84" aria-hidden="true"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb1-85"><a href="#cb1-85" aria-hidden="true"></a></span>
<span id="cb1-86"><a href="#cb1-86" aria-hidden="true"></a>    <span class="kw">def</span> do_POST(<span class="va">self</span>):</span>
<span id="cb1-87"><a href="#cb1-87" aria-hidden="true"></a>        <span class="co">&quot;&quot;&quot;HTTP POST request as it comes from the sensor device application,</span></span>
<span id="cb1-88"><a href="#cb1-88" aria-hidden="true"></a><span class="co">        for instance to send the current temerature.&quot;&quot;&quot;</span></span>
<span id="cb1-89"><a href="#cb1-89" aria-hidden="true"></a></span>
<span id="cb1-90"><a href="#cb1-90" aria-hidden="true"></a>        <span class="bu">print</span>(<span class="st">&quot;-------- Incoming POST request --------&quot;</span>)</span>
<span id="cb1-91"><a href="#cb1-91" aria-hidden="true"></a>        <span class="bu">print</span>(<span class="st">&quot;  Request data: </span><span class="sc">{}</span><span class="st">&quot;</span>.<span class="bu">format</span>(<span class="va">self</span>.requestline))</span>
<span id="cb1-92"><a href="#cb1-92" aria-hidden="true"></a></span>
<span id="cb1-93"><a href="#cb1-93" aria-hidden="true"></a>        decoded_request <span class="op">=</span> decode_url_back_to_string(<span class="va">self</span>.requestline)</span>
<span id="cb1-94"><a href="#cb1-94" aria-hidden="true"></a>        <span class="bu">print</span>(<span class="st">&quot;  Decoded data: </span><span class="sc">{}</span><span class="st">&quot;</span>.<span class="bu">format</span>(decoded_request))</span>
<span id="cb1-95"><a href="#cb1-95" aria-hidden="true"></a></span>
<span id="cb1-96"><a href="#cb1-96" aria-hidden="true"></a>        json_string <span class="op">=</span> extract_json_string(decoded_request)</span>
<span id="cb1-97"><a href="#cb1-97" aria-hidden="true"></a>        <span class="bu">print</span>(<span class="st">&quot;  Extracted JSON string: </span><span class="sc">{}</span><span class="st">&quot;</span>.<span class="bu">format</span>(json_string))</span>
<span id="cb1-98"><a href="#cb1-98" aria-hidden="true"></a></span>
<span id="cb1-99"><a href="#cb1-99" aria-hidden="true"></a>        dictionary <span class="op">=</span> json_string_to_dictionary(json_string)</span>
<span id="cb1-100"><a href="#cb1-100" aria-hidden="true"></a>        <span class="bu">print</span>(dictionary)</span>
<span id="cb1-101"><a href="#cb1-101" aria-hidden="true"></a></span>
<span id="cb1-102"><a href="#cb1-102" aria-hidden="true"></a>        <span class="co"># We extract the temperature...</span></span>
<span id="cb1-103"><a href="#cb1-103" aria-hidden="true"></a>        temperature <span class="op">=</span> dictionary[<span class="st">&quot;temperature&quot;</span>]</span>
<span id="cb1-104"><a href="#cb1-104" aria-hidden="true"></a>        <span class="co"># ...and store it</span></span>
<span id="cb1-105"><a href="#cb1-105" aria-hidden="true"></a>        <span class="va">self</span>.store_data(<span class="st">&quot;temperature&quot;</span>, temperature)</span>
<span id="cb1-106"><a href="#cb1-106" aria-hidden="true"></a></span>
<span id="cb1-107"><a href="#cb1-107" aria-hidden="true"></a>        <span class="co"># Phase 2: Which data do we want to send back?</span></span>
<span id="cb1-108"><a href="#cb1-108" aria-hidden="true"></a>        response <span class="op">=</span> <span class="st">&quot;ok&quot;</span></span>
<span id="cb1-109"><a href="#cb1-109" aria-hidden="true"></a></span>
<span id="cb1-110"><a href="#cb1-110" aria-hidden="true"></a>        <span class="co"># Phase 3: Let&#39;s send back the data!</span></span>
<span id="cb1-111"><a href="#cb1-111" aria-hidden="true"></a>        response_in_bytes <span class="op">=</span> string_to_unicode_bytes(response)</span>
<span id="cb1-112"><a href="#cb1-112" aria-hidden="true"></a>        <span class="va">self</span>.send_response(<span class="dv">200</span>)</span>
<span id="cb1-113"><a href="#cb1-113" aria-hidden="true"></a>        <span class="va">self</span>.send_header(<span class="st">&quot;Content-type&quot;</span>, <span class="st">&quot;text/plain&quot;</span>)</span>
<span id="cb1-114"><a href="#cb1-114" aria-hidden="true"></a>        <span class="va">self</span>.end_headers()</span>
<span id="cb1-115"><a href="#cb1-115" aria-hidden="true"></a>        <span class="va">self</span>.wfile.write(response_in_bytes)</span>
<span id="cb1-116"><a href="#cb1-116" aria-hidden="true"></a></span>
<span id="cb1-117"><a href="#cb1-117" aria-hidden="true"></a>    <span class="kw">def</span> do_GET(<span class="va">self</span>):</span>
<span id="cb1-118"><a href="#cb1-118" aria-hidden="true"></a>        <span class="co"># Phase 1: What has been requested?</span></span>
<span id="cb1-119"><a href="#cb1-119" aria-hidden="true"></a>        <span class="bu">print</span>(<span class="st">&quot;-------- Incoming GET request --------&quot;</span>)</span>
<span id="cb1-120"><a href="#cb1-120" aria-hidden="true"></a>        <span class="bu">print</span>(<span class="st">&quot;  Request data: </span><span class="sc">{}</span><span class="st">&quot;</span>.<span class="bu">format</span>(<span class="va">self</span>.requestline))</span>
<span id="cb1-121"><a href="#cb1-121" aria-hidden="true"></a></span>
<span id="cb1-122"><a href="#cb1-122" aria-hidden="true"></a>        decoded_request <span class="op">=</span> decode_url_back_to_string(<span class="va">self</span>.requestline)</span>
<span id="cb1-123"><a href="#cb1-123" aria-hidden="true"></a>        <span class="bu">print</span>(<span class="st">&quot;  Decoded data: </span><span class="sc">{}</span><span class="st">&quot;</span>.<span class="bu">format</span>(decoded_request))</span>
<span id="cb1-124"><a href="#cb1-124" aria-hidden="true"></a></span>
<span id="cb1-125"><a href="#cb1-125" aria-hidden="true"></a>        json_string <span class="op">=</span> extract_json_string(decoded_request)</span>
<span id="cb1-126"><a href="#cb1-126" aria-hidden="true"></a>        <span class="bu">print</span>(<span class="st">&quot;  Extracted JSON string: </span><span class="sc">{}</span><span class="st">&quot;</span>.<span class="bu">format</span>(json_string))</span>
<span id="cb1-127"><a href="#cb1-127" aria-hidden="true"></a></span>
<span id="cb1-128"><a href="#cb1-128" aria-hidden="true"></a>        dictionary <span class="op">=</span> json_string_to_dictionary(json_string)</span>
<span id="cb1-129"><a href="#cb1-129" aria-hidden="true"></a>        <span class="bu">print</span>(dictionary)</span>
<span id="cb1-130"><a href="#cb1-130" aria-hidden="true"></a></span>
<span id="cb1-131"><a href="#cb1-131" aria-hidden="true"></a>        place <span class="op">=</span> dictionary[<span class="st">&quot;place&quot;</span>]</span>
<span id="cb1-132"><a href="#cb1-132" aria-hidden="true"></a></span>
<span id="cb1-133"><a href="#cb1-133" aria-hidden="true"></a>        air_temperature <span class="op">=</span> get_air_temp_2(place)</span>
<span id="cb1-134"><a href="#cb1-134" aria-hidden="true"></a>        local_temperature <span class="op">=</span> <span class="va">self</span>.load_data(<span class="st">&quot;temperature&quot;</span>)</span>
<span id="cb1-135"><a href="#cb1-135" aria-hidden="true"></a></span>
<span id="cb1-136"><a href="#cb1-136" aria-hidden="true"></a>        <span class="co"># Phase 2: Which data do we want to send back?</span></span>
<span id="cb1-137"><a href="#cb1-137" aria-hidden="true"></a>        response <span class="op">=</span> generate_html_page(</span>
<span id="cb1-138"><a href="#cb1-138" aria-hidden="true"></a>            <span class="st">&quot;Temperature&quot;</span>, local_temperature, air_temperature, place</span>
<span id="cb1-139"><a href="#cb1-139" aria-hidden="true"></a>        )</span>
<span id="cb1-140"><a href="#cb1-140" aria-hidden="true"></a></span>
<span id="cb1-141"><a href="#cb1-141" aria-hidden="true"></a>        <span class="co"># Phase 3: Let&#39;s send back the data!</span></span>
<span id="cb1-142"><a href="#cb1-142" aria-hidden="true"></a>        response_in_bytes <span class="op">=</span> string_to_unicode_bytes(response)</span>
<span id="cb1-143"><a href="#cb1-143" aria-hidden="true"></a>        <span class="va">self</span>.send_response(<span class="dv">200</span>)</span>
<span id="cb1-144"><a href="#cb1-144" aria-hidden="true"></a>        <span class="va">self</span>.send_header(<span class="st">&quot;Content-type&quot;</span>, <span class="st">&quot;text/html&quot;</span>)</span>
<span id="cb1-145"><a href="#cb1-145" aria-hidden="true"></a>        <span class="va">self</span>.end_headers()</span>
<span id="cb1-146"><a href="#cb1-146" aria-hidden="true"></a>        <span class="va">self</span>.wfile.write(response_in_bytes)</span>
<span id="cb1-147"><a href="#cb1-147" aria-hidden="true"></a></span>
<span id="cb1-148"><a href="#cb1-148" aria-hidden="true"></a></span>
<span id="cb1-149"><a href="#cb1-149" aria-hidden="true"></a><span class="co"># This just starts the server</span></span>
<span id="cb1-150"><a href="#cb1-150" aria-hidden="true"></a>port <span class="op">=</span> <span class="dv">8023</span></span>
<span id="cb1-151"><a href="#cb1-151" aria-hidden="true"></a>httpd <span class="op">=</span> HTTPServer(</span>
<span id="cb1-152"><a href="#cb1-152" aria-hidden="true"></a>    (<span class="st">&quot;&quot;</span>, port),</span>
<span id="cb1-153"><a href="#cb1-153" aria-hidden="true"></a>    RequestHandler,</span>
<span id="cb1-154"><a href="#cb1-154" aria-hidden="true"></a>)</span>
<span id="cb1-155"><a href="#cb1-155" aria-hidden="true"></a><span class="bu">print</span>(<span class="st">&quot;&quot;</span>)</span>
<span id="cb1-156"><a href="#cb1-156" aria-hidden="true"></a><span class="bu">print</span>(<span class="st">&quot; ******** TTM4175 Web Server  ******** &quot;</span>)</span>
<span id="cb1-157"><a href="#cb1-157" aria-hidden="true"></a><span class="bu">print</span>(</span>
<span id="cb1-158"><a href="#cb1-158" aria-hidden="true"></a>    <span class="st">&quot;    The server will be reachable via  http://</span><span class="sc">{}</span><span class="st">:</span><span class="sc">{}</span><span class="st">/&quot;</span>.<span class="bu">format</span>(get_ip_address(), port)</span>
<span id="cb1-159"><a href="#cb1-159" aria-hidden="true"></a>)</span>
<span id="cb1-160"><a href="#cb1-160" aria-hidden="true"></a><span class="bu">print</span>(<span class="st">&quot;    Terminate the server via Ctrl-C.&quot;</span>)</span>
<span id="cb1-161"><a href="#cb1-161" aria-hidden="true"></a><span class="bu">print</span>(<span class="st">&quot; ************************************* &quot;</span>)</span>
<span id="cb1-162"><a href="#cb1-162" aria-hidden="true"></a><span class="bu">print</span>(<span class="st">&quot;&quot;</span>)</span>
<span id="cb1-163"><a href="#cb1-163" aria-hidden="true"></a>httpd.serve_forever()</span></code></pre></div>
<div class="task"><p>Go through the code of the server, and try to understand what each function achieves. It is maybe not necessary to understand all details, but the coarse task of each line and function.</p></div>
    </section>
    <section class="content">
<h1 id="running-it">Running it</h1>
<p><strong>Step 1: Start the Server</strong></p>
<p>In a terminal window, start the server:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true"></a><span class="ex">python3</span> webserver.py</span></code></pre></div>
<p><strong>Step 2: Start the Sensor</strong></p>
<p>In another terminal window, start the sensor:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true"></a><span class="ex">python3</span> sensor.py</span></code></pre></div>
<p>Observe what happens in the terminal of the server.</p>
<p><strong>Step 3: Request from the Browser</strong></p>
<p>In a web browser, make the following request in the address field:</p>
<pre><code>http://localhost:8023/?data={&quot;place&quot;: &quot;Trondheim&quot;}</code></pre>
    </section>
    <section class="content">
<h1 id="tasks">Tasks</h1>
<div class="task"><p>Run the system as explained above, and document what happens in the terminal and the browser. Show screenshots. Does all work as expected?</p></div>
<p>(The code above should be complete, no changes are necessary.)</p>
<div class="task"><p>Can you get the air temperature for any of the other cities? How?</p></div>
<div class="task"><p>Observe how the address line in the browser changes after you press Enter and request the page. What happens here probably? How does the server take care of this?</p></div>
<div class="task"><p>Look at the functions <code>do_POST()</code> and <code>do_GET()</code> in the server. What do they have in common, and what is different?</p></div>
    </section>
</div>


<footer></footer>
<script>
    anchors.add('h1').add('h2').add('h3');
    anchors.options.visible = 'always';
</script>
</body>
</html>
