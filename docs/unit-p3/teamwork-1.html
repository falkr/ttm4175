<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="">
  <meta name="author" content="">
  <meta name="generator" content="">
  <title>TTM4175</title>
  <link rel="canonical" href="https://edu.iik.ntnu.no">
  <!-- Bootstrap core CSS -->
  <link href="../assets/bootstrap.min.css" rel="stylesheet">
  <!-- Custom styles for this template -->
  <link href="../assets/style-frame.css" rel="stylesheet">
  <link href="../assets/style-fonts.css" rel="stylesheet">
  <link href="../assets/style-code.css" rel="stylesheet">
  <link rel="stylesheet" href="../assets/bootstrap-icons.css">
  <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
    integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
    crossorigin="anonymous"></script>
  <script src="../assets/anchor.js"></script>
  <script src="../assets/clipboard.min.js"></script>
  <style>/* === figure === */
div.figure {
  padding: 20px 0 20px 0;
  width: 100%;
}

div.figurefullwitdth {
  padding: 20px 0 20px 0;
  margin-left: -33px;
  margin-right: -33px;
  width: 100%;
}

figcaption {
  color: #868279;
}

/* === hints === */
.w3collapsible {
  background-color: #f0e9db;
  color: #868279;
  padding: 8px 18px 8px 8px;
  cursor: pointer;
  width: 100%;
  border: none;
  border-radius: 3px 3px 0 0;
  text-align: left;
  outline: none;
  font-size: 15px;
}

.w3active,
.w3collapsible:hover {
  background-color: #f0e9cb;
}

.w3content {
  filter: blur(3px);
  padding: 18px;
  display: block;
  overflow: hidden;
  background-color: #f3f3f3;
  margin-bottom: 15px;
}

</style>
</head>

<body>





  <nav class="navbar navbar-expand-lg navbar shadow-sm">
    <div class="container-fluid">
      <a class="navbar-brand" href="https://ntnu.edu" title="NTNU Homepage">
        <img id="header_logo" alt="NTNU Hjemmeside" width="120"
          src="https://www.ntnu.no/o/ntnu-theme/images/logo_ntnu.svg" height="23">
      </a>

      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavDropdown"
        aria-controls="navbarNavDropdown" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-list"
            viewBox="0 0 16 16">
            <path fill-rule="evenodd"
              d="M2.5 12a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5z" />
          </svg>
        </span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNavDropdown">
        <ul class="navbar-nav">
          <li class="nav-item">
            <a class="nav-link" href="../index.html">TTM4175</a>
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
              Teknostart
            </a>
            <ul class="dropdown-menu dropdown-menu">
              <li><a class="dropdown-item" href="../teknostart/index.html">Teknostart oversikt</a></li>
              <li>
                <div class="dropdown-divider"></div>
              </li>
              <li><a class="dropdown-item" href="../teknostart/day1.html">Teknostart Dag 1</a></li>
              <li><a class="dropdown-item" href="../teknostart/day2.html">Teknostart Dag 2</a></li>
              <li><a class="dropdown-item" href="../teknostart/day3.html">Teknostart Dag 3</a></li>
              <li><a class="dropdown-item" href="../teknostart/day4.html">Teknostart Dag 4</a></li>
            </ul>
          </li>
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
              Units
            </a>
            <ul class="dropdown-menu dropdown-menu">
              <a class="dropdown-item" href="../units.html">Oversikt</a>
              <div class="dropdown-divider"></div>
              <a class="dropdown-item" href="../unit-cli/index.html">Linux CLI</a>
              <a class="dropdown-item" href="../unit-net1/index.html">IPs, LAN</a>
              <a class="dropdown-item" href="../unit-net2/index.html">Ports, Web Servers</a>
              <a class="dropdown-item" href="../unit-net3/index.html">Routing, DNS</a>
              <a class="dropdown-item" href="../unit-p1/index.html">IoT and the Microbit</a>
              <a class="dropdown-item" href="../unit-p2/index.html">State Machines</a>
              <a class="dropdown-item" href="../unit-p3/index.html">HTTP and JSON</a>
              <a class="dropdown-item" href="../unit-p4/index.html">MQTT</a>
            </ul>
          </li>



          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
              Learning
            </a>
            <ul class="dropdown-menu dropdown-menu">
              <li><a class="dropdown-item" href="../learning/learning.html">Læring</a></li>
              <li><a class="dropdown-item" href="../learning/reports.html">Rapporter</a></li>
            </ul>
          </li>
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
              Tools
            </a>
            <ul class="dropdown-menu dropdown-menu">
              <li><a class="dropdown-item" href="../tools/index.html">Tools</a></li>
              <!--<li><a class="dropdown-item" href="../tools/tools-python.html">Python</a></li>-->
              <li><a class="dropdown-item" href="../tools/tools-gui.html">GUIs in Python</a></li>
              <li><a class="dropdown-item" href="../tools/tools-mqtt.html">MQTT</a></li>
              <li><a class="dropdown-item" href="../tools/tools-notebooks.html">Notebooks</a></li>
              <li><a class="dropdown-item" href="../tools/tools-stmpy.html">STMPY</a></li>
            </ul>
          </li>
        </ul>
        <div class="bg-light border ms-auto"></div>
        <div>
          <a class="nav-link" href="../schedule.html"><svg xmlns="http://www.w3.org/2000/svg" width="16"
              height="16" fill="currentColor" class="bi bi-calendar3" viewBox="0 0 16 16">
              <path
                d="M14 0H2a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2zM1 3.857C1 3.384 1.448 3 2 3h12c.552 0 1 .384 1 .857v10.286c0 .473-.448.857-1 .857H2c-.552 0-1-.384-1-.857V3.857z" />
              <path
                d="M6.5 7a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm3 0a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm3 0a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm-9 3a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm3 0a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm3 0a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm3 0a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm-9 3a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm3 0a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm3 0a1 1 0 1 0 0-2 1 1 0 0 0 0 2z" />
            </svg></a>
        </div>
      </div>
    </div>
  </nav>

  <main class="container container-max-width">
    <section class="mt-5 mb-5 py-3">
<div class="row g-0 my-3"><div class="col-md-8 px-4 chunk"><h1>HTTP and JSON</h1>
<p>Today we will use HTTP as communication protocol and JSON as serialization format to send data, from a client to a server and from a server to a client.</p>
</div><aside class="col-md-4 chunk ps-2"></aside></div>
</section>
<section class="mt-5 mb-5 py-3">
<div class="row g-0 my-3"><div class="col-md-8 px-4 chunk"><h1>HTTP Client Requests: Checking the News</h1>
<p>Let us first make a HTTP request for the most common job: requesting the content of a website. Of course, you know what happens when you make a request to <a href="https://www.nrk.no/">https://www.nrk.no/</a> via your browser. But there are other ways you can make such a request.</p>
<h3>Checking the News via Curl</h3>
<p>Use the command line tool `curl to request the website:</p>
</div><aside class="col-md-4 chunk ps-2"></aside></div>
<div class="row g-0 my-3"><div class="col-md-8 px-4 chunk"><div class="source-code-frame mt-3 mb-3">
<pre class="d-none" id="id9df47a">curl --verbose https://www.nrk.no/
</pre>
<button type="button" class="copy-button" data-clipboard-target="#id9df47a">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16">
  		<path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"></path>
  		<path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"></path>
	</svg>
</button>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="ex">curl</span> <span class="at">--verbose</span> https://www.nrk.no/</span></code></pre></div>
</div></div><aside class="col-md-4 chunk ps-2"></aside></div>
<div class="row g-0 my-3"><div class="col-md-8 px-4 chunk"><div class="task"><p>Can you read some of the headlines?</p>
</div></div><aside class="col-md-4 chunk ps-2"></aside></div>
<div class="row g-0 my-3"><div class="col-md-8 px-4 chunk"><div class="task"><p>What happens if you try to use the URL <code>http://www.nrk.no/</code> instead? What does the response say? Can you find out what this response means?</p>
</div></div><aside class="col-md-4 chunk ps-2"></aside></div>
<div class="row g-0 my-3"><div class="col-md-8 px-4 chunk"><h3>Checking the News via Python</h3>
<p>You can make requests also programmatically, that means, as part of a program running in Python. For that, a dedicated package <code>requests</code> exists that lets you make requests and parse the response in a simple way.</p>
<p>Install the requests package:</p>
</div><aside class="col-md-4 chunk ps-2"></aside></div>
<div class="row g-0 my-3"><div class="col-md-8 px-4 chunk"><div class="source-code-frame mt-3 mb-3">
<pre class="d-none" id="idab4771">python3 -m pip install requests
</pre>
<button type="button" class="copy-button" data-clipboard-target="#idab4771">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16">
  		<path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"></path>
  		<path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"></path>
	</svg>
</button>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="ex">python3</span> <span class="at">-m</span> pip install requests</span></code></pre></div>
</div></div><aside class="col-md-4 chunk ps-2"><p>Using <code>pip</code> with the <code>python3 -m</code> prefix prevents that you use a wrong installation of pip in your computer, for instance the one for Python 2.7. By going through Python, you make sure you use the <code>pip</code> installation that also matches your <code>python3</code>. You also don't need to worry about <code>pip3</code> or <code>pip</code>.</p>
</aside></div>
<div class="row g-0 my-3"><div class="col-md-8 px-4 chunk"><p>With this package installed, the program to make a request to a website looks like this:</p>
</div><aside class="col-md-4 chunk ps-2"></aside></div>
<div class="row g-0 my-3"><div class="col-md-8 px-4 chunk"><div class="source-code-frame mt-3 mb-3">
<pre class="d-none" id="id35985b">import requests

url = "https://nrk.no/"
response = requests.get(url)
print(response.text)
</pre>
<button type="button" class="copy-button" data-clipboard-target="#id35985b">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16">
  		<path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"></path>
  		<path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"></path>
	</svg>
</button>
<div class="sourceCode" id="cb1"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> requests</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>url <span class="op">=</span> <span class="st">&quot;https://nrk.no/&quot;</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>response <span class="op">=</span> requests.get(url)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(response.text)</span></code></pre></div>
</div></div><aside class="col-md-4 chunk ps-2"></aside></div>
<div class="row g-0 my-3"><div class="col-md-8 px-4 chunk"><p>The request returns a data structure of the type <a href="https://requests.readthedocs.io/en/latest/api/#requests.Response">Response</a> which contains the answer as a text field, which we simply print out.</p>
</div><aside class="col-md-4 chunk ps-2"></aside></div>
<div class="row g-0 my-3"><div class="col-md-8 px-4 chunk"><div class="task"><p>Have a look at the output, it should be the same as the one obtained with curl.</p>
</div></div><aside class="col-md-4 chunk ps-2"></aside></div>
</section>
<section class="mt-5 mb-5 py-3">
<div class="row g-0 my-3"><div class="col-md-8 px-4 chunk"><h1>HTTP Client Requests: Checking the Weather</h1>
<p>So these were requests to get the content of a website.
But HTTP can also be used in a different way. <a href="Yr.no">Yr.no</a> provides weather information, which most people access either via the website or the mobile app.
Yr also offers an API so that other applications can obtain weather information, that means, they can access the weather forecast without downloading the website.</p>
<p>The API of Yr <a href="https://api.met.no/weatherapi/locationforecast/2.0/documentation#!/data/get_compact">is explained here in detail.</a>.
Select the box that says <code>GET/compact</code>, as shown in the figure below.
This box lets you try out a request, directly from the website.
The required input data are latitude and longitude.
For Trondheim, those are <code>lat=63.43</code> and <code>lon=10.39</code>.</p>
</div><aside class="col-md-4 chunk ps-2"></aside></div>
<div class="row g-0 my-3"><div class="col-md-8 px-4 chunk"><div class="task"><p>Use the API documentation on the website to make a request, and browse through the response you get in the answer box below. Check if you can recognize some of the values and if they are more or less what you expect.</p>
</div></div><aside class="col-md-4 chunk ps-2"></aside></div>
<div class="row g-0 my-3"><div class="col-md-8 px-4 chunk"><figure class="figure">
    <img src="figures/yr-1.png" class="figure-img img-fluid rounded" alt="">
</figure></div><aside class="col-md-4 chunk ps-2"></aside></div>
<div class="row g-0 my-3"><div class="col-md-8 px-4 chunk"><h3>Weather via Curl</h3>
<p>We can also do the same HTTP request from our command line using <code>curl</code>:</p>
</div><aside class="col-md-4 chunk ps-2"></aside></div>
<div class="row g-0 my-3"><div class="col-md-8 px-4 chunk"><div class="source-code-frame mt-3 mb-3">
<pre class="d-none" id="id1935f7">curl 'https://api.met.no/weatherapi/locationforecast/2.0/compact?lat=63.43&lon=10.39'
</pre>
<button type="button" class="copy-button" data-clipboard-target="#id1935f7">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16">
  		<path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"></path>
  		<path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"></path>
	</svg>
</button>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="ex">curl</span> <span class="st">&#39;https://api.met.no/weatherapi/locationforecast/2.0/compact?lat=63.43&amp;lon=10.39&#39;</span></span></code></pre></div>
</div></div><aside class="col-md-4 chunk ps-2"></aside></div>
<div class="row g-0 my-3"><div class="col-md-8 px-4 chunk"><h3>Weather via Python</h3>
<p>Let us use Python again for making the same request, with the requests module as done above.
Find the correct URL from the API website.</p>
</div><aside class="col-md-4 chunk ps-2"></aside></div>
<div class="row g-0 my-3"><div class="col-md-8 px-4 chunk"><button class="w3collapsible">Hint for the code</button>
<div class="w3content">
<pre><code class="language-python">import requests

url = &quot;https://api.met.no/weatherapi/locationforecast/2.0/compact?lat=63.43&amp;lon=10.39&quot;
response = requests.get(url)
print(response.text)
</code></pre>

</div></div><aside class="col-md-4 chunk ps-2"></aside></div>
<div class="row g-0 my-3"><div class="col-md-8 px-4 chunk"><div class="task"><p>Run the code, document the result.</p>
</div></div><aside class="col-md-4 chunk ps-2"></aside></div>
<div class="row g-0 my-3"><div class="col-md-8 px-4 chunk"><p>The Yr API provides its response as a JSON-formatted string. For that reason, we can ask the response to provide us the format in JSON via the function <code>response.json()</code> which you can also print via <code>print(response.json())</code>.</p>
</div><aside class="col-md-4 chunk ps-2"><p>Note that <a href="https://requests.readthedocs.io/en/latest/api/#requests.Response.text">text</a> is a field or variable in the requests object, but <a href="https://requests.readthedocs.io/en/latest/api/#requests.Response.json">json()</a> is a function we call on it, therefore we use the braces.</p>
</aside></div>
<div class="row g-0 my-3"><div class="col-md-8 px-4 chunk"><button class="w3collapsible">Hint for the code</button>
<div class="w3content">
<pre><code class="language-python">import requests

url = &quot;https://api.met.no/weatherapi/locationforecast/2.0/compact?lat=63.43&amp;lon=10.39&quot;
response = requests.get(url)
print(response.json())
</code></pre>

</div></div><aside class="col-md-4 chunk ps-2"></aside></div>
<div class="row g-0 my-3"><div class="col-md-8 px-4 chunk"><p>The requests module has already transformed the JSON-formatted string in to a set of corresponding Python data structures, which consists of dictionaries and lists. When we print these with the normal <code>print()</code> function, the data structure doesn't look very nice, and it is hard to understand how the data is nested. Therefore, Python has a function for printing data in a pretty way:</p>
</div><aside class="col-md-4 chunk ps-2"></aside></div>
<div class="row g-0 my-3"><div class="col-md-8 px-4 chunk"><div class="source-code-frame mt-3 mb-3">
<pre class="d-none" id="ida0f396">from pprint import pprint

# your code...

pprint(response.json())
</pre>
<button type="button" class="copy-button" data-clipboard-target="#ida0f396">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16">
  		<path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"></path>
  		<path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"></path>
	</svg>
</button>
<div class="sourceCode" id="cb1"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pprint <span class="im">import</span> pprint</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co"># your code...</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>pprint(response.json())</span></code></pre></div>
</div></div><aside class="col-md-4 chunk ps-2"></aside></div>
<div class="row g-0 my-3"><div class="col-md-8 px-4 chunk"><p>Notice that we use now the function <code>pprint()</code> instead of <code>print()</code> to print things <em>pretty</em>. Pretty good, huh?</p>
</div><aside class="col-md-4 chunk ps-2"></aside></div>
<div class="row g-0 my-3"><div class="col-md-8 px-4 chunk"><div class="task"><p>Pretty-print the response as JSON structure of dicts and lists, and document a few lines to give an illustration of its structure.</p>
</div></div><aside class="col-md-4 chunk ps-2"></aside></div>
<div class="row g-0 my-3"><div class="col-md-8 px-4 chunk"><button class="w3collapsible">Hint for the code</button>
<div class="w3content">
<pre><code class="language-python">from pprint import pprint
import requests

url = &quot;https://api.met.no/weatherapi/locationforecast/2.0/compact?lat=63.43&amp;lon=10.39&quot;
response = requests.get(url)
pprint(response.json())
</code></pre>

</div></div><aside class="col-md-4 chunk ps-2"></aside></div>
<div class="row g-0 my-3"><div class="col-md-8 px-4 chunk"><h3>Finding the Temperature</h3>
<p>The response provides the current forecast for a location, that means, several hours and even days ahead.
It also contains so-called meta-data which explains details <em>about</em> the data.
These are all useful, but make the structure of the response a bit complex.
For now, we are just interested in the air temperature.</p>
</div><aside class="col-md-4 chunk ps-2"></aside></div>
<div class="row g-0 my-3"><div class="col-md-8 px-4 chunk"><div class="task"><p>Can you find the data field <code>air_temperature</code>?</p>
</div></div><aside class="col-md-4 chunk ps-2"></aside></div>
<div class="row g-0 my-3"><div class="col-md-8 px-4 chunk"><p>When we want to use the temperature in our program, we need to extract it out of this complex structure.</p>
</div><aside class="col-md-4 chunk ps-2"></aside></div>
<div class="row g-0 my-3"><div class="col-md-8 px-4 chunk"><div class="task"><p>Starting from the dictionary you receive with <code>response.json()</code> function, can you navigate to the air temperature that is closest to the current time?</p>
</div></div><aside class="col-md-4 chunk ps-2"></aside></div>
<div class="row g-0 my-3"><div class="col-md-8 px-4 chunk"><div class="tips"><ul>
<li>Work step by step.</li>
<li>Pretty print the structure after each step.</li>
<li>Print the keys of a dictionary using its <code>keys()</code> function, for example <code>response.json().keys()</code>.</li>
<li>Access a field in a dictionary with the square brackets, for instance <code>response.json()['geometry']</code>.</li>
<li>If you find a list, access its first element with <code>list[0]</code> or its last with <code>list[-1]</code>.</li>
</ul>
<p>This can be a bit of a puzzle, but should be no problem in the end.</p>
</div></div><aside class="col-md-4 chunk ps-2"></aside></div>
<div class="row g-0 my-3"><div class="col-md-8 px-4 chunk"><h3>Function for the Temperature</h3>
<p>Using the code above, create a function that takes the latitude and longitude as input arguments and that returns the air temperature at that location. This is how the function should look like:</p>
</div><aside class="col-md-4 chunk ps-2"></aside></div>
<div class="row g-0 my-3"><div class="col-md-8 px-4 chunk"><div class="source-code-frame mt-3 mb-3">
<pre class="d-none" id="idb59126">def get_air_temp(lat, lon):
	# TODO make a request
	# TODO return only the value of the air temperature only
</pre>
<button type="button" class="copy-button" data-clipboard-target="#idb59126">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16">
  		<path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"></path>
  		<path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"></path>
	</svg>
</button>
<div class="sourceCode" id="cb1"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_air_temp(lat, lon):</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># </span><span class="al">TODO</span><span class="co"> make a request</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># </span><span class="al">TODO</span><span class="co"> return only the value of the air temperature only</span></span></code></pre></div>
</div></div><aside class="col-md-4 chunk ps-2"></aside></div>
<div class="row g-0 my-3"><div class="col-md-8 px-4 chunk"><p>Remember that Python lets you create a string that includes variables with the <code>format()</code> function:</p>
</div><aside class="col-md-4 chunk ps-2"></aside></div>
<div class="row g-0 my-3"><div class="col-md-8 px-4 chunk"><div class="source-code-frame mt-3 mb-3">
<pre class="d-none" id="id76675e">lat = ...
lon = ...
url = "https://api.met.no/weatherapi/locationforecast/2.0/compact?lat={}&lon={}".format(lat, lon)
</pre>
<button type="button" class="copy-button" data-clipboard-target="#id76675e">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16">
  		<path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"></path>
  		<path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"></path>
	</svg>
</button>
<div class="sourceCode" id="cb1"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>lat <span class="op">=</span> ...</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>lon <span class="op">=</span> ...</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>url <span class="op">=</span> <span class="st">&quot;https://api.met.no/weatherapi/locationforecast/2.0/compact?lat=</span><span class="sc">{}</span><span class="st">&amp;lon=</span><span class="sc">{}</span><span class="st">&quot;</span>.<span class="bu">format</span>(lat, lon)</span></code></pre></div>
</div></div><aside class="col-md-4 chunk ps-2"></aside></div>
<div class="row g-0 my-3"><div class="col-md-8 px-4 chunk"><p>A newer and more compact way to format strings and integrate variables is using f-strings, where you write the variables directly into curly brackets. (Note the <code>f</code> before the string.)</p>
</div><aside class="col-md-4 chunk ps-2"></aside></div>
<div class="row g-0 my-3"><div class="col-md-8 px-4 chunk"><div class="source-code-frame mt-3 mb-3">
<pre class="d-none" id="idee5d5f">lat = ...
lon = ...
url = f"https://api.met.no/weatherapi/locationforecast/2.0/compact?lat={lat}&lon={lon}"
</pre>
<button type="button" class="copy-button" data-clipboard-target="#idee5d5f">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16">
  		<path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"></path>
  		<path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"></path>
	</svg>
</button>
<div class="sourceCode" id="cb1"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>lat <span class="op">=</span> ...</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>lon <span class="op">=</span> ...</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>url <span class="op">=</span> <span class="ss">f&quot;https://api.met.no/weatherapi/locationforecast/2.0/compact?lat=</span><span class="sc">{</span>lat<span class="sc">}</span><span class="ss">&amp;lon=</span><span class="sc">{</span>lon<span class="sc">}</span><span class="ss">&quot;</span></span></code></pre></div>
</div></div><aside class="col-md-4 chunk ps-2"></aside></div>
<div class="row g-0 my-3"><div class="col-md-8 px-4 chunk"><p>Let's make this a bit more compact for later, so that we store the coordinates of a few places and only have to provide place names.
We can for instance simply code them in a nested dictionary:</p>
</div><aside class="col-md-4 chunk ps-2"></aside></div>
<div class="row g-0 my-3"><div class="col-md-8 px-4 chunk"><div class="source-code-frame mt-3 mb-3">
<pre class="d-none" id="id20fee9">places = {
	"Trondheim": {"lat": 63.43, "lon": 10.39},
	"Oslo": {"lat": 59.91, "lon": 10.75},
	"Bergen": {"lat": 60.39, "lon": 5.32},
	"Avaldsnes": {"lat": 59.35, "lon": 5.27},
	"Tromsø": {"lat": 69.64, "lon": 18.95},
}
</pre>
<button type="button" class="copy-button" data-clipboard-target="#id20fee9">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16">
  		<path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"></path>
  		<path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"></path>
	</svg>
</button>
<div class="sourceCode" id="cb1"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>places <span class="op">=</span> {</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;Trondheim&quot;</span>: {<span class="st">&quot;lat&quot;</span>: <span class="fl">63.43</span>, <span class="st">&quot;lon&quot;</span>: <span class="fl">10.39</span>},</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;Oslo&quot;</span>: {<span class="st">&quot;lat&quot;</span>: <span class="fl">59.91</span>, <span class="st">&quot;lon&quot;</span>: <span class="fl">10.75</span>},</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;Bergen&quot;</span>: {<span class="st">&quot;lat&quot;</span>: <span class="fl">60.39</span>, <span class="st">&quot;lon&quot;</span>: <span class="fl">5.32</span>},</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;Avaldsnes&quot;</span>: {<span class="st">&quot;lat&quot;</span>: <span class="fl">59.35</span>, <span class="st">&quot;lon&quot;</span>: <span class="fl">5.27</span>},</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;Tromsø&quot;</span>: {<span class="st">&quot;lat&quot;</span>: <span class="fl">69.64</span>, <span class="st">&quot;lon&quot;</span>: <span class="fl">18.95</span>},</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
</div></div><aside class="col-md-4 chunk ps-2"></aside></div>
<div class="row g-0 my-3"><div class="col-md-8 px-4 chunk"><p>With this dictionary declared globally in the file (above any function definitions), create a new version of the function to compare the air temperature:</p>
</div><aside class="col-md-4 chunk ps-2"></aside></div>
<div class="row g-0 my-3"><div class="col-md-8 px-4 chunk"><div class="source-code-frame mt-3 mb-3">
<pre class="d-none" id="ided1bda">def get_air_temp_2(place):
	# create the function
</pre>
<button type="button" class="copy-button" data-clipboard-target="#ided1bda">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16">
  		<path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"></path>
  		<path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"></path>
	</svg>
</button>
<div class="sourceCode" id="cb1"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_air_temp_2(place):</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># create the function</span></span></code></pre></div>
</div></div><aside class="col-md-4 chunk ps-2"></aside></div>
<div class="row g-0 my-3"><div class="col-md-8 px-4 chunk"><p>Fantastic---we now have a compact function that gets the temperature forecast from Yr so we can use it later in our application. We'll come back to it.</p>
</div><aside class="col-md-4 chunk ps-2"></aside></div>
</section>
<section class="mt-5 mb-5 py-3">
<div class="row g-0 my-3"><div class="col-md-8 px-4 chunk"><h1>Smart Temperature Sensor</h1>
<p>We now want to create a system that combines HTTP requests to create a more advanced temperature display.
Instead of just showing the local temperature of a sensor, it should also show the predicted temperature.
Below is a figure of the setup:</p>
</div><aside class="col-md-4 chunk ps-2"></aside></div>
<div class="row g-0 my-3"><div class="col-md-8 px-4 chunk"><figure class="figure">
    <img src="figures/smart-home.png" class="figure-img img-fluid rounded" alt="">
</figure></div><aside class="col-md-4 chunk ps-2"></aside></div>
<div class="row g-0 my-3"><div class="col-md-8 px-4 chunk"><ul>
<li>The sensor periodically measures its temperature and provides it to the server in the center, using HTTP POST requests.</li>
<li>The server stores the temperature of the temperature sensor, and periodically requests the temperature forecast from the API from <a href="yr.no">yr.no</a> via HTTP GET requests.</li>
<li>The server also answers GET requests from clients to present both the sensor temperature and the prediction from <a href="yr.no">yr.no</a> in a single page.</li>
</ul>
</div><aside class="col-md-4 chunk ps-2"></aside></div>
<div class="row g-0 my-3"><div class="col-md-8 px-4 chunk"><div class="task"><p>Create a sequence diagram with three components: temperature sensor, the server, Yr and the mobile client. Illustrate with the sequence diagram how the temperature sensor updates the server with the measured temperature, and how the mobile client makes a request to our server, which also involves getting the temperature forecast from Yr.</p>
</div></div><aside class="col-md-4 chunk ps-2"></aside></div>
<div class="row g-0 my-3"><div class="col-md-8 px-4 chunk"><h2>Code for the Web Server</h2>
<p>Above we have <strong>initiated HTTP requests as clients</strong> to get news and weather, and combined two weather requests to a little program.
Now we want to also build a web server so that we can <strong>accept HTTP requests and answer them</strong>. As you have learned in the preparation, HTTP is not a symmetric protocol; client and server work very differently.
The code for the server handling a requests therefore also works very differently from the one making a request.</p>
<p>Copy the following code into a file <code>webserver.py</code>. The code declares some functions, and then a class <code>RequestHandler</code>, which defines a web server. It then configures and starts this web server, which is then active and waits for GET requests.</p>
</div><aside class="col-md-4 chunk ps-2"></aside></div>
<div class="row g-0 my-3"><div class="col-md-8 px-4 chunk"><div class="source-code-frame mt-3 mb-3">
<pre class="d-none" id="ideabf42">from http.server import HTTPServer, BaseHTTPRequestHandler
from urllib.parse import quote, unquote
import json
import socket


def extract_json_string(string):
	start = string.find("{")
	stop = string.rfind("}")
	return string[start : stop + 1]


def get_ip_address():
	return socket.gethostbyname(socket.gethostname())


def dictionary_to_string(dictionary):
	return json.dumps(dictionary)


def json_string_to_dictionary(json_string):
	return json.loads(json_string)


def encode_string_into_url(string):
	return quote(string)


def decode_url_back_to_string(url_encoded_string):
	return unquote(url_encoded_string)


def string_to_unicode_bytes(string):
	return string.encode("utf-8")


class RequestHandler(BaseHTTPRequestHandler):
	def store_data(self, name, data):
		if not hasattr(self.server, "data"):
			self.server.data = {}
		self.server.data[name] = data

	def load_data(self, name):
		if hasattr(self.server, "data"):
			if name in self.server.data:
				return self.server.data[name]
		return None

	def do_GET(self):
		# Phase 1: What has been requested?
		print("-------- Incoming GET request --------")
		print("  Request data: {}".format(self.requestline))

		# Phase 2: Which data do we want to send back?
		response = "Hei hei"

		# Phase 3: Let's send back the data!
		response_in_bytes = string_to_unicode_bytes(response)
		self.send_response(200)
		self.send_header("Content-type", "text/plain")
		self.end_headers()
		self.wfile.write(response_in_bytes)


port = 8023
httpd = HTTPServer(
	("", port),
	RequestHandler,
)
print("")
print(" ******** TTM4175 Web Server  ******** ")
print(
	"    The server will be reachable via  http://{}:{}/".format(get_ip_address(), port)
)
print("    Terminate the server via Ctrl-C.")
print(" ************************************* ")
print("")
httpd.serve_forever()
</pre>
<button type="button" class="copy-button" data-clipboard-target="#ideabf42">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16">
  		<path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"></path>
  		<path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"></path>
	</svg>
</button>
<div class="sourceCode" id="cb1"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> http.server <span class="im">import</span> HTTPServer, BaseHTTPRequestHandler</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> urllib.parse <span class="im">import</span> quote, unquote</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> socket</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> extract_json_string(string):</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>    start <span class="op">=</span> string.find(<span class="st">&quot;{&quot;</span>)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>    stop <span class="op">=</span> string.rfind(<span class="st">&quot;}&quot;</span>)</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> string[start : stop <span class="op">+</span> <span class="dv">1</span>]</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_ip_address():</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> socket.gethostbyname(socket.gethostname())</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> dictionary_to_string(dictionary):</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> json.dumps(dictionary)</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> json_string_to_dictionary(json_string):</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> json.loads(json_string)</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> encode_string_into_url(string):</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> quote(string)</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> decode_url_back_to_string(url_encoded_string):</span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> unquote(url_encoded_string)</span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> string_to_unicode_bytes(string):</span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> string.encode(<span class="st">&quot;utf-8&quot;</span>)</span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> RequestHandler(BaseHTTPRequestHandler):</span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> store_data(<span class="va">self</span>, name, data):</span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> <span class="bu">hasattr</span>(<span class="va">self</span>.server, <span class="st">&quot;data&quot;</span>):</span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.server.data <span class="op">=</span> {}</span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.server.data[name] <span class="op">=</span> data</span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> load_data(<span class="va">self</span>, name):</span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">hasattr</span>(<span class="va">self</span>.server, <span class="st">&quot;data&quot;</span>):</span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> name <span class="kw">in</span> <span class="va">self</span>.server.data:</span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="va">self</span>.server.data[name]</span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> do_GET(<span class="va">self</span>):</span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Phase 1: What has been requested?</span></span>
<span id="cb1-51"><a href="#cb1-51" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;-------- Incoming GET request --------&quot;</span>)</span>
<span id="cb1-52"><a href="#cb1-52" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;  Request data: </span><span class="sc">{}</span><span class="st">&quot;</span>.<span class="bu">format</span>(<span class="va">self</span>.requestline))</span>
<span id="cb1-53"><a href="#cb1-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-54"><a href="#cb1-54" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Phase 2: Which data do we want to send back?</span></span>
<span id="cb1-55"><a href="#cb1-55" aria-hidden="true" tabindex="-1"></a>        response <span class="op">=</span> <span class="st">&quot;Hei hei&quot;</span></span>
<span id="cb1-56"><a href="#cb1-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-57"><a href="#cb1-57" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Phase 3: Let&#39;s send back the data!</span></span>
<span id="cb1-58"><a href="#cb1-58" aria-hidden="true" tabindex="-1"></a>        response_in_bytes <span class="op">=</span> string_to_unicode_bytes(response)</span>
<span id="cb1-59"><a href="#cb1-59" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.send_response(<span class="dv">200</span>)</span>
<span id="cb1-60"><a href="#cb1-60" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.send_header(<span class="st">&quot;Content-type&quot;</span>, <span class="st">&quot;text/plain&quot;</span>)</span>
<span id="cb1-61"><a href="#cb1-61" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.end_headers()</span>
<span id="cb1-62"><a href="#cb1-62" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.wfile.write(response_in_bytes)</span>
<span id="cb1-63"><a href="#cb1-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-64"><a href="#cb1-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-65"><a href="#cb1-65" aria-hidden="true" tabindex="-1"></a>port <span class="op">=</span> <span class="dv">8023</span></span>
<span id="cb1-66"><a href="#cb1-66" aria-hidden="true" tabindex="-1"></a>httpd <span class="op">=</span> HTTPServer(</span>
<span id="cb1-67"><a href="#cb1-67" aria-hidden="true" tabindex="-1"></a>    (<span class="st">&quot;&quot;</span>, port),</span>
<span id="cb1-68"><a href="#cb1-68" aria-hidden="true" tabindex="-1"></a>    RequestHandler,</span>
<span id="cb1-69"><a href="#cb1-69" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb1-70"><a href="#cb1-70" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;&quot;</span>)</span>
<span id="cb1-71"><a href="#cb1-71" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot; ******** TTM4175 Web Server  ******** &quot;</span>)</span>
<span id="cb1-72"><a href="#cb1-72" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(</span>
<span id="cb1-73"><a href="#cb1-73" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;    The server will be reachable via  http://</span><span class="sc">{}</span><span class="st">:</span><span class="sc">{}</span><span class="st">/&quot;</span>.<span class="bu">format</span>(get_ip_address(), port)</span>
<span id="cb1-74"><a href="#cb1-74" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb1-75"><a href="#cb1-75" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;    Terminate the server via Ctrl-C.&quot;</span>)</span>
<span id="cb1-76"><a href="#cb1-76" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot; ************************************* &quot;</span>)</span>
<span id="cb1-77"><a href="#cb1-77" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;&quot;</span>)</span>
<span id="cb1-78"><a href="#cb1-78" aria-hidden="true" tabindex="-1"></a>httpd.serve_forever()</span></code></pre></div>
</div></div><aside class="col-md-4 chunk ps-2"></aside></div>
<div class="row g-0 my-3"><div class="col-md-8 px-4 chunk"><ul>
<li>Read carefully through the code, starting in the line where we assign a port, and then the definitions of classes and functions above.</li>
<li>You can ignore the functions <code>store_data()</code> and <code>load_data()</code> for now.</li>
<li>Pay special attention to the function <code>do_GET()</code>. This will be the core of what we do today.</li>
<li>Be patient. Ask questions to each other, make sure everyone gets it.</li>
</ul>
<p><strong>A detail:</strong> You may see that the <code>do_GET()</code> function only has <code>self</code> as parameter (from the class), and does not have a return value.
This may be surprising, since it should get the request as input and then compute an answer. However, see how the code above gets access to the request via the attribute <code>self.requestline</code>. Similarly, the response is created by calling some functions on the parent class, for instance <code>self.wfile.write(response_in_bytes)</code>. So therefore the <code>do_GET()</code> function does not have any input or return parameters. It's more a question of how the API is designed, the authors have made a decision here.</p>
</div><aside class="col-md-4 chunk ps-2"></aside></div>
<div class="row g-0 my-3"><div class="col-md-8 px-4 chunk"><div class="task"><p>Run the code, like any Python program via <code>python webserver.py</code>.</p>
</div></div><aside class="col-md-4 chunk ps-2"></aside></div>
<div class="row g-0 my-3"><div class="col-md-8 px-4 chunk"><p>Note: Whenever you are going to change the code of the web server, you will need to terminate it via <code>Ctrl-C</code> and then restart it.</p>
<h2>Request via Web Browser</h2>
<ul>
<li>Either on the same machine, or (even better) on a different machine in case you are in the same network, access the website address that the server prints out in a browser.</li>
<li>If you access the browser on the same machine, you can type <code>http://localhost:8023/</code> as address. Otherwise, use the IP address instead of <code>localhost</code>.</li>
<li>What happens in the browser, and what happens in the command where the server program runs?</li>
<li>Create a sequence diagram of what you have just observed, and annotate it with details that you find relevant.</li>
<li>Answer the following questions:
<ul>
<li>In which format is the answer sent from the webserver to the client? Which steps are involved to convert the data for the response?</li>
<li>What happens if you send the request to the wrong port, for instance port <code>8001</code>?</li>
</ul>
</li>
</ul>
</div><aside class="col-md-4 chunk ps-2"></aside></div>
</section>
<section class="mt-5 mb-5 py-3">
<div class="row g-0 my-3"><div class="col-md-8 px-4 chunk"><h1>Sending Data to the Server</h1>
<p>We can send additional data with our request, by appending it into the URL as follows:</p>
</div><aside class="col-md-4 chunk ps-2"></aside></div>
<div class="row g-0 my-3"><div class="col-md-8 px-4 chunk"><div class="source-code-frame mt-3 mb-3">
<pre class="d-none" id="ide4c311">http://localhost:8000/?data={"time": "12:05", "temperature": 20.0, "humidity": 54.3}
</pre>
<button type="button" class="copy-button" data-clipboard-target="#ide4c311">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16">
  		<path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"></path>
  		<path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"></path>
	</svg>
</button>
<pre><code>http://localhost:8000/?data={&quot;time&quot;: &quot;12:05&quot;, &quot;temperature&quot;: 20.0, &quot;humidity&quot;: 54.3}</code></pre>
</div></div><aside class="col-md-4 chunk ps-2"></aside></div>
<div class="row g-0 my-3"><div class="col-md-8 px-4 chunk"><h2>Sending Data via the Browser</h2>
<ul>
<li>Copy the URL from above, but adjust it to your IP address (if necessary).</li>
<li>Paste the entire URL with the data part into your browser.</li>
<li>Observe what happens in the address line after the response returns. Did the browser change the data you wanted to transmit?</li>
<li>Check which information was received by the server.</li>
<li>Has the data been transformed somehow?</li>
</ul>
</div><aside class="col-md-4 chunk ps-2"></aside></div>
<div class="row g-0 my-3"><div class="col-md-8 px-4 chunk"><h2>GET and POST on the Server</h2>
<p>Look again at the figure. Form the task above, we have already the <strong>GET</strong> command in place (by function <code>do_GET()</code>). With this command, we offer the browser (here shown as phone) a website so we can read the temperature.
To let the sensor inform the server about the temperature, it uses instead the <strong>POST</strong> command.</p>
</div><aside class="col-md-4 chunk ps-2"></aside></div>
<div class="row g-0 my-3"><div class="col-md-8 px-4 chunk"><figure class="figure">
    <img src="figures/smart-home.png" class="figure-img img-fluid rounded" alt="">
</figure></div><aside class="col-md-4 chunk ps-2"></aside></div>
<div class="row g-0 my-3"><div class="col-md-8 px-4 chunk"><p>So, to repeat:</p>
<ul>
<li>
<p>Here, the <code>do_GET()</code> function processes the requests from browsers that want to know the temperature, and it works pretty much like the <strong>GET</strong> for any other website; we return a complete website to the browser that shows the temperature.</p>
</li>
<li>
<p>With the <code>do_POST()</code> function, a smart sensor (which we imitate with another Python program) can tell the sensor which temperature it measured.</p>
</li>
</ul>
<p>The temperature sensor and the browser to show the temperature to a user are acting completely independently. (Of course, the server can only show a temperature to a browser if the temperature sensor has at least updated the temperature once.)</p>
</div><aside class="col-md-4 chunk ps-2"></aside></div>
<div class="row g-0 my-3"><div class="col-md-8 px-4 chunk"><div class="task"><p>Run the code, like any Python program via <code>python webserver.py</code>.</p>
</div></div><aside class="col-md-4 chunk ps-2"></aside></div>
<div class="row g-0 my-3"><div class="col-md-8 px-4 chunk"><div class="task"><p>Add a function <code>do_POST():</code> <strong>in addition</strong> to the already existing <code>do_GET()</code> function. See the code below for that function.</p>
</div></div><aside class="col-md-4 chunk ps-2"></aside></div>
<div class="row g-0 my-3"><div class="col-md-8 px-4 chunk"><div class="source-code-frame mt-3 mb-3">
<pre class="d-none" id="idc6da62">def do_POST(self):
	"""HTTP POST request as it comes from the sensor device application,
	for instance to send the current temerature."""

	print("-------- Incoming POST request --------")
	print("  Request data: {}".format(self.requestline))

	decoded_request = decode_url_back_to_string(self.requestline)
	print("  Decoded data: {}".format(decoded_request))

	json_string = extract_json_string(decoded_request)
	print("  Extracted JSON string: {}".format(json_string))

	dictionary = json_string_to_dictionary(json_string)
	print(dictionary)

	# We extract the temperature...
	temperature = dictionary["temperature"]
	print(f"Temperature {temperature} received in do_POST()")
	# ...and store it
	# self.store_data("temperature", temperature)

	# Phase 2: Which data do we want to send back?
	response = "ok"

	# Phase 3: Let's send back the data!
	response_in_bytes = string_to_unicode_bytes(response)
	self.send_response(200)
	self.send_header("Content-type", "text/plain")
	self.end_headers()
	self.wfile.write(response_in_bytes)
</pre>
<button type="button" class="copy-button" data-clipboard-target="#idc6da62">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16">
  		<path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"></path>
  		<path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"></path>
	</svg>
</button>
<div class="sourceCode" id="cb1"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> do_POST(<span class="va">self</span>):</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;HTTP POST request as it comes from the sensor device application,</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co">    for instance to send the current temerature.&quot;&quot;&quot;</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;-------- Incoming POST request --------&quot;</span>)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;  Request data: </span><span class="sc">{}</span><span class="st">&quot;</span>.<span class="bu">format</span>(<span class="va">self</span>.requestline))</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>    decoded_request <span class="op">=</span> decode_url_back_to_string(<span class="va">self</span>.requestline)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;  Decoded data: </span><span class="sc">{}</span><span class="st">&quot;</span>.<span class="bu">format</span>(decoded_request))</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>    json_string <span class="op">=</span> extract_json_string(decoded_request)</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;  Extracted JSON string: </span><span class="sc">{}</span><span class="st">&quot;</span>.<span class="bu">format</span>(json_string))</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>    dictionary <span class="op">=</span> json_string_to_dictionary(json_string)</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(dictionary)</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># We extract the temperature...</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>    temperature <span class="op">=</span> dictionary[<span class="st">&quot;temperature&quot;</span>]</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;Temperature </span><span class="sc">{</span>temperature<span class="sc">}</span><span class="ss"> received in do_POST()&quot;</span>)</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ...and store it</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># self.store_data(&quot;temperature&quot;, temperature)</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Phase 2: Which data do we want to send back?</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>    response <span class="op">=</span> <span class="st">&quot;ok&quot;</span></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Phase 3: Let&#39;s send back the data!</span></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>    response_in_bytes <span class="op">=</span> string_to_unicode_bytes(response)</span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.send_response(<span class="dv">200</span>)</span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.send_header(<span class="st">&quot;Content-type&quot;</span>, <span class="st">&quot;text/plain&quot;</span>)</span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.end_headers()</span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.wfile.write(response_in_bytes)</span></code></pre></div>
</div></div><aside class="col-md-4 chunk ps-2"></aside></div>
<div class="row g-0 my-3"><div class="col-md-8 px-4 chunk"><p>We use from now on the <code>do_GET()</code> function to serve the web site that displays the temperature, and the function <code>do_POST()</code> to receive data from the temperature sensor. The web server can hence process two different requests: one for storing data, one for serving a website that presents the data.</p>
<h2>Sending Data via Python Requests</h2>
<p>We now want to send data to the web server from Python. In a real system, a sensor should do this automated and in periodic intervals.
(As we work without special hardware, we are happy with a Python program that just imitates the temperature sensor.)
This code sends the data to the web server, using a <strong>POST</strong> request:</p>
</div><aside class="col-md-4 chunk ps-2"></aside></div>
<div class="row g-0 my-3"><div class="col-md-8 px-4 chunk"><div class="source-code-frame mt-3 mb-3">
<pre class="d-none" id="idab9b67">import requests
import json
from urllib.parse import quote, unquote


def dictionary_to_string(dictionary):
	return json.dumps(dictionary)

def encode_string_into_url(string):
	return quote(string)

def print_response(response):
	print('-------- Response --------')
	print('Status code: {}'.format(response.status_code))
	print('-------- Content--------')
	print(response.text)
	print('------------------------')

# example data
dictionary = {}
dictionary['temperature'] = 20.0
dictionary['sensor_name'] = 'kitchen'

# ... your code ...

response = requests.post('http://192.168.86.104:8000/?data={}'.format(...))
print_response(response)
</pre>
<button type="button" class="copy-button" data-clipboard-target="#idab9b67">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16">
  		<path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"></path>
  		<path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"></path>
	</svg>
</button>
<div class="sourceCode" id="cb1"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> requests</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> urllib.parse <span class="im">import</span> quote, unquote</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> dictionary_to_string(dictionary):</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> json.dumps(dictionary)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> encode_string_into_url(string):</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> quote(string)</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> print_response(response):</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&#39;-------- Response --------&#39;</span>)</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&#39;Status code: </span><span class="sc">{}</span><span class="st">&#39;</span>.<span class="bu">format</span>(response.status_code))</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&#39;-------- Content--------&#39;</span>)</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(response.text)</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&#39;------------------------&#39;</span>)</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="co"># example data</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>dictionary <span class="op">=</span> {}</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>dictionary[<span class="st">&#39;temperature&#39;</span>] <span class="op">=</span> <span class="fl">20.0</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>dictionary[<span class="st">&#39;sensor_name&#39;</span>] <span class="op">=</span> <span class="st">&#39;kitchen&#39;</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a><span class="co"># ... your code ...</span></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>response <span class="op">=</span> requests.post(<span class="st">&#39;http://192.168.86.104:8000/?data=</span><span class="sc">{}</span><span class="st">&#39;</span>.<span class="bu">format</span>(...))</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>print_response(response)</span></code></pre></div>
</div></div><aside class="col-md-4 chunk ps-2"></aside></div>
<div class="row g-0 my-3"><div class="col-md-8 px-4 chunk"><ul>
<li>Create a new client program with the code above.</li>
<li>Add the necessary lines to convert the data to send, use the included functions.</li>
<li>Document what these functions actually do.</li>
<li>With the server from before running, execute the client code.</li>
<li>Document what happens.</li>
</ul>
</div><aside class="col-md-4 chunk ps-2"></aside></div>
<div class="row g-0 my-3"><div class="col-md-8 px-4 chunk"><h2>Decoding Data in the Server</h2>
<ul>
<li>Pay attention to the method <code>do_POST()</code> in the server</li>
<li>What is happening in the code that we provided in the method <code>do_POST()</code>, step by step?</li>
</ul>
</div><aside class="col-md-4 chunk ps-2"></aside></div>
</section>
<section class="mt-5 mb-5 py-3">
<div class="row g-0 my-3"><div class="col-md-8 px-4 chunk"><h1>Storing Temperature Data in the Server</h1>
<p>The web server should store the temperature that the sensor sends in. So we need some way to store data in the web server. In a real system, this is done with data bases or more powerful storage solutions optimized to serve many requests. For our little server, just storing the data in a Python dictionary is enough.
We use the two functions <code>store_data()</code> and <code>load_data()</code> shown below to store or load data.</p>
</div><aside class="col-md-4 chunk ps-2"></aside></div>
<div class="row g-0 my-3"><div class="col-md-8 px-4 chunk"><div class="source-code-frame mt-3 mb-3">
<pre class="d-none" id="idf96d7c">def store_data(self, name, data):
	if not hasattr(self.server, "data"):
		self.server.data = {}
	self.server.data[name] = data

def load_data(self, name):
	if hasattr(self.server, "data"):
		if name in self.server.data:
			return self.server.data[name]
	return None
</pre>
<button type="button" class="copy-button" data-clipboard-target="#idf96d7c">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16">
  		<path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"></path>
  		<path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"></path>
	</svg>
</button>
<div class="sourceCode" id="cb1"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> store_data(<span class="va">self</span>, name, data):</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> <span class="bu">hasattr</span>(<span class="va">self</span>.server, <span class="st">&quot;data&quot;</span>):</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.server.data <span class="op">=</span> {}</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.server.data[name] <span class="op">=</span> data</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> load_data(<span class="va">self</span>, name):</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">hasattr</span>(<span class="va">self</span>.server, <span class="st">&quot;data&quot;</span>):</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> name <span class="kw">in</span> <span class="va">self</span>.server.data:</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">self</span>.server.data[name]</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">None</span></span></code></pre></div>
</div></div><aside class="col-md-4 chunk ps-2"></aside></div>
<div class="row g-0 my-3"><div class="col-md-8 px-4 chunk"><p>As you see, these functions use the <code>self.server</code> attribute, which provides access to the actual server instance.
From there, we can access a variable <code>data</code> that is a dictionary so that we can store variables by name.
I this way we can store data also between different calls of the <code>do_GET()</code> and <code>do_POST()</code> functions.
To repeat and clarify:</p>
<ul>
<li><code>do_POST()</code> stores the temperature data submitted by the temperature sensor application,</li>
<li><code>do_GET()</code> provides the website with the the data from the sensor and the air temperature obtained from the forecast.</li>
</ul>
</div><aside class="col-md-4 chunk ps-2"></aside></div>
<div class="row g-0 my-3"><div class="col-md-8 px-4 chunk"><div class="task"><p>Uncomment the storage for the temperature in the code.</p>
<h3>Adding the Yr Forecast</h3>
</div></div><aside class="col-md-4 chunk ps-2"></aside></div>
<div class="row g-0 my-3"><div class="col-md-8 px-4 chunk"><div class="task"><p>Extend your server logic so that it does not only return the temperature of the sensor, but also the temperature forecast from yr, so that it is displayed together.</p>
<p>Use the function for getting the forecast you have developed above. This means you web server which acts as a server because it implements the methods GET and POST, now also acts as a client towards Yr.no since it requests data from it.</p>
</div></div><aside class="col-md-4 chunk ps-2"></aside></div>
</section>
<section class="mt-5 mb-5 py-3">
<div class="row g-0 my-3"><div class="col-md-8 px-4 chunk"><h1>Optional Task: Nice HTML Output</h1>
<p>Now that we can send a simple string as a response, let's make the answer more advanced and send a proper website in HTML. HTML is in principle also only a string, but the browser reads the formatting tags and creates a nicely rendered page out of it. The following code contains a simple Python method that creates some HTML:</p>
</div><aside class="col-md-4 chunk ps-2"></aside></div>
<div class="row g-0 my-3"><div class="col-md-8 px-4 chunk"><div class="source-code-frame mt-3 mb-3">
<pre class="d-none" id="id7fc710">def generate_basic_html_page(title='Default Title'):
	lines = []
	lines.append('<html>')
	lines.append('    <head><title>{}</title></head>'.format(title))
	lines.append('    <body>')
	lines.append('        <h1>Hello!</h1>')
	lines.append('        <p>This is a very simple HTML page. It even contains a <a href="http://www.ntnu.no">link.</a></p>')
	lines.append('    </body>')
	lines.append('</html>')
	return '\n'.join(lines)
</pre>
<button type="button" class="copy-button" data-clipboard-target="#id7fc710">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16">
  		<path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"></path>
  		<path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"></path>
	</svg>
</button>
<div class="sourceCode" id="cb1"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> generate_basic_html_page(title<span class="op">=</span><span class="st">&#39;Default Title&#39;</span>):</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>    lines <span class="op">=</span> []</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>    lines.append(<span class="st">&#39;&lt;html&gt;&#39;</span>)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>    lines.append(<span class="st">&#39;    &lt;head&gt;&lt;title&gt;</span><span class="sc">{}</span><span class="st">&lt;/title&gt;&lt;/head&gt;&#39;</span>.<span class="bu">format</span>(title))</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>    lines.append(<span class="st">&#39;    &lt;body&gt;&#39;</span>)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>    lines.append(<span class="st">&#39;        &lt;h1&gt;Hello!&lt;/h1&gt;&#39;</span>)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>    lines.append(<span class="st">&#39;        &lt;p&gt;This is a very simple HTML page. It even contains a &lt;a href=&quot;http://www.ntnu.no&quot;&gt;link.&lt;/a&gt;&lt;/p&gt;&#39;</span>)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>    lines.append(<span class="st">&#39;    &lt;/body&gt;&#39;</span>)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>    lines.append(<span class="st">&#39;&lt;/html&gt;&#39;</span>)</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="st">&#39;</span><span class="ch">\n</span><span class="st">&#39;</span>.join(lines)</span></code></pre></div>
</div></div><aside class="col-md-4 chunk ps-2"></aside></div>
<div class="row g-0 my-3"><div class="col-md-8 px-4 chunk"><ul>
<li>
<p>Copy the code above into the web server file from above. Place the function just below the import statements, so that it is at the top level of the file. (Not within the class declaration.)</p>
</li>
<li>
<p>Exchange the simple string in the web server so that it instead returns the HTML page created by this function.</p>
</li>
<li>
<p>To make all correct and tidy, update the line where we set the content type so that it uses <code>self.send_header(&quot;Content-type&quot;, &quot;text/html&quot;)</code>.</p>
</li>
<li>
<p>Now go back to the browser, and access the website again. What changed?</p>
</li>
<li>
<p>Can you set the title of the website?</p>
</li>
<li>
<p>Let the function receive the temperature from the sensor and the one from the forecast, and format the information in HTML to include these values.</p>
</li>
</ul>
</div><aside class="col-md-4 chunk ps-2"></aside></div>
</section>
<section class="mt-5 mb-5 py-3">
<div class="row g-0 my-3"><div class="col-md-8 px-4 chunk"><h1>Things to Remember</h1>
<ul>
<li>HTTP can be used for more than just websites, it can also be used to let applications in general transport any type of data.</li>
<li>JSON can be used as a convention how to serialize data types, and then serve as format to send over HTTP.</li>
</ul>
</div><aside class="col-md-4 chunk ps-2"></aside></div>
</section>
  </main>



  <nav class="navbar navbar-expand-lg navbar-dark fixed-bottom" style="background-color: #555555">
    <div class="container-fluid">
      <div class="collapse navbar-collapse">
        <ul class="navbar-nav">
          <li class="nav-item">
            <a class="nav-link" href="https://www.ntnu.no/informasjonskapsler">Om informasjonskapsler</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="https://www.ntnu.no/personvern">Personvern</a>
          </li>
        </ul>
        <div class="bg-light ms-auto border-0"></div>
        <ul class="navbar-nav">
          <li class="nav-item">
            <a class="nav-link" data-bs-toggle="offcanvas" href="#offcanvasExample" role="button"
              aria-controls="offcanvasExample">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                class="bi bi-pencil-square" viewBox="0 0 16 16">
                <path
                  d="M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.646a.5.5 0 0 1 .707 0l1.293 1.293zm-1.75 2.456-2-2L4.939 9.21a.5.5 0 0 0-.121.196l-.805 2.414a.25.25 0 0 0 .316.316l2.414-.805a.5.5 0 0 0 .196-.12l6.813-6.814z" />
                <path fill-rule="evenodd"
                  d="M1 13.5A1.5 1.5 0 0 0 2.5 15h11a1.5 1.5 0 0 0 1.5-1.5v-6a.5.5 0 0 0-1 0v6a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5v-11a.5.5 0 0 1 .5-.5H9a.5.5 0 0 0 0-1H2.5A1.5 1.5 0 0 0 1 2.5v11z" />
              </svg>
            </a>
          </li>
        </ul>
      </div>
    </div>
  </nav>
  <div class="offcanvas offcanvas-end text-bg-dark" tabindex="-1" id="offcanvasExample"
    aria-labelledby="offcanvasExampleLabel">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title" id="offcanvasExampleLabel">Edit this page</h5>
    </div>
    <div class="offcanvas-body">
      <ul>
        <li>This site is hosted on <a href="https://github.com/falkr/ttm4175">Github</a></li>
        <li>The source is written in <a href="../supermark/index.html">Supermark</a> syntax</li>
        <li>To edit this page, make a commit to <a
            href="https://github.com/falkr/ttm4175/tree/master/pages/unit-p3/teamwork-1.md">this file</a></li>
      </ul>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
    crossorigin="anonymous"></script>
  <script>
    anchors.add('h1').add('h2').add('h3');
    anchors.options.visible = 'always';
    var clipboard = new ClipboardJS('.copy-button');
  </script>
  <script>

</script>
</body>

</html>