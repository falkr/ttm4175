<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="">
  <meta name="author" content="">
  <meta name="generator" content="">
  <title>TTM4175</title>
  <link rel="canonical" href="https://edu.iik.ntnu.no">
  <!-- Bootstrap core CSS -->
  <link href="../assets/bootstrap.min.css" rel="stylesheet">
  <!-- Custom styles for this template -->
  <link href="../assets/style-frame.css" rel="stylesheet">
  <link href="../assets/style-fonts.css" rel="stylesheet">
  <link href="../assets/style-code.css" rel="stylesheet">
  <link rel="stylesheet" href="../assets/bootstrap-icons.css">
  <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
    integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
    crossorigin="anonymous"></script>
  <script src="../assets/anchor.js"></script>
  <script src="../assets/clipboard.min.js"></script>
  <script src="../assets/script-aside.js"></script>
  <style>/* === figure === */
div.figure {
  padding: 20px 0 20px 0;
  width: 100%;
}

div.figurefullwitdth {
  padding: 20px 0 20px 0;
  margin-left: -33px;
  margin-right: -33px;
  width: 100%;
}

figcaption {
  color: #868279;
}

</style>
</head>

<body>





  <nav class="navbar navbar-expand-lg navbar shadow-sm">
    <div class="container-fluid">
      <a class="navbar-brand" href="https://ntnu.edu" title="NTNU Homepage">
        <img id="header_logo" alt="NTNU Hjemmeside" width="120"
          src="https://www.ntnu.no/o/ntnu-theme/images/logo_ntnu.svg" height="23">
      </a>

      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavDropdown"
        aria-controls="navbarNavDropdown" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-list"
            viewBox="0 0 16 16">
            <path fill-rule="evenodd"
              d="M2.5 12a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5z" />
          </svg>
        </span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNavDropdown">
        <ul class="navbar-nav">
          <li class="nav-item">
            <a class="nav-link" href="../index.html">TTM4175</a>
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
              Teknostart
            </a>
            <ul class="dropdown-menu dropdown-menu">
              <li><a class="dropdown-item" href="../teknostart/index.html">Teknostart oversikt</a></li>
              <li>
                <div class="dropdown-divider"></div>
              </li>
              <li><a class="dropdown-item" href="../teknostart/day1.html">Teknostart Dag 1</a></li>
              <li><a class="dropdown-item" href="../teknostart/day2.html">Teknostart Dag 2</a></li>
              <li><a class="dropdown-item" href="../teknostart/day3.html">Teknostart Dag 3</a></li>
              <li><a class="dropdown-item" href="../teknostart/day4.html">Teknostart Dag 4</a></li>
            </ul>
          </li>
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
              Units
            </a>
            <ul class="dropdown-menu dropdown-menu">
              <a class="dropdown-item" href="../units.html">Oversikt</a>
              <div class="dropdown-divider"></div>
              <a class="dropdown-item" href="../unit-cli/index.html">Lab 1: Linux CLI</a>
              <a class="dropdown-item" href="../unit-net1/index.html">Lab 2: IPs, LAN</a>
              <a class="dropdown-item" href="../unit-net2/index.html">Lab 3: Ports, Web Servers</a>
              <a class="dropdown-item" href="../unit-net3/index.html">Lab 4: Routing, DNS</a>
              <div class="dropdown-divider"></div>
              <a class="dropdown-item" href="../unit-p1/index.html">IoT and the Microbit</a>
              <a class="dropdown-item" href="../unit-p2/index.html">State Machines</a>
              <a class="dropdown-item" href="../unit-p3/index.html">HTTP and JSON</a>
              <div class="dropdown-divider"></div>
              <a class="dropdown-item" href="../unit-cs1/index.html">Cybersecurity 1: Intro and Ethical Hacking</a>
              <a class="dropdown-item" href="../unit-cs2/index.html">Cybersecurity 2: Information Gathering</a>
              <a class="dropdown-item" >Cybersecurity 3</a>
              <div class="dropdown-divider"></div>
              <a class="dropdown-item" href="../unit-p4/index.html">MQTT</a>
            </ul>
          </li>



          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
              Learning
            </a>
            <ul class="dropdown-menu dropdown-menu">
              <li><a class="dropdown-item" href="../learning/learning.html">LÃ¦ring</a></li>
              <li><a class="dropdown-item" href="../learning/reports.html">Rapporter</a></li>
            </ul>
          </li>
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
              Tools
            </a>
            <ul class="dropdown-menu dropdown-menu">
              <li><a class="dropdown-item" href="../tools/index.html">Tools</a></li>
              <!--<li><a class="dropdown-item" href="../tools/tools-python.html">Python</a></li>-->
              <li><a class="dropdown-item" href="../tools/tools-gui.html">GUIs in Python</a></li>
              <li><a class="dropdown-item" href="../tools/tools-mqtt.html">MQTT</a></li>
              <li><a class="dropdown-item" href="../tools/tools-notebooks.html">Notebooks</a></li>
              <li><a class="dropdown-item" href="../tools/tools-stmpy.html">STMPY</a></li>
            </ul>
          </li>
        </ul>
        <div class="bg-light border ms-auto"></div>
        <div>
          <a class="nav-link" href="../schedule.html"><svg xmlns="http://www.w3.org/2000/svg" width="16"
              height="16" fill="currentColor" class="bi bi-calendar3" viewBox="0 0 16 16">
              <path
                d="M14 0H2a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2zM1 3.857C1 3.384 1.448 3 2 3h12c.552 0 1 .384 1 .857v10.286c0 .473-.448.857-1 .857H2c-.552 0-1-.384-1-.857V3.857z" />
              <path
                d="M6.5 7a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm3 0a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm3 0a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm-9 3a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm3 0a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm3 0a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm3 0a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm-9 3a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm3 0a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm3 0a1 1 0 1 0 0-2 1 1 0 0 0 0 2z" />
            </svg></a>
        </div>
      </div>
    </div>
  </nav>

  <main class="container container-max-width">
    <nav style="--bs-breadcrumb-divider: url(&#34;data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='8' height='8'%3E%3Cpath d='M2.5 0L1 1.5 3.5 4 1 6.5 2.5 8l4-4-4-4z' fill='%236c757d'/%3E%3C/svg%3E&#34;);" aria-label="breadcrumb">
<ol class="breadcrumb">
<li class="breadcrumb-item"><a href="../index.html">TTM4175</a></li>
<li class="breadcrumb-item"><a href="index.html">IoT 2</a></li>
<li class="breadcrumb-item active" aria-current="page">Preparation 2</li>
</ol>
</nav>
<section class="mt-2 mb-5 py-3">
<div class="row g-0 my-3"><div class="col-md-8 px-4 chunk"><h1>State Machines in Micro Python</h1>
<p>The state machines were so far expressed as diagrams, that means <strong>pictures</strong>.
In this part we are going to explore how we can implement the state machines as Python <strong>code</strong>.</p>
<p>The Microbit we are going to program does not run all Python code, but only a reduced set of it.
This subset is called MicroPython.
To run state machines on it, we will provide you with some code that serves as a template or a skeleton.
We create the state machines by manually translating a diagram step for step into a Python function that executes transitions.</p>
</div><aside class="col-md-4 chunk ps-2"></aside></div>
<div class="row g-0 my-3"><div class="col-md-8 px-4 chunk"><h3>Idea 1: Storing the State</h3>
<p>In a &quot;normally coded&quot; program, the progress of an application is stored indirectly in the form of the program counter.
Simplified said, the program remembers <strong>in which line</strong> it currently is, and then proceeds, statement for statement, including loops and branches.</p>
<p>To execute a state machine, we use an <strong>extra variable that explicitly stores the current state</strong> of the program, and which corresponds to the state in the state machine.
For simplicity, we store the variable as a string, which corresponds to the name of the state from the diagram.</p>
<p>A state machine reacts on events based on its state. For example, a simple blinking light that switches between <code>on</code> and <code>off</code> reacts differently on each timeout that happens. If the lamp is currently on, it is switched off, and if the lamp is currently off, it is switched on. This is the state machine:</p>
</div><aside class="col-md-4 chunk ps-2"></aside></div>
<div class="row g-0 my-3"><div class="col-md-8 px-4 chunk"><figure class="figure">
    <img src="figures/stm-blink-1.svg" class="figure-img img-fluid rounded" alt="">
</figure></div><aside class="col-md-4 chunk ps-2"></aside></div>
<div class="row g-0 my-3"><div class="col-md-8 px-4 chunk"><p>We can encode this in Python as an if-statement that takes the current state as condition:</p>
</div><aside class="col-md-4 chunk ps-2"></aside></div>
<div class="row g-0 my-3"><div class="col-md-8 px-4 chunk"><div class="source-code-frame mt-3 mb-3">
<pre class="d-none" id="id87f238">if state == "on":
    # switch light off
    # change into state "off"
elif state == "off":
    # switch light on
    # change into state "on"
</pre>
<button type="button" class="copy-button" data-clipboard-target="#id87f238">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16">
  		<path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"></path>
  		<path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"></path>
	</svg>
</button>
<div class="sourceCode" id="cb1"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> state <span class="op">==</span> <span class="st">&quot;on&quot;</span>:</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># switch light off</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># change into state &quot;off&quot;</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="cf">elif</span> state <span class="op">==</span> <span class="st">&quot;off&quot;</span>:</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># switch light on</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># change into state &quot;on&quot;</span></span></code></pre></div>
</div></div><aside class="col-md-4 chunk ps-2"></aside></div>
<div class="row g-0 my-3"><div class="col-md-8 px-4 chunk"><h3>Idea 2: A Transition Function</h3>
<p>Now that we have taken care of the control state by an explicit variable, we need to think how to implement the transitions.
Let's think again what a transition actually does:</p>
<ul>
<li>It is triggered by an event.</li>
<li>It takes a state machine from one state to another state.</li>
<li>While it executes, it can do some actions and maybe decide between alternative branches.</li>
</ul>
<p>To implement transitions, we define a function that executes them.
The method receives the following parameters:</p>
<ul>
<li><code>state</code> - the current state of the machine</li>
<li><code>event</code> - the event that triggered the machine</li>
<li><code>timers</code> - a variable to start and stop timers</li>
</ul>
</div><aside class="col-md-4 chunk ps-2"></aside></div>
<div class="row g-0 my-3"><div class="col-md-8 px-4 chunk"><div class="source-code-frame mt-3 mb-3">
<pre class="d-none" id="idf2c226">def transition(self, state, event, timers):
    # logic to execute the transitions
</pre>
<button type="button" class="copy-button" data-clipboard-target="#idf2c226">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16">
  		<path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"></path>
  		<path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"></path>
	</svg>
</button>
<div class="sourceCode" id="cb1"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> transition(<span class="va">self</span>, state, event, timers):</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># logic to execute the transitions</span></span></code></pre></div>
</div></div><aside class="col-md-4 chunk ps-2"></aside></div>
<div class="row g-0 my-3"><div class="col-md-8 px-4 chunk"><p>In the if-statement above, we change what we do only based on the current state.
This was okay because every state of the blinking light only had a single outgoing transition.
But if we consider now that we can also switch off the blinking light by pressing a button, we need to distinguish if the event was a timer expiration <code>t1</code> or a click on a button <code>button_a</code>.
We do this with a nested if-statement.</p>
<p>The listing below shows the transition function for a simple example. (Ignore the parameter <code>self</code> for now.)
Within the method, we place first an if-statement which distinguishes the different states of the machine.
It has one branch for each state.
Within each state branch, there is another if-statement, which distinguishes the different events.</p>
</div><aside class="col-md-4 chunk ps-2"></aside></div>
<div class="row g-0 my-3"><div class="col-md-8 px-4 chunk"><figure class="figure">
    <img src="figures/transition-and-code.png" class="figure-img img-fluid rounded" alt="State machine diagram and the corresponding transition function. Colors in the diagram correspond to the colored code sections.">
</figure></div><aside class="col-md-4 chunk ps-2"><figcaption class="figure-caption">State machine diagram and the corresponding transition function. Colors in the diagram correspond to the colored code sections.</figcaption></aside></div>
<div class="row g-0 my-3"><div class="col-md-8 px-4 chunk"><h3>Next State</h3>
<p>You can see in the code above that the transition function returns a string which is the target state of the transition. The blue code, for example, triggered by <code>t1</code> in state <code>off</code> returns <code>on</code>, which is the next state for that transition.</p>
</div><aside class="col-md-4 chunk ps-2"></aside></div>
<div class="row g-0 my-3"><div class="col-md-8 px-4 chunk"><h3>Events</h3>
<p>The events are fed into the transition function also as strings.</p>
<ul>
<li>Timer expirations like <code>t1</code>, <code>t2</code>, <code>t3</code>. (For now, the number of timers in our simple machines is limited to these three.)</li>
<li>Button events <code>button_a</code> and <code>button_b</code>.</li>
<li>Gestures <code>shake</code>.</li>
</ul>
</div><aside class="col-md-4 chunk ps-2"></aside></div>
<div class="row g-0 my-3"><div class="col-md-8 px-4 chunk"><h3>Actions</h3>
</div><aside class="col-md-4 chunk ps-2"></aside></div>
<div class="row g-0 my-3"><div class="col-md-8 px-4 chunk"><p>Within these branches, we then do actions:</p>
<ul>
<li><strong>Starting timers:</strong> Using the passed variable <code>timers</code>, you can call <code>timers.start(&quot;t1&quot;, 300)</code> to start a timer with name <code>t1</code> and 300 milliseconds timeout.</li>
<li><strong>Stopping timers:</strong> You can also stop a timer with <code>timers.stop(&quot;t1&quot;)</code>.</li>
<li><strong>Call a Microbit function:</strong> call a function to do something in the Microbit, like using the display.</li>
<li><strong>Change a variable.</strong> You can assign new values to variables, too. You only need to make sure that you access the variables via the parameter <code>self</code>, which we describe better below.</li>
</ul>
<p>There is also some stuff that you should <strong>not</strong> do as part of a transition:</p>
<ul>
<li>You can use the <code>print()</code> statement for debugging, but be careful. In some of my examples it slowed down everything. I guess this is because of the communication of the user interface with the code. So just remove any print-statements if you have troubles.</li>
<li>You should not do other &quot;long-running&quot; operations within a transition, otherwise your state machine is blocked. For instance, you should not be <em>waiting</em> in a transition function for an event to happen, maybe even with a while loop. Waiting for the events only happens within the top-level while loop of the state machine (more on that later) that then calls you. (Therefore you are restricted to a few events, but they should be enough for now.)</li>
</ul>
<h3>Initial Transitions</h3>
<p>To handle the initial transition, we just declare an extra transition function.
It is similar to the other transition function, but does not have the <code>event</code> parameter, since an initial transition is started always when a state machine starts.</p>
</div><aside class="col-md-4 chunk ps-2"></aside></div>
<div class="row g-0 my-3"><div class="col-md-8 px-4 chunk"><div class="source-code-frame mt-3 mb-3">
<pre class="d-none" id="id5c60e9">    def initial_transition(self, timers):
        ### the initial transition

    def transition(self, state, event, timers):
        ### the remaining transitions
</pre>
<button type="button" class="copy-button" data-clipboard-target="#id5c60e9">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16">
  		<path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"></path>
  		<path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"></path>
	</svg>
</button>
<div class="sourceCode" id="cb1"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> initial_transition(<span class="va">self</span>, timers):</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>        <span class="co">### the initial transition</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> transition(<span class="va">self</span>, state, event, timers):</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>        <span class="co">### the remaining transitions</span></span></code></pre></div>
</div></div><aside class="col-md-4 chunk ps-2"></aside></div>
<div class="row g-0 my-3"><div class="col-md-8 px-4 chunk"><h3>Final state</h3>
<p>To make a transition into the final state, just return the special name <code>&quot;final&quot;</code> as next state, and the state machine will terminate.</p>
</div><aside class="col-md-4 chunk ps-2"></aside></div>
<div class="row g-0 my-3"><div class="col-md-8 px-4 chunk"><h3>Decisions</h3>
<p>Transitions can also contain decisions, which means that they can branch into different target states depending on the value of variables or results of functions. We can encode such decisions simply by yet another if-statement in our transition function.</p>
<p>In the example below, we change our blinking light so that is automatically stops to blink when the surrounding light level goes above 100. (Not sure if that is useful, but it's just an example.)</p>
</div><aside class="col-md-4 chunk ps-2"></aside></div>
<div class="row g-0 my-3"><div class="col-md-8 px-4 chunk"><figure class="figure">
    <img src="figures/transition-and-code-decision.png" class="figure-img img-fluid rounded" alt="State machine diagram and the corresponding transition function. Colors in the diagram correspond to the colored code sections.">
</figure></div><aside class="col-md-4 chunk ps-2"><figcaption class="figure-caption">State machine diagram and the corresponding transition function. Colors in the diagram correspond to the colored code sections.</figcaption></aside></div>
<div class="row g-0 my-3"><div class="col-md-8 px-4 chunk"><p>In the blue part of the code above, you see now three nested if statements,</p>
<ul>
<li>the first one distinguishing the current state</li>
<li>the second one for distinguishing the event</li>
<li>the third one to implement the decision in the transition</li>
</ul>
<p>(In each state we currently only accept a single event, so the second if statement in this example is strictly speaking not necessary, but you get the idea: A more complex machine can have more than one outgoing transition in each state.)</p>
</div><aside class="col-md-4 chunk ps-2"></aside></div>
</section>
<section class="mt-2 mb-5 py-3">
<div class="row g-0 my-3"><div class="col-md-8 px-4 chunk"><h1>Running Your State Machine</h1>
</div><aside class="col-md-4 chunk ps-2"></aside></div>
<div class="row g-0 my-3"><div class="col-md-8 px-4 chunk"><p>So far, we have only considered the transition functions.
We have not told you about the logic that makes the entire state machine work.
That means, the logic that</p>
<ul>
<li>keeps track of the state,</li>
<li>takes care of the timers,</li>
<li>detect events,</li>
<li>calls the transition functions.</li>
</ul>
<p>We have put all this logic into a Python structure called a <strong>class</strong>.
This is a concept from object-oriented programming, which will come later in your programming courses. It makes the definition of your own state machines much easier, and you don't have to understand object-orientation and classes completely to use it. There is only a few things to take care of:</p>
</div><aside class="col-md-4 chunk ps-2"></aside></div>
<div class="row g-0 my-3"><div class="col-md-8 px-4 chunk"><div class="source-code-frame mt-3 mb-3">
<pre class="d-none" id="id97b771">class MyStateMachine1(StateMachine):

    def initial_transition(self, timers):
        ### the initial transition

    def transition(self, state, event, timers):
        ### the remaining transitions
</pre>
<button type="button" class="copy-button" data-clipboard-target="#id97b771">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16">
  		<path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"></path>
  		<path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"></path>
	</svg>
</button>
<div class="sourceCode" id="cb1"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MyStateMachine1(StateMachine):</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> initial_transition(<span class="va">self</span>, timers):</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>        <span class="co">### the initial transition</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> transition(<span class="va">self</span>, state, event, timers):</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>        <span class="co">### the remaining transitions</span></span></code></pre></div>
</div></div><aside class="col-md-4 chunk ps-2"></aside></div>
<div class="row g-0 my-3"><div class="col-md-8 px-4 chunk"><ul>
<li>You declare your code inside a class. Use a new name for each example, here we have used <code>MyStateMachine1</code> as name.</li>
<li>You <strong>extend</strong> the base state machine by declaring it in the parentheses behind your class name, in <code>class MyStateMachine1(StateMachine)</code>.</li>
<li>The two transition methods that you declare have the parameter <code>self</code>.</li>
</ul>
</div><aside class="col-md-4 chunk ps-2"></aside></div>
<div class="row g-0 my-3"><div class="col-md-8 px-4 chunk"><p>This has the following effect: Your state machine <em>MyStateMachine1</em> &quot;inherits&quot; all functionalities that the base state machine <em>StateMachine</em> has already implemented. We just <em>add</em> our transition methods, which is enough to make the state machine do what we want.</p>
</div><aside class="col-md-4 chunk ps-2"></aside></div>
<div class="row g-0 my-3"><div class="col-md-8 px-4 chunk"><h3>Running The Machine</h3>
<p>To run your state machine, you need then to declare a variable of it and call the <code>run()</code> function it inherited from the base state machine:</p>
</div><aside class="col-md-4 chunk ps-2"></aside></div>
<div class="row g-0 my-3"><div class="col-md-8 px-4 chunk"><div class="source-code-frame mt-3 mb-3">
<pre class="d-none" id="id238898">stm = MyStateMachine1()
stm.run()
</pre>
<button type="button" class="copy-button" data-clipboard-target="#id238898">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16">
  		<path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"></path>
  		<path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"></path>
	</svg>
</button>
<div class="sourceCode" id="cb1"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>stm <span class="op">=</span> MyStateMachine1()</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>stm.run()</span></code></pre></div>
</div></div><aside class="col-md-4 chunk ps-2"></aside></div>
<div class="row g-0 my-3"><div class="col-md-8 px-4 chunk"><h3>Variables</h3>
<p>This also explains how we handle variables: The variable is not a part of the global context, but tied to our state machine. We therefore always use the prefix <code>self.</code> before the variable.</p>
<p>In the listing below we initialize a variable <code>x</code> when we start the machine in the initial transition and assign a new value in the transition function. The prefix <code>self</code> refers to the parameter we get from both of these functions.</p>
</div><aside class="col-md-4 chunk ps-2"></aside></div>
<div class="row g-0 my-3"><div class="col-md-8 px-4 chunk"><div class="source-code-frame mt-3 mb-3">
<pre class="d-none" id="id6753e6">class MyStateMachine1(StateMachine):

    def initial_transition(self, timers):
        ### the initial transition
        ### init a variable x
        self.x = 0

    def transition(self, state, event, timers):
        ### the remaining transitions
        self.x = self.x + 1
</pre>
<button type="button" class="copy-button" data-clipboard-target="#id6753e6">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16">
  		<path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"></path>
  		<path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"></path>
	</svg>
</button>
<div class="sourceCode" id="cb1"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MyStateMachine1(StateMachine):</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> initial_transition(<span class="va">self</span>, timers):</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>        <span class="co">### the initial transition</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>        <span class="co">### init a variable x</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.x <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> transition(<span class="va">self</span>, state, event, timers):</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>        <span class="co">### the remaining transitions</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.x <span class="op">=</span> <span class="va">self</span>.x <span class="op">+</span> <span class="dv">1</span></span></code></pre></div>
</div></div><aside class="col-md-4 chunk ps-2"></aside></div>
</section>
  </main>



  <nav class="navbar navbar-expand-lg navbar-dark fixed-bottom" style="background-color: #555555">
    <div class="container-fluid">
      <div class="collapse navbar-collapse">
        <ul class="navbar-nav">
          <li class="nav-item">
            <a class="nav-link" href="https://www.ntnu.no/informasjonskapsler">Om informasjonskapsler</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="https://www.ntnu.no/personvern">Personvern</a>
          </li>
        </ul>
        <div class="bg-light ms-auto border-0"></div>
        <ul class="navbar-nav">
          <li class="nav-item">
            <a class="nav-link" data-bs-toggle="offcanvas" href="#offcanvasExample" role="button"
              aria-controls="offcanvasExample">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                class="bi bi-pencil-square" viewBox="0 0 16 16">
                <path
                  d="M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.646a.5.5 0 0 1 .707 0l1.293 1.293zm-1.75 2.456-2-2L4.939 9.21a.5.5 0 0 0-.121.196l-.805 2.414a.25.25 0 0 0 .316.316l2.414-.805a.5.5 0 0 0 .196-.12l6.813-6.814z" />
                <path fill-rule="evenodd"
                  d="M1 13.5A1.5 1.5 0 0 0 2.5 15h11a1.5 1.5 0 0 0 1.5-1.5v-6a.5.5 0 0 0-1 0v6a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5v-11a.5.5 0 0 1 .5-.5H9a.5.5 0 0 0 0-1H2.5A1.5 1.5 0 0 0 1 2.5v11z" />
              </svg>
            </a>
          </li>
        </ul>
      </div>
    </div>
  </nav>
  <div class="offcanvas offcanvas-end text-bg-dark" tabindex="-1" id="offcanvasExample"
    aria-labelledby="offcanvasExampleLabel">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title" id="offcanvasExampleLabel">Edit this page</h5>
    </div>
    <div class="offcanvas-body">
      <ul>
        <li>This site is hosted on <a href="https://github.com/falkr/ttm4175">Github</a></li>
        <li>The source is written in <a href="../supermark/index.html">Supermark</a> syntax</li>
        <li>To edit this page, make a commit to <a
            href="https://github.com/falkr/ttm4175/tree/master/pages/unit-p2/preparation-2.md">this file</a></li>
      </ul>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
    crossorigin="anonymous"></script>
  <script>
    anchors.add('h1').add('h2').add('h3');
    anchors.options.visible = 'always';
    var clipboard = new ClipboardJS('.copy-button');
  </script>
  <script>
</script>
</body>

</html>