<html lang="en-US"><head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1"/>

<title>TTM4175</title>
<meta property="og:title" content="TTM4175">
<meta property="og:locale" content="en_US">
<meta name="description" content="Introduction to Communication Technology and Digital Security">
<meta property="og:description" content="Introduction to Communication Technology and Digital Security">


<link rel="stylesheet" href="assets/bootstrap.min.css">
<script src="assets/jquery-3.5.1.min.js"></script>
<script src="assets/bootstrap.min.js"></script>
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.1/css/all.css" integrity="sha384-gfdkjb5BdAXd+lj+gudLWI+BXq4IuLW5IT+brZEZsLFm++aCMlF1V92rMkPaX4PP" crossorigin="anonymous">
<link rel="stylesheet" type="text/css" href="assets/style.css" />
<script src="assets/anchor.js"></script>
<script src="assets/script-aside.js"></script>
</head>
<body id="top">

<nav class="navbar navbar-expand-md navbar-dark " style="background-color:#666666"#2B65EC"> <!-- fixed-top -->
        <ul class="nav nav-pills">
        <li class="nav-item">
    <a class="nav-link" href="index.html" style="font-weight: bold")>TTM4175</a>
  </li>

  <li class="nav-item dropdown">
    <a class="nav-link dropdown-toggle" data-toggle="dropdown" href="#" role="button" aria-haspopup="true" aria-expanded="false">Teknostart</a>
    <div class="dropdown-menu">
      <a class="dropdown-item" href="day0-2020.html">Dag 0: Getting Started</a>
      <a class="dropdown-item" href="day1-2020.html">Dag 1: Virtual Box</a>
      <a class="dropdown-item" href="day2-2020.html">Dag 2: Linux Command Line</a>
      <a class="dropdown-item" href="day3-2020.html">Dag 3: SSH and HTML</a>
      <div class="dropdown-divider"></div>
      <a class="dropdown-item" href="tips.html">Tips</a>
    </div>
  </li>
        
  <li class="nav-item dropdown">
    <a class="nav-link dropdown-toggle" data-toggle="dropdown" href="#" role="button" aria-haspopup="true" aria-expanded="false">Preparation</a>
    <div class="dropdown-menu">
      <a class="dropdown-item disabled"><strong>Networking</strong></a>
      <a class="dropdown-item" href="prep-networking-1-2020.html">Binary and IP addresses</a>
      <a class="dropdown-item" href="prep-networking-2-2020.html">Layers and Docker</a>
      <a class="dropdown-item" href="prep-networking-3-2020.html">Webservers and DNS</a>
      <div class="dropdown-divider"></div>
      <a class="dropdown-item disabled"><strong>Security</strong></a>
      <a class="dropdown-item" href="prep-security-1-2020.html">Security 1: Cyber Security and Ethical Hacking </a>
      <a class="dropdown-item" href="prep-security-2-2020.html">Security 2: Authentication, Authorization, and Password Storage</a>
      <a class="dropdown-item" href="prep-security-3-2020.html">Security 3: Passwords and Cryptography</a>
      <a class="dropdown-item" href="prep-security-4-2020.html">Security 4: Security Vulnerabilities</a>
      <div class="dropdown-divider"></div>
      <a class="dropdown-item disabled"><strong>Internet of Things</strong></a>
      <a class="dropdown-item" href="prep-iot-intro.html">IoT 1: Introduction</a>
      <a class="dropdown-item" href="prep-iot-devices.html">IoT 1: Installation</a>
      <a class="dropdown-item" href="prep-iot-stm.html">IoT 2: State Machines</a>
      <a class="dropdown-item" href="prep-iot-stmpy.html">IoT 2: State Machines in Micro Python</a>
      <a class="dropdown-item" href="prep-iot-http-json.html">IoT 3: HTTP and JSON</a>
      <a class="dropdown-item" href="prep-iot-mqtt.html">IoT 4: MQTT</a>
      <!--
      <a class="dropdown-item" href="prep-iot-api.html">IoT 4: APIs</a>
      <a class="dropdown-item" href="prep-iot-nb-iot.html">NB-IoT (Extra)</a>-->
    </div>
  </li>
  
  <li class="nav-item dropdown">
    <a class="nav-link dropdown-toggle" data-toggle="dropdown" href="#" role="button" aria-haspopup="true" aria-expanded="false">Labs</a>
    <div class="dropdown-menu">
        <a class="dropdown-item disabled"><strong>Networking</strong></a>
        <a class="dropdown-item" href="networking-1-2020.html">Binary and IP addresses</a>
        <a class="dropdown-item" href="networking-2-2020.html">Layers and Docker</a>
        <a class="dropdown-item" href="networking-3-2020.html">Webservers and DNS</a>
        <div class="dropdown-divider"></div>
        <a class="dropdown-item disabled"><strong>Security</strong></a>
        <a class="dropdown-item" href="security-1-2020.html">Security 1</a>
        <a class="dropdown-item" href="security-2-2020.html">Security 2</a>
        <a class="dropdown-item" href="security-3-2020.html">Security 3</a>
        <a class="dropdown-item" href="security-4-2020.html">Security 4</a>
        <div class="dropdown-divider"></div>
        <a class="dropdown-item disabled"><strong>Internet of Things</strong></a>
        <a class="dropdown-item" href="iot-devices.html">IoT 1: Programming Devices</a>
        <a class="dropdown-item" href="iot-stm.html">IoT 2: State Machines</a>
        <a class="dropdown-item" href="iot-http-json-2020.html">IoT 3: HTTP and JSON</a>
        <a class="dropdown-item" href="iot-http-json-2020-solution.html">IoT 3: HTTP and JSON (Solution and Revised Tasks)</a>
        <a class="dropdown-item" href="iot-mqtt-chat.html">IoT 4: MQTT Chat</a>
        <!--
        <a class="dropdown-item" href="iot-lopy.html">LoPy</a>
        <a class="dropdown-item" href="iot-mqtt.html">MQTT</a>
        <a class="dropdown-item" href="iot-lorawan.html">LoRaWAN / NB-IoT</a>
        <a class="dropdown-item" href="iot-api.html">API</a>-->
      </div>
  </li>
  
  <li class="nav-item dropdown">
    <a class="nav-link dropdown-toggle" data-toggle="dropdown" href="#" role="button" aria-haspopup="true" aria-expanded="false">Extra</a>
    <div class="dropdown-menu">
      <a class="dropdown-item disabled"><strong>Learning</strong></a>
      <a class="dropdown-item" href="learning-rats.html">RATs</a>
      <a class="dropdown-item" href="feedback.html">Tilbakemelding</a>
      <a class="dropdown-item" href="reports.html">Rapporter</a>
      <a class="dropdown-item" href="teams.html">Teams</a>
      <a class="dropdown-item" href="working-in-teams.html">Working in Teams</a>
      <a class="dropdown-item" href="tools.html">Learning Tools</a>
      <div class="dropdown-divider"></div>
      <a class="dropdown-item disabled"><strong>Material</strong></a>
      <a class="dropdown-item" href="commands-help.html">Help on Commands</a>
      <a class="dropdown-item" href="commands.html">List of Commands</a>
      <a class="dropdown-item" href="computer-history.html">Extra Videos</a>
      <div class="dropdown-divider"></div>
      <a class="dropdown-item disabled"><strong>Tools</strong></a>
      <a class="dropdown-item" href="virtual-box-mac.html">Virtual Box for Mac</a>
      <a class="dropdown-item" href="virtual-box-win.html">Virtual Box for Windows</a>
      <a class="dropdown-item" href="shell-mac.html">Terminal and SSH on Mac</a>
      <a class="dropdown-item" href="shell-win.html">Terminal and SSH on Windows</a>
    </div>
  </li>
  
  <!--
  <li class="nav-item">
    <a class="nav-link" href="#">Blackboard</a>
  </li>-->
</ul>

<div class="navbar-nav flex-row ml-md-auto d-none d-md-flex"></div>
             <a class="navbar-brand" href="https://ntnu.edu">
      	<svg width="100" height="30">
      		<image xlink:href="https://innsida.ntnu.no/innsida-theme/images/ntnu-graphics/ntnu_logo_white.svg" 
      		src="https://innsida.ntnu.no/innsida-theme/images/ntnu-graphics/ntnu_logo_white.png" width="100%" height="100%"></image>
      	</svg>
      </a>
    </nav>


<div class="page">
    </section>
    <section class="content">
<h1 id="temperature-sensor-system">Temperature Sensor System</h1>

<p>In this (a little bit artificial) example, we want to create a temperature sensor that delivers its measurements tp a web server, so we can check the temperature from a web browser. In addition, the web site should also show the air temperature forecast for the location from Yr. This is what our system looks like:</p>

<div class="figure">
<img src="figures/http/smart-home.png" width="100%"/>
</div>
<p>It should work in the following steps:</p>
<ol type="1">
<li><p>The temperature sensor sends its measured temperature with a HTTP <code>POST</code> request to the server. In our example, we do this only once, but in a real system the sensor would measure the temperature from a real sensor and then periodically send the temperature.</p></li>
<li><p>A web browser makes an HTTP <code>GET</code> request to the server, because we want to read the temperature.</p></li>
<li><p>To answer the request from the browser, the web server makes itself a request to Yr.no to figure out the air temperature.</p></li>
<li><p>The web server then combines the temperature sent before from the sensor (via the <code>POST</code> request), combines it with the result of the request to Yr.no, and answer the browser with a HTML page that shows both temperatures.</p></li>
</ol>

    </section>
    <section class="content">
<h1 id="code-for-the-sensor">Code for the Sensor</h1>
<p>As said, our program for the sensor just imitates how a real sensor would work. Here we just write the temperature fixed, and only send a single update instead of doing it periodically.</p>
<p>Store the following file in a file <code>sensor.py</code>.</p>


<style type="text/css">
.fr1 #cb1-1, .fr1 #cb1-2, .fr1 #cb1-3 {
  background-color: lightblue;
}
.fr1 #cb1-6, .fr1 #cb1-7 {
  background-color: lightgreen;
}
.fr1 a {
  width: 100%;
  height: 18px;
  display: inline-block;
  text-decoration: none;
}
</style>
<div class="sourceCode fr1" id="cb1"><pre class="sourceCode python"><code class="sourceCode python">
<a class="sourceLine" id="cb1-1" title="1"><span class="im">import</span> requests</a>
<a class="sourceLine" id="cb1-2" title="2"><span class="im">import</span> json</a>
<a class="sourceLine" id="cb1-3" title="3"><span class="im">from</span> urllib.parse <span class="im">import</span> quote, unquote</a>
<a class="sourceLine" id="cb1-4" title="4"></a>
<a class="sourceLine" id="cb1-5" title="5"></a>
<a class="sourceLine" id="cb1-6" title="6"><span class="kw">def</span> dictionary_to_string(dictionary):</a>
<a class="sourceLine" id="cb1-7" title="7">    <span class="cf">return</span> json.dumps(dictionary)</a>
<a class="sourceLine" id="cb1-8" title="8"></a>
<a class="sourceLine" id="cb1-9" title="9"></a>
<a class="sourceLine" id="cb1-10" title="10"><span class="kw">def</span> encode_string_into_url(string):</a>
<a class="sourceLine" id="cb1-11" title="11">    <span class="cf">return</span> quote(string)</a>
<a class="sourceLine" id="cb1-12" title="12"></a>
<a class="sourceLine" id="cb1-13" title="13"></a>
<a class="sourceLine" id="cb1-14" title="14"><span class="kw">def</span> print_response(response):</a>
<a class="sourceLine" id="cb1-15" title="15">    <span class="bu">print</span>(<span class="st">&quot;-------- Response --------&quot;</span>)</a>
<a class="sourceLine" id="cb1-16" title="16">    <span class="bu">print</span>(<span class="st">&quot;Status code: </span><span class="sc">{}</span><span class="st">&quot;</span>.<span class="bu">format</span>(response.status_code))</a>
<a class="sourceLine" id="cb1-17" title="17">    <span class="bu">print</span>(<span class="st">&quot;-------- Content--------&quot;</span>)</a>
<a class="sourceLine" id="cb1-18" title="18">    <span class="bu">print</span>(response.text)</a>
<a class="sourceLine" id="cb1-19" title="19">    <span class="bu">print</span>(<span class="st">&quot;------------------------&quot;</span>)</a>
<a class="sourceLine" id="cb1-20" title="20"></a>
<a class="sourceLine" id="cb1-21" title="21"></a>
<a class="sourceLine" id="cb1-22" title="22"><span class="co"># example data</span></a>
<a class="sourceLine" id="cb1-23" title="23">dictionary <span class="op">=</span> {}</a>
<a class="sourceLine" id="cb1-24" title="24">dictionary[<span class="st">&quot;temperature&quot;</span>] <span class="op">=</span> <span class="fl">20.0</span></a>
<a class="sourceLine" id="cb1-25" title="25"></a>
<a class="sourceLine" id="cb1-26" title="26">data <span class="op">=</span> dictionary_to_string(dictionary)</a>
<a class="sourceLine" id="cb1-27" title="27"><span class="bu">print</span>(data)</a>
<a class="sourceLine" id="cb1-28" title="28"></a>
<a class="sourceLine" id="cb1-29" title="29">data <span class="op">=</span> encode_string_into_url(data)</a>
<a class="sourceLine" id="cb1-30" title="30"><span class="bu">print</span>(data)</a>
<a class="sourceLine" id="cb1-31" title="31"></a>
<a class="sourceLine" id="cb1-32" title="32">response <span class="op">=</span> requests.post(<span class="st">&quot;http://localhost:8023/?data=</span><span class="sc">{}</span><span class="st">&quot;</span>.<span class="bu">format</span>(data))</a>
<a class="sourceLine" id="cb1-33" title="33">print_response(response)</a></code></pre></div>


<ul class="list-group code-legend">
  <li class="list-group-item d-flex justify-content-between align-items-center">
    Importing the necessary Python modules. 
    <span class="badge badge-primary badge-pill" style="background-color: lightblue;">1-3</span>
  </li>
  <li class="list-group-item d-flex justify-content-between align-items-center">
    Dapibus ac facilisis in
    <span class="badge badge-primary badge-pill" style="background-color: lightgreen;">2</span>
  </li>
  <li class="list-group-item d-flex justify-content-between align-items-center">
    Morbi leo risus
    <span class="badge badge-primary badge-pill">14-15, 26-30</span>
  </li>
</ul>


<table>
  <tr><td>Lines 1-3</td><td> <div style="height: 1.5em; width:1.5em; background-color: lightblue"></div> </td><td>The import statements to get the right code imported.</td></tr>
  <tr><td>Lines 7,6</td><td> <div style="height: 1.5em; width:1.5em; background-color: lightgreen"></div> </td><td>The import statements to get the right code imported.</td></tr>
</table>
    </section>
    <section class="content">
<h1 id="code-for-the-server">Code for the Server</h1>
<p>The code for the server is longer, because it handles the <code>POST</code> request from the sensor, makes a <code>GET</code> request to Yr.no, and answers a <code>GET</code> request from a browser.</p>
<p>Stor it in a file called <code>webserver.py</code>.</p>

<div class="sourceCode" id="cb1"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb1-1" title="1"><span class="im">from</span> http.server <span class="im">import</span> HTTPServer, BaseHTTPRequestHandler</a>
<a class="sourceLine" id="cb1-2" title="2"><span class="im">from</span> urllib.parse <span class="im">import</span> quote, unquote</a>
<a class="sourceLine" id="cb1-3" title="3"><span class="im">import</span> json</a>
<a class="sourceLine" id="cb1-4" title="4"><span class="im">import</span> socket</a>
<a class="sourceLine" id="cb1-5" title="5"><span class="im">import</span> requests</a>
<a class="sourceLine" id="cb1-6" title="6"></a>
<a class="sourceLine" id="cb1-7" title="7"></a>
<a class="sourceLine" id="cb1-8" title="8"><span class="kw">def</span> extract_json_string(string):</a>
<a class="sourceLine" id="cb1-9" title="9">    start <span class="op">=</span> string.find(<span class="st">&quot;{&quot;</span>)</a>
<a class="sourceLine" id="cb1-10" title="10">    stop <span class="op">=</span> string.rfind(<span class="st">&quot;}&quot;</span>)</a>
<a class="sourceLine" id="cb1-11" title="11">    <span class="cf">return</span> string[start : stop <span class="op">+</span> <span class="dv">1</span>]</a>
<a class="sourceLine" id="cb1-12" title="12"></a>
<a class="sourceLine" id="cb1-13" title="13"></a>
<a class="sourceLine" id="cb1-14" title="14"><span class="kw">def</span> get_ip_address():</a>
<a class="sourceLine" id="cb1-15" title="15">    <span class="cf">return</span> socket.gethostbyname(socket.gethostname())</a>
<a class="sourceLine" id="cb1-16" title="16"></a>
<a class="sourceLine" id="cb1-17" title="17"></a>
<a class="sourceLine" id="cb1-18" title="18"><span class="kw">def</span> dictionary_to_string(dictionary):</a>
<a class="sourceLine" id="cb1-19" title="19">    <span class="cf">return</span> json.dumps(dictionary)</a>
<a class="sourceLine" id="cb1-20" title="20"></a>
<a class="sourceLine" id="cb1-21" title="21"></a>
<a class="sourceLine" id="cb1-22" title="22"><span class="kw">def</span> json_string_to_dictionary(json_string):</a>
<a class="sourceLine" id="cb1-23" title="23">    <span class="cf">return</span> json.loads(json_string)</a>
<a class="sourceLine" id="cb1-24" title="24"></a>
<a class="sourceLine" id="cb1-25" title="25"></a>
<a class="sourceLine" id="cb1-26" title="26"><span class="kw">def</span> encode_string_into_url(string):</a>
<a class="sourceLine" id="cb1-27" title="27">    <span class="cf">return</span> quote(string)</a>
<a class="sourceLine" id="cb1-28" title="28"></a>
<a class="sourceLine" id="cb1-29" title="29"></a>
<a class="sourceLine" id="cb1-30" title="30"><span class="kw">def</span> decode_url_back_to_string(url_encoded_string):</a>
<a class="sourceLine" id="cb1-31" title="31">    <span class="cf">return</span> unquote(url_encoded_string)</a>
<a class="sourceLine" id="cb1-32" title="32"></a>
<a class="sourceLine" id="cb1-33" title="33"></a>
<a class="sourceLine" id="cb1-34" title="34"><span class="kw">def</span> string_to_unicode_bytes(string):</a>
<a class="sourceLine" id="cb1-35" title="35">    <span class="cf">return</span> string.encode(<span class="st">&quot;utf-8&quot;</span>)</a>
<a class="sourceLine" id="cb1-36" title="36"></a>
<a class="sourceLine" id="cb1-37" title="37"></a>
<a class="sourceLine" id="cb1-38" title="38">places <span class="op">=</span> {</a>
<a class="sourceLine" id="cb1-39" title="39">    <span class="st">&quot;Trondheim&quot;</span>: {<span class="st">&quot;lat&quot;</span>: <span class="fl">63.43</span>, <span class="st">&quot;lon&quot;</span>: <span class="fl">10.39</span>},</a>
<a class="sourceLine" id="cb1-40" title="40">    <span class="st">&quot;Oslo&quot;</span>: {<span class="st">&quot;lat&quot;</span>: <span class="fl">59.91</span>, <span class="st">&quot;lon&quot;</span>: <span class="fl">10.75</span>},</a>
<a class="sourceLine" id="cb1-41" title="41">    <span class="st">&quot;Bergen&quot;</span>: {<span class="st">&quot;lat&quot;</span>: <span class="fl">60.39</span>, <span class="st">&quot;lon&quot;</span>: <span class="fl">5.32</span>},</a>
<a class="sourceLine" id="cb1-42" title="42">    <span class="st">&quot;Avaldsnes&quot;</span>: {<span class="st">&quot;lat&quot;</span>: <span class="fl">59.35</span>, <span class="st">&quot;lon&quot;</span>: <span class="fl">5.27</span>},</a>
<a class="sourceLine" id="cb1-43" title="43">    <span class="st">&quot;Tromsø&quot;</span>: {<span class="st">&quot;lat&quot;</span>: <span class="fl">69.64</span>, <span class="st">&quot;lon&quot;</span>: <span class="fl">18.95</span>},</a>
<a class="sourceLine" id="cb1-44" title="44">}</a>
<a class="sourceLine" id="cb1-45" title="45"></a>
<a class="sourceLine" id="cb1-46" title="46"></a>
<a class="sourceLine" id="cb1-47" title="47"><span class="kw">def</span> get_air_temp_2(place):</a>
<a class="sourceLine" id="cb1-48" title="48">    coordinates <span class="op">=</span> places[place]</a>
<a class="sourceLine" id="cb1-49" title="49">    url <span class="op">=</span> <span class="st">&quot;https://api.met.no/weatherapi/locationforecast/2.0/compact?lat=</span><span class="sc">{}</span><span class="st">&amp;lon=</span><span class="sc">{}</span><span class="st">&quot;</span>.<span class="bu">format</span>(</a>
<a class="sourceLine" id="cb1-50" title="50">        coordinates[<span class="st">&quot;lat&quot;</span>], coordinates[<span class="st">&quot;lon&quot;</span>]</a>
<a class="sourceLine" id="cb1-51" title="51">    )</a>
<a class="sourceLine" id="cb1-52" title="52">    response <span class="op">=</span> requests.get(url)</a>
<a class="sourceLine" id="cb1-53" title="53">    <span class="cf">return</span> response.json()[<span class="st">&quot;properties&quot;</span>][<span class="st">&quot;timeseries&quot;</span>][<span class="op">-</span><span class="dv">1</span>][<span class="st">&quot;data&quot;</span>][<span class="st">&quot;instant&quot;</span>][</a>
<a class="sourceLine" id="cb1-54" title="54">        <span class="st">&quot;details&quot;</span></a>
<a class="sourceLine" id="cb1-55" title="55">    ][<span class="st">&quot;air_temperature&quot;</span>]</a>
<a class="sourceLine" id="cb1-56" title="56"></a>
<a class="sourceLine" id="cb1-57" title="57"></a>
<a class="sourceLine" id="cb1-58" title="58"><span class="kw">def</span> generate_html_page(title, local_temperature, air_temperature, place):</a>
<a class="sourceLine" id="cb1-59" title="59">    lines <span class="op">=</span> []</a>
<a class="sourceLine" id="cb1-60" title="60">    lines.append(<span class="st">&quot;&lt;html&gt;&quot;</span>)</a>
<a class="sourceLine" id="cb1-61" title="61">    lines.append(<span class="st">&quot;    &lt;head&gt;&lt;title&gt;</span><span class="sc">{}</span><span class="st">&lt;/title&gt;&lt;/head&gt;&quot;</span>.<span class="bu">format</span>(title))</a>
<a class="sourceLine" id="cb1-62" title="62">    lines.append(<span class="st">&quot;    &lt;body&gt;&quot;</span>)</a>
<a class="sourceLine" id="cb1-63" title="63">    lines.append(</a>
<a class="sourceLine" id="cb1-64" title="64">        <span class="st">&quot;        &lt;p&gt;Local temperature </span><span class="sc">{}</span><span class="st">: &lt;b&gt;</span><span class="sc">{}</span><span class="st"> C&lt;/b&gt;&lt;/p&gt;&quot;</span>.<span class="bu">format</span>(</a>
<a class="sourceLine" id="cb1-65" title="65">            place, local_temperature</a>
<a class="sourceLine" id="cb1-66" title="66">        )</a>
<a class="sourceLine" id="cb1-67" title="67">    )</a>
<a class="sourceLine" id="cb1-68" title="68">    lines.append(<span class="st">&quot;        &lt;p&gt;Temperature: &lt;b&gt;</span><span class="sc">{}</span><span class="st"> C&lt;/b&gt;&lt;/p&gt;&quot;</span>.<span class="bu">format</span>(air_temperature))</a>
<a class="sourceLine" id="cb1-69" title="69">    lines.append(<span class="st">&quot;    &lt;/body&gt;&quot;</span>)</a>
<a class="sourceLine" id="cb1-70" title="70">    lines.append(<span class="st">&quot;&lt;/html&gt;&quot;</span>)</a>
<a class="sourceLine" id="cb1-71" title="71">    <span class="cf">return</span> <span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>.join(lines)</a>
<a class="sourceLine" id="cb1-72" title="72"></a>
<a class="sourceLine" id="cb1-73" title="73"></a>
<a class="sourceLine" id="cb1-74" title="74"><span class="kw">class</span> RequestHandler(BaseHTTPRequestHandler):</a>
<a class="sourceLine" id="cb1-75" title="75">    <span class="kw">def</span> store_data(<span class="va">self</span>, name, data):</a>
<a class="sourceLine" id="cb1-76" title="76">        <span class="cf">if</span> <span class="kw">not</span> <span class="bu">hasattr</span>(<span class="va">self</span>.server, <span class="st">&quot;data&quot;</span>):</a>
<a class="sourceLine" id="cb1-77" title="77">            <span class="va">self</span>.server.data <span class="op">=</span> {}</a>
<a class="sourceLine" id="cb1-78" title="78">        <span class="va">self</span>.server.data[name] <span class="op">=</span> data</a>
<a class="sourceLine" id="cb1-79" title="79"></a>
<a class="sourceLine" id="cb1-80" title="80">    <span class="kw">def</span> load_data(<span class="va">self</span>, name):</a>
<a class="sourceLine" id="cb1-81" title="81">        <span class="cf">if</span> <span class="bu">hasattr</span>(<span class="va">self</span>.server, <span class="st">&quot;data&quot;</span>):</a>
<a class="sourceLine" id="cb1-82" title="82">            <span class="cf">if</span> name <span class="kw">in</span> <span class="va">self</span>.server.data:</a>
<a class="sourceLine" id="cb1-83" title="83">                <span class="cf">return</span> <span class="va">self</span>.server.data[name]</a>
<a class="sourceLine" id="cb1-84" title="84">        <span class="cf">return</span> <span class="va">None</span></a>
<a class="sourceLine" id="cb1-85" title="85"></a>
<a class="sourceLine" id="cb1-86" title="86">    <span class="kw">def</span> do_POST(<span class="va">self</span>):</a>
<a class="sourceLine" id="cb1-87" title="87">        <span class="co">&quot;&quot;&quot;HTTP POST request as it comes from the sensor device application,</span></a>
<a class="sourceLine" id="cb1-88" title="88"><span class="co">        for instance to send the current temerature.&quot;&quot;&quot;</span></a>
<a class="sourceLine" id="cb1-89" title="89"></a>
<a class="sourceLine" id="cb1-90" title="90">        <span class="bu">print</span>(<span class="st">&quot;-------- Incoming POST request --------&quot;</span>)</a>
<a class="sourceLine" id="cb1-91" title="91">        <span class="bu">print</span>(<span class="st">&quot;  Request data: </span><span class="sc">{}</span><span class="st">&quot;</span>.<span class="bu">format</span>(<span class="va">self</span>.requestline))</a>
<a class="sourceLine" id="cb1-92" title="92"></a>
<a class="sourceLine" id="cb1-93" title="93">        decoded_request <span class="op">=</span> decode_url_back_to_string(<span class="va">self</span>.requestline)</a>
<a class="sourceLine" id="cb1-94" title="94">        <span class="bu">print</span>(<span class="st">&quot;  Decoded data: </span><span class="sc">{}</span><span class="st">&quot;</span>.<span class="bu">format</span>(decoded_request))</a>
<a class="sourceLine" id="cb1-95" title="95"></a>
<a class="sourceLine" id="cb1-96" title="96">        json_string <span class="op">=</span> extract_json_string(decoded_request)</a>
<a class="sourceLine" id="cb1-97" title="97">        <span class="bu">print</span>(<span class="st">&quot;  Extracted JSON string: </span><span class="sc">{}</span><span class="st">&quot;</span>.<span class="bu">format</span>(json_string))</a>
<a class="sourceLine" id="cb1-98" title="98"></a>
<a class="sourceLine" id="cb1-99" title="99">        dictionary <span class="op">=</span> json_string_to_dictionary(json_string)</a>
<a class="sourceLine" id="cb1-100" title="100">        <span class="bu">print</span>(dictionary)</a>
<a class="sourceLine" id="cb1-101" title="101"></a>
<a class="sourceLine" id="cb1-102" title="102">        <span class="co"># We extract the temperature...</span></a>
<a class="sourceLine" id="cb1-103" title="103">        temperature <span class="op">=</span> dictionary[<span class="st">&quot;temperature&quot;</span>]</a>
<a class="sourceLine" id="cb1-104" title="104">        <span class="co"># ...and store it</span></a>
<a class="sourceLine" id="cb1-105" title="105">        <span class="va">self</span>.store_data(<span class="st">&quot;temperature&quot;</span>, temperature)</a>
<a class="sourceLine" id="cb1-106" title="106"></a>
<a class="sourceLine" id="cb1-107" title="107">        <span class="co"># Phase 2: Which data do we want to send back?</span></a>
<a class="sourceLine" id="cb1-108" title="108">        response <span class="op">=</span> <span class="st">&quot;ok&quot;</span></a>
<a class="sourceLine" id="cb1-109" title="109"></a>
<a class="sourceLine" id="cb1-110" title="110">        <span class="co"># Phase 3: Let&#39;s send back the data!</span></a>
<a class="sourceLine" id="cb1-111" title="111">        response_in_bytes <span class="op">=</span> string_to_unicode_bytes(response)</a>
<a class="sourceLine" id="cb1-112" title="112">        <span class="va">self</span>.send_response(<span class="dv">200</span>)</a>
<a class="sourceLine" id="cb1-113" title="113">        <span class="va">self</span>.send_header(<span class="st">&quot;Content-type&quot;</span>, <span class="st">&quot;text/plain&quot;</span>)</a>
<a class="sourceLine" id="cb1-114" title="114">        <span class="va">self</span>.end_headers()</a>
<a class="sourceLine" id="cb1-115" title="115">        <span class="va">self</span>.wfile.write(response_in_bytes)</a>
<a class="sourceLine" id="cb1-116" title="116"></a>
<a class="sourceLine" id="cb1-117" title="117">    <span class="kw">def</span> do_GET(<span class="va">self</span>):</a>
<a class="sourceLine" id="cb1-118" title="118">        <span class="co"># Phase 1: What has been requested?</span></a>
<a class="sourceLine" id="cb1-119" title="119">        <span class="bu">print</span>(<span class="st">&quot;-------- Incoming GET request --------&quot;</span>)</a>
<a class="sourceLine" id="cb1-120" title="120">        <span class="bu">print</span>(<span class="st">&quot;  Request data: </span><span class="sc">{}</span><span class="st">&quot;</span>.<span class="bu">format</span>(<span class="va">self</span>.requestline))</a>
<a class="sourceLine" id="cb1-121" title="121"></a>
<a class="sourceLine" id="cb1-122" title="122">        decoded_request <span class="op">=</span> decode_url_back_to_string(<span class="va">self</span>.requestline)</a>
<a class="sourceLine" id="cb1-123" title="123">        <span class="bu">print</span>(<span class="st">&quot;  Decoded data: </span><span class="sc">{}</span><span class="st">&quot;</span>.<span class="bu">format</span>(decoded_request))</a>
<a class="sourceLine" id="cb1-124" title="124"></a>
<a class="sourceLine" id="cb1-125" title="125">        json_string <span class="op">=</span> extract_json_string(decoded_request)</a>
<a class="sourceLine" id="cb1-126" title="126">        <span class="bu">print</span>(<span class="st">&quot;  Extracted JSON string: </span><span class="sc">{}</span><span class="st">&quot;</span>.<span class="bu">format</span>(json_string))</a>
<a class="sourceLine" id="cb1-127" title="127"></a>
<a class="sourceLine" id="cb1-128" title="128">        dictionary <span class="op">=</span> json_string_to_dictionary(json_string)</a>
<a class="sourceLine" id="cb1-129" title="129">        <span class="bu">print</span>(dictionary)</a>
<a class="sourceLine" id="cb1-130" title="130"></a>
<a class="sourceLine" id="cb1-131" title="131">        place <span class="op">=</span> dictionary[<span class="st">&quot;place&quot;</span>]</a>
<a class="sourceLine" id="cb1-132" title="132"></a>
<a class="sourceLine" id="cb1-133" title="133">        air_temperature <span class="op">=</span> get_air_temp_2(place)</a>
<a class="sourceLine" id="cb1-134" title="134">        local_temperature <span class="op">=</span> <span class="va">self</span>.load_data(<span class="st">&quot;temperature&quot;</span>)</a>
<a class="sourceLine" id="cb1-135" title="135"></a>
<a class="sourceLine" id="cb1-136" title="136">        <span class="co"># Phase 2: Which data do we want to send back?</span></a>
<a class="sourceLine" id="cb1-137" title="137">        response <span class="op">=</span> generate_html_page(</a>
<a class="sourceLine" id="cb1-138" title="138">            <span class="st">&quot;Temperature&quot;</span>, local_temperature, air_temperature, place</a>
<a class="sourceLine" id="cb1-139" title="139">        )</a>
<a class="sourceLine" id="cb1-140" title="140"></a>
<a class="sourceLine" id="cb1-141" title="141">        <span class="co"># Phase 3: Let&#39;s send back the data!</span></a>
<a class="sourceLine" id="cb1-142" title="142">        response_in_bytes <span class="op">=</span> string_to_unicode_bytes(response)</a>
<a class="sourceLine" id="cb1-143" title="143">        <span class="va">self</span>.send_response(<span class="dv">200</span>)</a>
<a class="sourceLine" id="cb1-144" title="144">        <span class="va">self</span>.send_header(<span class="st">&quot;Content-type&quot;</span>, <span class="st">&quot;text/html&quot;</span>)</a>
<a class="sourceLine" id="cb1-145" title="145">        <span class="va">self</span>.end_headers()</a>
<a class="sourceLine" id="cb1-146" title="146">        <span class="va">self</span>.wfile.write(response_in_bytes)</a>
<a class="sourceLine" id="cb1-147" title="147"></a>
<a class="sourceLine" id="cb1-148" title="148"></a>
<a class="sourceLine" id="cb1-149" title="149"><span class="co"># This just starts the server</span></a>
<a class="sourceLine" id="cb1-150" title="150">port <span class="op">=</span> <span class="dv">8023</span></a>
<a class="sourceLine" id="cb1-151" title="151">httpd <span class="op">=</span> HTTPServer(</a>
<a class="sourceLine" id="cb1-152" title="152">    (<span class="st">&quot;&quot;</span>, port),</a>
<a class="sourceLine" id="cb1-153" title="153">    RequestHandler,</a>
<a class="sourceLine" id="cb1-154" title="154">)</a>
<a class="sourceLine" id="cb1-155" title="155"><span class="bu">print</span>(<span class="st">&quot;&quot;</span>)</a>
<a class="sourceLine" id="cb1-156" title="156"><span class="bu">print</span>(<span class="st">&quot; ******** TTM4175 Web Server  ******** &quot;</span>)</a>
<a class="sourceLine" id="cb1-157" title="157"><span class="bu">print</span>(</a>
<a class="sourceLine" id="cb1-158" title="158">    <span class="st">&quot;    The server will be reachable via  http://</span><span class="sc">{}</span><span class="st">:</span><span class="sc">{}</span><span class="st">/&quot;</span>.<span class="bu">format</span>(get_ip_address(), port)</a>
<a class="sourceLine" id="cb1-159" title="159">)</a>
<a class="sourceLine" id="cb1-160" title="160"><span class="bu">print</span>(<span class="st">&quot;    Terminate the server via Ctrl-C.&quot;</span>)</a>
<a class="sourceLine" id="cb1-161" title="161"><span class="bu">print</span>(<span class="st">&quot; ************************************* &quot;</span>)</a>
<a class="sourceLine" id="cb1-162" title="162"><span class="bu">print</span>(<span class="st">&quot;&quot;</span>)</a>
<a class="sourceLine" id="cb1-163" title="163">httpd.serve_forever()</a></code></pre></div>

<div class="task"><p>Go through the code of the server, and try to understand what each function achieves. It is maybe not necessary to understand all details, but the coarse task of each line and function.</p>
</div>
    </section>
    <section class="content">
<h1 id="running-it">Running it</h1>

<p><strong>Step 1: Start the Server</strong></p>
<p>In a terminal window, start the server:</p>

<div class="sourceCode" id="cb1"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb1-1" title="1"><span class="ex">python3</span> webserver.py</a></code></pre></div>

<p><strong>Step 2: Start the Sensor</strong></p>
<p>In another terminal window, start the sensor:</p>

<div class="sourceCode" id="cb1"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb1-1" title="1"><span class="ex">python3</span> sensor.py</a></code></pre></div>

<p>Observe what happens in the terminal of the server.</p>

<p><strong>Step 3: Request from the Browser</strong></p>
<p>In a web browser, make the following request in the address field:</p>

<pre><code>http://localhost:8023/?data={&quot;place&quot;: &quot;Trondheim&quot;}</code></pre>

    </section>
    <section class="content">
<h1 id="tasks">Tasks</h1>

<div class="task"><p>Run the system as explained above, and document what happens in the terminal and the browser. Show screenshots. Does all work as expected?</p>
</div>
<p>(The code above should be complete, no changes are necessary.)</p>

<div class="task"><p>Can you get the air temperature for any of the other cities? How?</p>
</div>
<div class="task"><p>Observe how the address line in the browser changes after you press Enter and request the page. What happens here probably? How does the server take care of this?</p>
</div>
<div class="task"><p>Look at the functions <code>do_POST()</code> and <code>do_GET()</code> in the server. What do they have in common, and what is different?</p>
</div>
    </section>
</div>


<footer></footer>
<script>
    anchors.add('h1').add('h2').add('h3');
    anchors.options.visible = 'always';
</script>
</body>
</html>
