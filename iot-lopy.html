<html lang="en-US"><head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1"/>

<title>TTM4175</title>
<meta property="og:title" content="TTM4115">
<meta property="og:locale" content="en_US">
<meta name="description" content="Design of Communicating Systems">
<meta property="og:description" content="Design of Communicating Systems">


<!--<link rel="stylesheet" type="text/css" href="style.css" />-->
<link href="https://fonts.googleapis.com/css?family=Merriweather:400,400italic,700,700italic|Source+Code+Pro|Source+Sans+Pro:200,300,400,600,400italic,600italic|Rock+Salt" rel="stylesheet" type="text/css">


<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>


<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.1/css/all.css" integrity="sha384-gfdkjb5BdAXd+lj+gudLWI+BXq4IuLW5IT+brZEZsLFm++aCMlF1V92rMkPaX4PP" crossorigin="anonymous">

<link rel="stylesheet" type="text/css" href="assets/style.css" />

<!--<script src="jquery-1.10.1.min.js"></script>-->
<script src="assets/script-aside.js"></script>
</head>
<body id="top">

<nav class="navbar navbar-expand-md navbar-dark " style="background-color:#666666"#2B65EC"> <!-- fixed-top -->
        <ul class="nav nav-pills">
        <li class="nav-item">
    <a class="nav-link" href="index.html" style="font-weight: bold")>TTM4175</a>
  </li>

  <li class="nav-item dropdown">
    <a class="nav-link dropdown-toggle" data-toggle="dropdown" href="#" role="button" aria-haspopup="true" aria-expanded="false">Teknostart</a>
    <div class="dropdown-menu">
      <a class="dropdown-item" href="material/2019-08-15-ikt-intro.pdf">IKT Introduksjon (PDF)</a>
      <div class="dropdown-divider"></div>
      <a class="dropdown-item" href="day1.html">Dag 1: Raspberry Pi</a>
      <a class="dropdown-item" href="day2.html">Dag 2: Linux</a>
      <a class="dropdown-item" href="day3.html">Dag 3: IP, SSH og HTML</a>
      <a class="dropdown-item" href="day4.html">Dag 4: Webserver</a>
      <a class="dropdown-item" href="day5.html">Dag 5: Recap</a>
    </div>
  </li>
        
  <li class="nav-item dropdown">
    <a class="nav-link dropdown-toggle" data-toggle="dropdown" href="#" role="button" aria-haspopup="true" aria-expanded="false">Preparation</a>
    <div class="dropdown-menu">
      <a class="dropdown-item disabled"><strong>Networking</strong></a>
      <a class="dropdown-item" href="prep-networking-1.html">IPs, Subnets and Routing</a>
      <a class="dropdown-item" href="prep-networking-2.html">DNS and DHCP</a>
      <a class="dropdown-item" href="prep-networking-3.html">NAT and Wi-Fi</a>
      <div class="dropdown-divider"></div>
      <a class="dropdown-item disabled"><strong>Security</strong></a>
      <a class="dropdown-item" href="prep-security-1.html">Security 1: Cyber Security and Ethical Hacking </a>
      <a class="dropdown-item" href="prep-security-2.html">Security 2: Authentication, Authorization, and Password Storage</a>
      <a class="dropdown-item" href="prep-security-3.html">Security 3: Passwords and Cryptography</a>
      <a class="dropdown-item" href="prep-security-4.html">Security 4: Security Vulnerabilities</a>
      <div class="dropdown-divider"></div>
      <a class="dropdown-item disabled"><strong>Internet of Things</strong></a>
      <a class="dropdown-item" href="prep-iot-intro.html">IoT 1: Introduction</a>
      <a class="dropdown-item" href="prep-iot-http-json.html">IoT 2: HTTP and JSON</a>
      <a class="dropdown-item" href="prep-iot-mqtt.html">IoT 3: MQTT</a>
      <a class="dropdown-item" href="prep-iot-api.html">IoT 4: APIs</a>
      <a class="dropdown-item" href="prep-iot-nb-iot.html">NB-IoT (Extra)</a>
    </div>
  </li>
  
  <li class="nav-item dropdown">
    <a class="nav-link dropdown-toggle" data-toggle="dropdown" href="#" role="button" aria-haspopup="true" aria-expanded="false">Activities</a>
    <div class="dropdown-menu">
        <a class="dropdown-item disabled"><strong>Networking</strong></a>
        <a class="dropdown-item" href="networking-1.html">IPs, Subnets and Routing</a>
        <a class="dropdown-item" href="networking-2.html">DNS and DHCP</a>
        <a class="dropdown-item" href="networking-3.html">NAT and Wi-Fi
        <div class="dropdown-divider"></div>
        <a class="dropdown-item disabled"><strong>Security</strong></a>
        <a class="dropdown-item" href="security-1.html">Security 1</a>
        <a class="dropdown-item" href="security-2.html">Security 2</a>
        <a class="dropdown-item" href="security-3.html">Security 3</a>
        <a class="dropdown-item" href="security-4.html">Security 4</a>
        <div class="dropdown-divider"></div>
        <a class="dropdown-item disabled"><strong>Internet of Things</strong></a>
        <a class="dropdown-item" href="iot-http-json.html">HTTP and JSON</a>
        <a class="dropdown-item" href="iot-lorawan.html">LoRaWAN / NB-IoT</a>
        <a class="dropdown-item" href="iot-mqtt.html">MQTT</a>
        <a class="dropdown-item" href="iot-api.html">API</a>
      </div>
  </li>
  
  <li class="nav-item dropdown">
    <a class="nav-link dropdown-toggle" data-toggle="dropdown" href="#" role="button" aria-haspopup="true" aria-expanded="false">Material</a>
    <div class="dropdown-menu">
      <a class="dropdown-item" href="commands-help.html">Help on Commands</a>
      <a class="dropdown-item" href="commands.html">List of Commands</a>
      <a class="dropdown-item" href="computer-history.html">Extra Videos</a>
      <a class="dropdown-item" href="virtual-machine.html">Virtual Machine</a>
    </div>
  </li>
  
  <li class="nav-item dropdown">
    <a class="nav-link dropdown-toggle" data-toggle="dropdown" href="#" role="button" aria-haspopup="true" aria-expanded="false">Learning</a>
    <div class="dropdown-menu">
      <a class="dropdown-item" href="feedback.html">Tilbakemelding</a>
      <a class="dropdown-item" href="reports.html">Rapporter</a>
      <a class="dropdown-item" href="working-in-teams.html">Working in Teams</a>
      <a class="dropdown-item" href="smash.html">Finding the Smash Lab</a>
    </div>
  </li>
  
  <!--
  <li class="nav-item">
    <a class="nav-link" href="#">Blackboard</a>
  </li>-->
</ul>

<div class="navbar-nav flex-row ml-md-auto d-none d-md-flex"></div>
             <a class="navbar-brand" href="https://ntnu.edu">
      	<svg width="100" height="30">
      		<image xlink:href="https://innsida.ntnu.no/innsida-theme/images/ntnu-graphics/ntnu_logo_white.svg" 
      		src="https://innsida.ntnu.no/innsida-theme/images/ntnu-graphics/ntnu_logo_white.png" width="100%" height="100%"></image>
      	</svg>
      </a>
    </nav>


<div class="page">
    </section>
    <section class="content">
<h1 id="getting-started-with-the-lopy">Getting Started with the LoPy</h1>

    </section>
    <section class="content">
<h1 id="building-the-lopy">Building the LoPy</h1>
<p>The LoPy consists of several parts:</p>
<ul>
<li>The main board with the processor and the radio</li>
<li>The expansion board, with LED, button and access to pins, USB, and power supply</li>
<li>The antenna</li>
</ul>
<p>We have version 2.1A of the expansion board and version <code>XX</code>of the LoPy.</p>
<p>Put together the parts carefully as shown in the picture below. Note that the LoPy fits both ways onto the expansion boards. Make sure the pins for <code>Vin</code> and <code>GND</code> align properly. With the version we have, this looks like this:</p>

<div class="figure">
<img src="figures/iot/lopy-expansion-2.png" width="100%"/>
</div>
<p>Make sure you connect the antenna to the right antenna, close to the big white LED as shown above. We connect the antenna already now since using the radio without the antenna attached may damage the LoPy.</p>

<div class="figure">
<img src="figures/iot/lopy-antenna.png" width="100%"/>
</div>
<div class="figure">
<img src="figures/iot/lopy-antenna-2.png" width="100%"/>
</div>
<h2 id="important-warning">Important Warning:</h2>
<p>Don’t shortcut the LoPy by putting it on a metallic surface, like a MacBook. That’ll kill it.</p>

<div class="figure">
<img src="http://recipes.item.ntnu.no/wp-content/uploads/2017/11/lopy-vs-macbook-300x142.jpg" width="100%"/>
</div>
<p>Also, don’t activate the LoRaWan radio without the antenna connected.</p>

    </section>
    <section class="content">
<h1 id="updating-the-firmware">Updating the Firmware</h1>
<p><strong>Goal:</strong> You can connect the LoPy to your computer and have the latest firmware for the LoPy installed.</p>
<p>We now need to update the firmware on the LoPy, that is, the software that is installed on it.</p>

<span name="817cc6"></span><aside name="817cc6"><p><em>Firmware</em> is software that takes care of hardware-related issues. It is hence somewhere between the hardware and the actual software, which is the application that we are going to write. Hence the name.</p>
</aside>
<h2 id="update-tool">Update Tool</h2>
<p>Install the update tool, either for <a href="https://software.pycom.io/findupgrade?product=pycom-firmware-updater&amp;type=all&amp;platform=win32&amp;redirect=true">Windows</a> or <a href="https://software.pycom.io/findupgrade?product=pycom-firmware-updater&amp;type=all&amp;platform=macos&amp;redirect=true">Mac</a>.</p>
<h2 id="for-expansion-board-2.0">For Expansion Board 2.0</h2>
<p>(This is the board we have.)</p>
<ol type="1">
<li>Make sure the LoPy is <strong>not</strong> connected to your computer yet.</li>
<li>Connect a jumper cable between <code>G23</code> and <code>GND</code></li>
<li>Reconnect the LoPy via USB to your computer, this puts the device in <em>firmware update mode</em>.</li>
<li>Run the Firmware Upgrade tool</li>
</ol>

<div class="figure">
<img src="figures/iot/lopy-update.png" width="100%"/>
</div>
<ol start="5" type="1">
<li>Unplug the LoPy</li>
<li>Remove the <code>G23</code> to <code>GND</code> jumper cable.</li>
<li>Reboot the device (button or power off then on).</li>
</ol>

<div class="tip"><p>If you are having any issues, make sure the TX and RX jumpers are present on your Expansion Board, as the jumpers sometimes come loose in the box during transport. Without these jumpers, the updater will fail.</p>
</div>
<div class="tip"><p>If you succeeded updating the firmware, offer your help to other teams if they struggle, and offer to update their LoPy. (It is not important from which computer the LoPy gets updated.)</p>
</div>
    </section>
    <section class="content">
<h1 id="programming-the-lopy">Programming the LoPy</h1>
<p><strong>Goal:</strong> You can run Python code on the LoPy.</p>
<p>You can program the LoPy with a plugin that is called <strong>Pymakr</strong>, which you can use either with the editors Atom or Visual Studio Code.</p>
<h2 id="installing-the-pymakr-plugin">Installing the Pymakr Plugin</h2>
<ol type="1">
<li>Decide if you want to install <a href="https://atom.io">Atom</a> or <a href="https://code.visualstudio.com">Visiual Studio Code</a>. (Both share the same code base, and for our lab, both work.)</li>
<li>Follow the instructions for installing the Pymakr plugin, depending on the ide either <a href="https://docs.pycom.io/pymakr/installation/atom/">Pymakr for Atom</a> or <a href="https://docs.pycom.io/pymakr/installation/vscode/">Pymakr for Visual Studio Code</a>
<ul>
<li>Only connect via USB and ignore the Telnet instructions.</li>
</ul></li>
</ol>

<h2 id="create-a-new-project">Create a New Project</h2>
<ul>
<li>Create a new folder</li>
<li>Open this folder as a new project.</li>
<li>Create a new file <code>main.py</code>, and copy in the following code:</li>
</ul>

<div class="sourceCode" id="cb1"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb1-1" data-line-number="1">import pycom</a>
<a class="sourceLine" id="cb1-2" data-line-number="2">import time</a>
<a class="sourceLine" id="cb1-3" data-line-number="3"></a>
<a class="sourceLine" id="cb1-4" data-line-number="4">pycom.heartbeat(<span class="va">False</span>)</a>
<a class="sourceLine" id="cb1-5" data-line-number="5"></a>
<a class="sourceLine" id="cb1-6" data-line-number="6">while True:</a>
<a class="sourceLine" id="cb1-7" data-line-number="7">    pycom.rgbled(<span class="bn">0xFF0000</span>)  <span class="co"># Red</span></a>
<a class="sourceLine" id="cb1-8" data-line-number="8">    time.sleep(<span class="dv">1</span>)</a>
<a class="sourceLine" id="cb1-9" data-line-number="9">    pycom.rgbled(<span class="bn">0x00FF00</span>)  <span class="co"># Green</span></a>
<a class="sourceLine" id="cb1-10" data-line-number="10">    time.sleep(<span class="dv">1</span>)</a>
<a class="sourceLine" id="cb1-11" data-line-number="11">    pycom.rgbled(<span class="bn">0x0000FF</span>)  <span class="co"># Blue</span></a>
<a class="sourceLine" id="cb1-12" data-line-number="12">    time.sleep(<span class="dv">1</span>)</a></code></pre></div>

<ul>
<li>Go through the code line-by-line</li>
<li>Explain to each other what the code does. (By now, your Python skills form the other course should be enough to understand what is going on here.)</li>
<li>Find the <code>Run</code> command in the editor, and run the main file on the LoPy.</li>
</ul>

<div class="figure">
<img src="figures/iot/lopy-run.png" width="100%"/>
</div>
<p>Now you should see the LED of the LoPy changing its colors.</p>
<p>Feel free to modify your program. Can you produce more exciting colors?</p>

    </section>
    <section class="content">
<h1 id="connecting-to-lora">Connecting to LoRa</h1>
<p><strong>Goal:</strong> You connect you LoPy to the LoRaWAN network.</p>
<h2 id="get-the-mac-address">Get the MAC Address</h2>
<p>The LoRa module has a MAC address, which we will use as the device ID when connecting to the LoRaWAN network. To find the MAC address, create a new project in the editor and run the following program:</p>

<pre><code>from network import LoRa
import binascii
lora = LoRa(mode=LoRa.LORAWAN)
print(binascii.hexlify(lora.mac()).upper().decode(&#39;utf-8&#39;))</code></pre>

<h2 id="get-the-app-eui-and-app-key">Get the App EUI and App Key</h2>
<ul>
<li>Go to MS Teams / TTM4175 / Files / LoPy Device IDs</li>
<li>Write in your MAC address.</li>
<li>Wait for the App EUI and the App Key to appear. (We are registering the device)</li>
</ul>

<h2 id="connecting-to-lorawan">Connecting to LoRaWAN</h2>
<ul>
<li>Create a new project</li>
<li>Create a main.py file with the content below</li>
<li>Exchange the variables with <code>app_eui</code> and <code>app_key</code> with the correct values for you</li>
<li>Run the program</li>
<li>If you connect successfully, mark it with <code>ok</code> in the last column of the table on Teams</li>
</ul>

<div class="sourceCode" id="cb1"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="im">from</span> network <span class="im">import</span> LoRa</a>
<a class="sourceLine" id="cb1-2" data-line-number="2"><span class="im">import</span> socket</a>
<a class="sourceLine" id="cb1-3" data-line-number="3"><span class="im">import</span> time</a>
<a class="sourceLine" id="cb1-4" data-line-number="4"><span class="im">import</span> ubinascii</a>
<a class="sourceLine" id="cb1-5" data-line-number="5"></a>
<a class="sourceLine" id="cb1-6" data-line-number="6"><span class="co"># Initialise LoRa in LORAWAN mode.</span></a>
<a class="sourceLine" id="cb1-7" data-line-number="7"><span class="co"># Europe = LoRa.EU868</span></a>
<a class="sourceLine" id="cb1-8" data-line-number="8">lora <span class="op">=</span> LoRa(mode<span class="op">=</span>LoRa.LORAWAN, region<span class="op">=</span>LoRa.EU868)</a>
<a class="sourceLine" id="cb1-9" data-line-number="9"></a>
<a class="sourceLine" id="cb1-10" data-line-number="10"><span class="co"># create an OTAA authentication parameters</span></a>
<a class="sourceLine" id="cb1-11" data-line-number="11">app_eui <span class="op">=</span> ubinascii.unhexlify(<span class="st">&#39;70B3D57ED00XXXXXXX&#39;</span>)</a>
<a class="sourceLine" id="cb1-12" data-line-number="12">app_key <span class="op">=</span> ubinascii.unhexlify(<span class="st">&#39;D822576F285B93AC10F87B4FXXXXXXXX&#39;</span>)</a>
<a class="sourceLine" id="cb1-13" data-line-number="13"></a>
<a class="sourceLine" id="cb1-14" data-line-number="14"><span class="co"># join a network using OTAA (Over the Air Activation)</span></a>
<a class="sourceLine" id="cb1-15" data-line-number="15">lora.join(activation<span class="op">=</span>LoRa.OTAA, auth<span class="op">=</span>(app_eui, app_key), timeout<span class="op">=</span><span class="dv">0</span>)</a>
<a class="sourceLine" id="cb1-16" data-line-number="16"></a>
<a class="sourceLine" id="cb1-17" data-line-number="17"><span class="co"># wait until the module has joined the network</span></a>
<a class="sourceLine" id="cb1-18" data-line-number="18"><span class="cf">while</span> <span class="kw">not</span> lora.has_joined():</a>
<a class="sourceLine" id="cb1-19" data-line-number="19">    time.sleep(<span class="fl">2.5</span>)</a>
<a class="sourceLine" id="cb1-20" data-line-number="20">    <span class="bu">print</span>(<span class="st">&#39;Not yet joined...&#39;</span>)</a>
<a class="sourceLine" id="cb1-21" data-line-number="21"></a>
<a class="sourceLine" id="cb1-22" data-line-number="22"><span class="co"># create a LoRa socket</span></a>
<a class="sourceLine" id="cb1-23" data-line-number="23">s <span class="op">=</span> socket.socket(socket.AF_LORA, socket.SOCK_RAW)</a>
<a class="sourceLine" id="cb1-24" data-line-number="24"></a>
<a class="sourceLine" id="cb1-25" data-line-number="25"><span class="co"># set the LoRaWAN data rate</span></a>
<a class="sourceLine" id="cb1-26" data-line-number="26">s.setsockopt(socket.SOL_LORA, socket.SO_DR, <span class="dv">5</span>)</a>
<a class="sourceLine" id="cb1-27" data-line-number="27"></a>
<a class="sourceLine" id="cb1-28" data-line-number="28"><span class="co"># make the socket blocking</span></a>
<a class="sourceLine" id="cb1-29" data-line-number="29"><span class="co"># (waits for the data to be sent and for the 2 receive windows to expire)</span></a>
<a class="sourceLine" id="cb1-30" data-line-number="30">s.setblocking(<span class="va">True</span>)</a>
<a class="sourceLine" id="cb1-31" data-line-number="31"></a>
<a class="sourceLine" id="cb1-32" data-line-number="32"><span class="co"># send some data</span></a>
<a class="sourceLine" id="cb1-33" data-line-number="33">s.send(<span class="bu">bytes</span>([<span class="bn">0x01</span>, <span class="bn">0x02</span>, <span class="bn">0x03</span>]))</a>
<a class="sourceLine" id="cb1-34" data-line-number="34"></a>
<a class="sourceLine" id="cb1-35" data-line-number="35"><span class="co"># make the socket non-blocking</span></a>
<a class="sourceLine" id="cb1-36" data-line-number="36"><span class="co"># (because if there&#39;s no data received it will block forever...)</span></a>
<a class="sourceLine" id="cb1-37" data-line-number="37">s.setblocking(<span class="va">False</span>)</a>
<a class="sourceLine" id="cb1-38" data-line-number="38"></a>
<a class="sourceLine" id="cb1-39" data-line-number="39"></a>
<a class="sourceLine" id="cb1-40" data-line-number="40"></a>
<a class="sourceLine" id="cb1-41" data-line-number="41"><span class="co"># get any data received (if any...)</span></a>
<a class="sourceLine" id="cb1-42" data-line-number="42">data <span class="op">=</span> s.recv(<span class="dv">64</span>)</a>
<a class="sourceLine" id="cb1-43" data-line-number="43"><span class="bu">print</span>(data)</a></code></pre></div>

    </section>
</div>


<footer></footer>
</body>
</html>
